---
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/027_client_program_update_policy.sql
autonomous: true
---

# Plan 02-01: RLS Policy Audit and Client UPDATE Policy

## Objective
Audit existing RLS policies and add client UPDATE policy for self-service plan management to support Phase 5 (Client Portal Self-Service Plan Editor).

## Prerequisites
- Existing RLS infrastructure from `018_rls_policies.sql` (811 lines)
- 32 tables with RLS enabled
- Helper functions: `get_user_organization_id()`, `get_user_role()`, `is_admin_or_manager()`, `get_user_client_id()`

## Files Created/Modified

### Created
- `supabase/migrations/027_client_program_update_policy.sql` - New migration adding client UPDATE policy for programs table

## Implementation Tasks

### Task 1: RLS Policy Audit
- Reviewed all existing RLS policies in `018_rls_policies.sql`
- Documented 32 tables with RLS enabled
- Verified client SELECT policies working correctly for: clients, properties, programs, work_orders, inspections, invoices, equipment, calendar_events

### Task 2: Gap Analysis
- Identified missing UPDATE policy for clients on programs table
- Clients need to update their own programs for self-service plan editor feature

### Task 3: Create Client UPDATE Policy Migration
Created `027_client_program_update_policy.sql` with:

```sql
CREATE POLICY "Clients can update their programs"
  ON programs FOR UPDATE
  USING (client_id = get_user_client_id())
  WITH CHECK (
    client_id = get_user_client_id() AND
    -- Ownership fields are immutable
    client_id = (SELECT client_id FROM programs WHERE id = programs.id) AND
    property_id = (SELECT property_id FROM programs WHERE id = programs.id) AND
    organization_id = (SELECT organization_id FROM programs WHERE id = programs.id)
  );
```

Also added policies for clients to view/insert program_history for change tracking.

## Verification
- Migration file syntax validated
- Policy uses existing `get_user_client_id()` helper function
- WITH CHECK clause prevents ownership field modification

## Security Notes
- Clients can only update programs they own (client_id match)
- Ownership fields (client_id, property_id, organization_id) are immutable
- WITH CHECK clause prevents changing ownership during update

## must_haves
- Client UPDATE policy exists on programs table
- Ownership fields (client_id, property_id, organization_id) are immutable during UPDATE
- Policy uses existing get_user_client_id() helper function
- Migration file deployable to Supabase
