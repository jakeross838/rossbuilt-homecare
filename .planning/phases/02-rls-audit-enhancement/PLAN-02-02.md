---
wave: 2
depends_on:
  - 02-01
files_modified:
  - apps/admin/e2e/rls-security.spec.ts
autonomous: true
---

# Plan 02-02: Cross-Tenant Security Test Suite

## Objective
Create automated security tests verifying cross-tenant data isolation and the new client UPDATE policy from Plan 02-01.

## Prerequisites
- Plan 02-01 complete (client UPDATE policy deployed)
- Playwright test infrastructure in apps/admin
- Two test client accounts configured:
  - `client-a-test@example.com` with password `testpassword123`
  - `client-b-test@example.com` with password `testpassword123`
  - Each linked to a client record with properties and programs

## Files Created/Modified

### Created
- `apps/admin/e2e/rls-security.spec.ts` - Comprehensive RLS security test suite

## Implementation Tasks

### Task 1: Cross-Tenant Isolation Tests
Created Playwright tests verifying:
- Client A can only see their own client record
- Client A cannot see Client B's properties
- Client A cannot see Client B's work orders
- Client A cannot see Client B's inspections
- Client A cannot see Client B's invoices
- Client A cannot see Client B's programs

### Task 2: Client UPDATE Policy Tests
- Client A can update their own program
- Client A cannot update Client B's program
- Client cannot change program ownership fields

### Task 3: Performance Tests
- Queries complete within 100ms threshold
- Baseline established for RLS query performance

## Test Architecture

```typescript
// Authenticated Supabase clients per test user
clientASupabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
await clientASupabase.auth.signInWithPassword({...})

// Direct database queries to verify RLS enforcement
const { data } = await clientASupabase
  .from('programs')
  .select('*')

// All returned records should belong to authenticated client
data?.forEach(record => {
  expect(record.client_id).toBe(clientAId)
})
```

## Verification

```bash
cd apps/admin
npx playwright test rls-security.spec.ts
```

Note: Tests will skip if test accounts are not set up.

## must_haves
- Cross-tenant isolation tests pass (Client A cannot see Client B's data)
- Client UPDATE policy tests pass (can update own, cannot update others)
- Ownership field immutability tested and verified
- Performance baseline established (100ms threshold)
- Tests are automated and repeatable via Playwright
