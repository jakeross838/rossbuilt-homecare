# Plan 12-03: Chart Components

## Objective

Install Recharts library and create reusable chart components for the analytics dashboard. Components will be built using shadcn/ui patterns and Ross Built brand colors.

## Dependencies

- 12-01: Analytics types and constants (chart colors, data types)
- Existing UI components: Card, Skeleton
- Recharts library (to be installed)

## Constraints

- Charts must be responsive and mobile-friendly
- Must handle empty/loading states gracefully
- Use Ross Built brand colors from analytics constants
- Follow shadcn/ui component patterns for consistency
- Support both light and dark mode (if applicable)

## Tasks

### Task 1: Install Recharts

Run in `apps/admin` directory:

```bash
npm install recharts
```

### Task 2: Create Area Chart Component

Create `apps/admin/src/components/charts/area-chart.tsx`:

```typescript
'use client'

import {
  Area,
  AreaChart as RechartsAreaChart,
  CartesianGrid,
  ResponsiveContainer,
  Tooltip,
  XAxis,
  YAxis,
} from 'recharts'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Skeleton } from '@/components/ui/skeleton'
import { CHART_COLORS, CHART_DEFAULTS } from '@/lib/constants/analytics'
import type { TimeSeriesDataPoint, TimePeriod } from '@/lib/types/analytics'
import { formatChartDate, formatCompactNumber, formatCurrency } from '@/lib/helpers/analytics'

interface AreaChartProps {
  title: string
  description?: string
  data: TimeSeriesDataPoint[]
  period?: TimePeriod
  loading?: boolean
  valueFormatter?: (value: number) => string
  color?: string
  height?: number
  showGrid?: boolean
  gradient?: boolean
}

export function AreaChart({
  title,
  description,
  data,
  period = 'month',
  loading = false,
  valueFormatter = formatCompactNumber,
  color = CHART_COLORS.primary,
  height = 300,
  showGrid = true,
  gradient = true,
}: AreaChartProps) {
  if (loading) {
    return (
      <Card>
        <CardHeader>
          <Skeleton className="h-5 w-32" />
          <Skeleton className="h-4 w-48" />
        </CardHeader>
        <CardContent>
          <Skeleton className="w-full" style={{ height }} />
        </CardContent>
      </Card>
    )
  }

  const isEmpty = !data || data.length === 0

  return (
    <Card>
      <CardHeader>
        <CardTitle>{title}</CardTitle>
        {description && <CardDescription>{description}</CardDescription>}
      </CardHeader>
      <CardContent>
        {isEmpty ? (
          <div
            className="flex items-center justify-center text-muted-foreground"
            style={{ height }}
          >
            No data available
          </div>
        ) : (
          <ResponsiveContainer width="100%" height={height}>
            <RechartsAreaChart
              data={data}
              margin={{ top: 10, right: 10, left: 0, bottom: 0 }}
            >
              {gradient && (
                <defs>
                  <linearGradient id={`gradient-${title.replace(/\s/g, '')}`} x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor={color} stopOpacity={0.3} />
                    <stop offset="95%" stopColor={color} stopOpacity={0} />
                  </linearGradient>
                </defs>
              )}
              {showGrid && (
                <CartesianGrid
                  strokeDasharray="3 3"
                  vertical={false}
                  stroke="hsl(var(--border))"
                />
              )}
              <XAxis
                dataKey="date"
                tickFormatter={(value) => formatChartDate(value, period)}
                stroke="hsl(var(--muted-foreground))"
                fontSize={12}
                tickLine={false}
                axisLine={false}
              />
              <YAxis
                tickFormatter={valueFormatter}
                stroke="hsl(var(--muted-foreground))"
                fontSize={12}
                tickLine={false}
                axisLine={false}
                width={60}
              />
              <Tooltip
                content={({ active, payload }) => {
                  if (!active || !payload?.length) return null
                  const point = payload[0].payload as TimeSeriesDataPoint
                  return (
                    <div className="rounded-lg border bg-background p-2 shadow-sm">
                      <p className="text-sm text-muted-foreground">
                        {formatChartDate(point.date, period)}
                      </p>
                      <p className="font-medium">{valueFormatter(point.value)}</p>
                    </div>
                  )
                }}
              />
              <Area
                type="monotone"
                dataKey="value"
                stroke={color}
                strokeWidth={CHART_DEFAULTS.strokeWidth}
                fill={gradient ? `url(#gradient-${title.replace(/\s/g, '')})` : color}
                fillOpacity={gradient ? 1 : 0.1}
                animationDuration={CHART_DEFAULTS.animationDuration}
              />
            </RechartsAreaChart>
          </ResponsiveContainer>
        )}
      </CardContent>
    </Card>
  )
}

// Convenience component for currency charts
export function RevenueAreaChart(props: Omit<AreaChartProps, 'valueFormatter'>) {
  return <AreaChart {...props} valueFormatter={formatCurrency} />
}
```

### Task 3: Create Bar Chart Component

Create `apps/admin/src/components/charts/bar-chart.tsx`:

```typescript
'use client'

import {
  Bar,
  BarChart as RechartsBarChart,
  CartesianGrid,
  Cell,
  ResponsiveContainer,
  Tooltip,
  XAxis,
  YAxis,
} from 'recharts'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Skeleton } from '@/components/ui/skeleton'
import { CHART_COLORS, CHART_DEFAULTS } from '@/lib/constants/analytics'
import type { CategoryDataPoint } from '@/lib/types/analytics'
import { formatCompactNumber, formatCurrency } from '@/lib/helpers/analytics'

interface BarChartProps {
  title: string
  description?: string
  data: CategoryDataPoint[]
  loading?: boolean
  valueFormatter?: (value: number) => string
  color?: string
  height?: number
  showGrid?: boolean
  horizontal?: boolean
  showLabels?: boolean
}

export function BarChart({
  title,
  description,
  data,
  loading = false,
  valueFormatter = formatCompactNumber,
  color = CHART_COLORS.primary,
  height = 300,
  showGrid = true,
  horizontal = false,
  showLabels = false,
}: BarChartProps) {
  if (loading) {
    return (
      <Card>
        <CardHeader>
          <Skeleton className="h-5 w-32" />
          <Skeleton className="h-4 w-48" />
        </CardHeader>
        <CardContent>
          <Skeleton className="w-full" style={{ height }} />
        </CardContent>
      </Card>
    )
  }

  const isEmpty = !data || data.length === 0

  // Format category names for display
  const formattedData = data.map((d) => ({
    ...d,
    displayName: d.name.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase()),
  }))

  return (
    <Card>
      <CardHeader>
        <CardTitle>{title}</CardTitle>
        {description && <CardDescription>{description}</CardDescription>}
      </CardHeader>
      <CardContent>
        {isEmpty ? (
          <div
            className="flex items-center justify-center text-muted-foreground"
            style={{ height }}
          >
            No data available
          </div>
        ) : (
          <ResponsiveContainer width="100%" height={height}>
            <RechartsBarChart
              data={formattedData}
              layout={horizontal ? 'vertical' : 'horizontal'}
              margin={{ top: 10, right: 10, left: horizontal ? 80 : 0, bottom: 0 }}
            >
              {showGrid && (
                <CartesianGrid
                  strokeDasharray="3 3"
                  horizontal={!horizontal}
                  vertical={horizontal}
                  stroke="hsl(var(--border))"
                />
              )}
              {horizontal ? (
                <>
                  <XAxis
                    type="number"
                    tickFormatter={valueFormatter}
                    stroke="hsl(var(--muted-foreground))"
                    fontSize={12}
                    tickLine={false}
                    axisLine={false}
                  />
                  <YAxis
                    type="category"
                    dataKey="displayName"
                    stroke="hsl(var(--muted-foreground))"
                    fontSize={12}
                    tickLine={false}
                    axisLine={false}
                    width={80}
                  />
                </>
              ) : (
                <>
                  <XAxis
                    dataKey="displayName"
                    stroke="hsl(var(--muted-foreground))"
                    fontSize={12}
                    tickLine={false}
                    axisLine={false}
                    angle={-45}
                    textAnchor="end"
                    height={60}
                  />
                  <YAxis
                    tickFormatter={valueFormatter}
                    stroke="hsl(var(--muted-foreground))"
                    fontSize={12}
                    tickLine={false}
                    axisLine={false}
                    width={60}
                  />
                </>
              )}
              <Tooltip
                content={({ active, payload }) => {
                  if (!active || !payload?.length) return null
                  const point = payload[0].payload as CategoryDataPoint & { displayName: string }
                  return (
                    <div className="rounded-lg border bg-background p-2 shadow-sm">
                      <p className="text-sm font-medium">{point.displayName}</p>
                      <p className="text-muted-foreground">{valueFormatter(point.value)}</p>
                    </div>
                  )
                }}
              />
              <Bar
                dataKey="value"
                radius={[CHART_DEFAULTS.barRadius, CHART_DEFAULTS.barRadius, 0, 0]}
                animationDuration={CHART_DEFAULTS.animationDuration}
              >
                {formattedData.map((entry, index) => (
                  <Cell
                    key={`cell-${index}`}
                    fill={entry.color || color}
                  />
                ))}
              </Bar>
            </RechartsBarChart>
          </ResponsiveContainer>
        )}
      </CardContent>
    </Card>
  )
}

// Horizontal bar chart for ranked data
export function HorizontalBarChart(props: Omit<BarChartProps, 'horizontal'>) {
  return <BarChart {...props} horizontal />
}

// Revenue bar chart with currency formatting
export function RevenueBarChart(props: Omit<BarChartProps, 'valueFormatter'>) {
  return <BarChart {...props} valueFormatter={formatCurrency} />
}
```

### Task 4: Create Pie/Donut Chart Component

Create `apps/admin/src/components/charts/pie-chart.tsx`:

```typescript
'use client'

import { Cell, Pie, PieChart as RechartsPieChart, ResponsiveContainer, Tooltip, Legend } from 'recharts'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Skeleton } from '@/components/ui/skeleton'
import { CHART_COLORS, CHART_DEFAULTS } from '@/lib/constants/analytics'
import type { CategoryDataPoint } from '@/lib/types/analytics'
import { formatCompactNumber } from '@/lib/helpers/analytics'

// Default color palette for pie charts
const DEFAULT_PIE_COLORS = [
  CHART_COLORS.primary,
  CHART_COLORS.accent,
  CHART_COLORS.secondary,
  CHART_COLORS.info,
  CHART_COLORS.warning,
  CHART_COLORS.success,
  CHART_COLORS.muted,
  CHART_COLORS.danger,
]

interface PieChartProps {
  title: string
  description?: string
  data: CategoryDataPoint[]
  loading?: boolean
  valueFormatter?: (value: number) => string
  height?: number
  donut?: boolean
  showLegend?: boolean
  showLabels?: boolean
}

export function PieChart({
  title,
  description,
  data,
  loading = false,
  valueFormatter = formatCompactNumber,
  height = 300,
  donut = false,
  showLegend = true,
  showLabels = false,
}: PieChartProps) {
  if (loading) {
    return (
      <Card>
        <CardHeader>
          <Skeleton className="h-5 w-32" />
          <Skeleton className="h-4 w-48" />
        </CardHeader>
        <CardContent>
          <Skeleton className="w-full" style={{ height }} />
        </CardContent>
      </Card>
    )
  }

  const isEmpty = !data || data.length === 0 || data.every((d) => d.value === 0)

  // Format names and assign colors
  const formattedData = data.map((d, i) => ({
    ...d,
    displayName: d.name.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase()),
    fill: d.color || DEFAULT_PIE_COLORS[i % DEFAULT_PIE_COLORS.length],
  }))

  const total = data.reduce((sum, d) => sum + d.value, 0)

  return (
    <Card>
      <CardHeader>
        <CardTitle>{title}</CardTitle>
        {description && <CardDescription>{description}</CardDescription>}
      </CardHeader>
      <CardContent>
        {isEmpty ? (
          <div
            className="flex items-center justify-center text-muted-foreground"
            style={{ height }}
          >
            No data available
          </div>
        ) : (
          <ResponsiveContainer width="100%" height={height}>
            <RechartsPieChart>
              <Pie
                data={formattedData}
                dataKey="value"
                nameKey="displayName"
                cx="50%"
                cy="50%"
                innerRadius={donut ? '60%' : 0}
                outerRadius="80%"
                paddingAngle={2}
                animationDuration={CHART_DEFAULTS.animationDuration}
                label={
                  showLabels
                    ? ({ displayName, value }) =>
                        `${displayName}: ${valueFormatter(value)}`
                    : undefined
                }
              >
                {formattedData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.fill} />
                ))}
              </Pie>
              <Tooltip
                content={({ active, payload }) => {
                  if (!active || !payload?.length) return null
                  const point = payload[0].payload as CategoryDataPoint & {
                    displayName: string
                    fill: string
                  }
                  const percentage = ((point.value / total) * 100).toFixed(1)
                  return (
                    <div className="rounded-lg border bg-background p-2 shadow-sm">
                      <div className="flex items-center gap-2">
                        <div
                          className="h-3 w-3 rounded-full"
                          style={{ backgroundColor: point.fill }}
                        />
                        <p className="text-sm font-medium">{point.displayName}</p>
                      </div>
                      <p className="text-muted-foreground">
                        {valueFormatter(point.value)} ({percentage}%)
                      </p>
                    </div>
                  )
                }}
              />
              {showLegend && (
                <Legend
                  layout="horizontal"
                  align="center"
                  verticalAlign="bottom"
                  formatter={(value) => (
                    <span className="text-sm text-foreground">{value}</span>
                  )}
                />
              )}
            </RechartsPieChart>
          </ResponsiveContainer>
        )}
      </CardContent>
    </Card>
  )
}

// Donut chart variant
export function DonutChart(props: Omit<PieChartProps, 'donut'>) {
  return <PieChart {...props} donut />
}
```

### Task 5: Create Stat Card Components

Create `apps/admin/src/components/charts/stat-card.tsx`:

```typescript
import { ArrowDown, ArrowUp, Minus } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Skeleton } from '@/components/ui/skeleton'
import type { MetricWithTrend } from '@/lib/types/analytics'
import {
  formatCompactNumber,
  formatCurrency,
  formatPercentageChange,
  getTrendColor,
} from '@/lib/helpers/analytics'
import { cn } from '@/lib/utils'

interface StatCardProps {
  title: string
  metric: MetricWithTrend | undefined
  loading?: boolean
  valueFormatter?: (value: number) => string
  icon?: React.ComponentType<{ className?: string }>
  description?: string
  positiveIsGood?: boolean
  comparisonLabel?: string
}

export function StatCard({
  title,
  metric,
  loading = false,
  valueFormatter = formatCompactNumber,
  icon: Icon,
  description,
  positiveIsGood = true,
  comparisonLabel = 'vs last period',
}: StatCardProps) {
  if (loading || !metric) {
    return (
      <Card>
        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
          <Skeleton className="h-4 w-24" />
          {Icon && <Skeleton className="h-4 w-4" />}
        </CardHeader>
        <CardContent>
          <Skeleton className="h-8 w-20 mb-1" />
          <Skeleton className="h-4 w-32" />
        </CardContent>
      </Card>
    )
  }

  const TrendIcon =
    metric.trend === 'up' ? ArrowUp : metric.trend === 'down' ? ArrowDown : Minus

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium">{title}</CardTitle>
        {Icon && <Icon className="h-4 w-4 text-muted-foreground" />}
      </CardHeader>
      <CardContent>
        <div className="text-2xl font-bold">{valueFormatter(metric.current)}</div>
        {description && (
          <p className="text-xs text-muted-foreground">{description}</p>
        )}
        {metric.change !== 0 && (
          <div className="flex items-center gap-1 mt-2 text-xs">
            <TrendIcon
              className={cn('h-3 w-3', getTrendColor(metric.trend, positiveIsGood))}
            />
            <span className={cn('font-medium', getTrendColor(metric.trend, positiveIsGood))}>
              {formatPercentageChange(metric.change)}
            </span>
            <span className="text-muted-foreground">{comparisonLabel}</span>
          </div>
        )}
      </CardContent>
    </Card>
  )
}

// Currency stat card
export function RevenueStatCard(props: Omit<StatCardProps, 'valueFormatter'>) {
  return <StatCard {...props} valueFormatter={formatCurrency} />
}

// Percentage stat card
export function PercentageStatCard(
  props: Omit<StatCardProps, 'valueFormatter'>
) {
  return (
    <StatCard
      {...props}
      valueFormatter={(value) => `${value}%`}
    />
  )
}

// Simple stat without trend (for current values)
interface SimpleStatCardProps {
  title: string
  value: number | string | undefined
  loading?: boolean
  valueFormatter?: (value: number) => string
  icon?: React.ComponentType<{ className?: string }>
  description?: string
}

export function SimpleStatCard({
  title,
  value,
  loading = false,
  valueFormatter = formatCompactNumber,
  icon: Icon,
  description,
}: SimpleStatCardProps) {
  if (loading || value === undefined) {
    return (
      <Card>
        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
          <Skeleton className="h-4 w-24" />
          {Icon && <Skeleton className="h-4 w-4" />}
        </CardHeader>
        <CardContent>
          <Skeleton className="h-8 w-20 mb-1" />
          {description && <Skeleton className="h-4 w-32" />}
        </CardContent>
      </Card>
    )
  }

  const displayValue = typeof value === 'number' ? valueFormatter(value) : value

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium">{title}</CardTitle>
        {Icon && <Icon className="h-4 w-4 text-muted-foreground" />}
      </CardHeader>
      <CardContent>
        <div className="text-2xl font-bold">{displayValue}</div>
        {description && (
          <p className="text-xs text-muted-foreground">{description}</p>
        )}
      </CardContent>
    </Card>
  )
}
```

### Task 6: Create Chart Index Export

Create `apps/admin/src/components/charts/index.ts`:

```typescript
// Area charts
export { AreaChart, RevenueAreaChart } from './area-chart'

// Bar charts
export { BarChart, HorizontalBarChart, RevenueBarChart } from './bar-chart'

// Pie/Donut charts
export { PieChart, DonutChart } from './pie-chart'

// Stat cards
export {
  StatCard,
  RevenueStatCard,
  PercentageStatCard,
  SimpleStatCard,
} from './stat-card'
```

### Task 7: Create Time Period Selector Component

Create `apps/admin/src/components/charts/period-selector.tsx`:

```typescript
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { TIME_PERIODS } from '@/lib/constants/analytics'
import type { TimePeriod } from '@/lib/types/analytics'

interface PeriodSelectorProps {
  value: TimePeriod
  onChange: (value: TimePeriod) => void
  className?: string
}

export function PeriodSelector({ value, onChange, className }: PeriodSelectorProps) {
  return (
    <Select value={value} onValueChange={(v) => onChange(v as TimePeriod)}>
      <SelectTrigger className={className}>
        <SelectValue />
      </SelectTrigger>
      <SelectContent>
        {TIME_PERIODS.map((period) => (
          <SelectItem key={period.value} value={period.value}>
            {period.label}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  )
}
```

Update index to include period selector:

```typescript
// Add to apps/admin/src/components/charts/index.ts

// Period selector
export { PeriodSelector } from './period-selector'
```

## Verification

After completing all tasks, verify:

1. **Recharts installed**: Check `package.json` includes recharts
2. **Types compile**: `cd apps/admin && npx tsc --noEmit`
3. **Files exist**:
   - `apps/admin/src/components/charts/area-chart.tsx`
   - `apps/admin/src/components/charts/bar-chart.tsx`
   - `apps/admin/src/components/charts/pie-chart.tsx`
   - `apps/admin/src/components/charts/stat-card.tsx`
   - `apps/admin/src/components/charts/period-selector.tsx`
   - `apps/admin/src/components/charts/index.ts`
4. **Components render**: Test importing and rendering a chart

## Commit

```
feat(analytics): add chart components with Recharts

- Install Recharts library for data visualization
- Add AreaChart component for time series data
- Add BarChart component with horizontal variant
- Add PieChart and DonutChart for distributions
- Add StatCard variants for metric display
- Add PeriodSelector for time range filtering
- Use Ross Built brand colors throughout
```
