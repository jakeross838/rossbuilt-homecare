---
phase: 06-smart-scheduling
plan: 05
type: execute
wave: 3
depends_on: ["06-02", "06-03", "06-04"]
files_modified:
  - apps/admin/src/components/calendar/schedule-inspection-dialog.tsx
  - apps/admin/src/components/calendar/inspection-detail-sheet.tsx
  - apps/admin/src/pages/calendar/index.tsx
  - apps/admin/src/App.tsx
autonomous: false
must_haves:
  truths:
    - "Admin can view full calendar page"
    - "Admin can open dialog to schedule new inspection"
    - "Admin can click inspection to see details"
    - "Admin can assign inspector from dropdown"
    - "Admin can reschedule or cancel inspection"
  artifacts:
    - path: "apps/admin/src/pages/calendar/index.tsx"
      provides: "Calendar page with full functionality"
    - path: "apps/admin/src/components/calendar/schedule-inspection-dialog.tsx"
      provides: "Dialog form for scheduling new inspections"
    - path: "apps/admin/src/components/calendar/inspection-detail-sheet.tsx"
      provides: "Sheet for viewing and managing inspection details"
  key_links:
    - from: "calendar page"
      to: "useCalendarInspections hook"
      via: "fetches data for current month"
    - from: "schedule-inspection-dialog"
      to: "useScheduleInspection mutation"
      via: "form submit creates inspection"
    - from: "inspection-detail-sheet"
      to: "useAssignInspector mutation"
      via: "inspector dropdown triggers update"
---

<objective>
Create the calendar page with scheduling dialog and inspection detail sheet, integrating all components and hooks.

Purpose: Deliver the complete scheduling UI for admin users.
Output: Fully functional calendar page with all scheduling operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan outputs
@.planning/phases/06-smart-scheduling/06-01-SUMMARY.md
@.planning/phases/06-smart-scheduling/06-02-SUMMARY.md
@.planning/phases/06-smart-scheduling/06-03-SUMMARY.md
@.planning/phases/06-smart-scheduling/06-04-SUMMARY.md

# Components and hooks from prior plans
@apps/admin/src/components/calendar/index.ts
@apps/admin/src/hooks/use-inspections.ts
@apps/admin/src/hooks/use-inspectors.ts
@apps/admin/src/lib/validations/inspection.ts

# Existing page patterns
@apps/admin/src/pages/properties/[id]/index.tsx
@apps/admin/src/pages/settings/pricing.tsx

# Existing dialog/sheet patterns
@apps/admin/src/components/programs/program-builder.tsx
@apps/admin/src/pages/properties/components/equipment-detail-sheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schedule inspection dialog</name>
  <files>apps/admin/src/components/calendar/schedule-inspection-dialog.tsx</files>
  <action>
Create dialog for scheduling new inspections:

```tsx
import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { format } from 'date-fns'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { useToast } from '@/hooks/use-toast'
import { useProperties } from '@/hooks/use-properties'
import { useInspectors } from '@/hooks/use-inspectors'
import { useScheduleInspection } from '@/hooks/use-inspections'
import {
  scheduleInspectionSchema,
  type ScheduleInspectionInput,
} from '@/lib/validations/inspection'
import { INSPECTION_TYPES, INSPECTION_DURATIONS } from '@/lib/constants/scheduling'
import type { Resolver } from 'react-hook-form'

interface ScheduleInspectionDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  initialDate?: Date
}

export function ScheduleInspectionDialog({
  open,
  onOpenChange,
  initialDate,
}: ScheduleInspectionDialogProps) {
  const { toast } = useToast()
  const { data: properties, isLoading: loadingProperties } = useProperties()
  const { data: inspectors, isLoading: loadingInspectors } = useInspectors()
  const scheduleInspection = useScheduleInspection()

  const form = useForm<ScheduleInspectionInput>({
    resolver: zodResolver(scheduleInspectionSchema) as Resolver<ScheduleInspectionInput>,
    defaultValues: {
      property_id: '',
      inspection_type: 'scheduled',
      scheduled_date: initialDate ? format(initialDate, 'yyyy-MM-dd') : '',
      scheduled_time_start: '09:00',
      estimated_duration_minutes: 60,
    },
  })

  const selectedType = form.watch('inspection_type')

  // Update duration when type changes (use tier-based defaults)
  const handleTypeChange = (value: string) => {
    form.setValue('inspection_type', value as ScheduleInspectionInput['inspection_type'])
    // Default duration based on common tier for type
    const duration = value === 'preventative' ? 120 : 60
    form.setValue('estimated_duration_minutes', duration)
  }

  const onSubmit = async (data: ScheduleInspectionInput) => {
    try {
      await scheduleInspection.mutateAsync(data)
      toast({
        title: 'Inspection scheduled',
        description: `Inspection scheduled for ${format(new Date(data.scheduled_date), 'MMMM d, yyyy')}`,
      })
      form.reset()
      onOpenChange(false)
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to schedule inspection. Please try again.',
        variant: 'destructive',
      })
    }
  }

  // Filter to properties with active programs
  const activeProperties = properties?.filter(p => {
    // In a full implementation, would check for active program
    // For now, show all properties
    return true
  })

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle>Schedule Inspection</DialogTitle>
          <DialogDescription>
            Create a new inspection for a property.
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
          {/* Property Select */}
          <div className="space-y-2">
            <Label htmlFor="property_id">Property *</Label>
            <Select
              value={form.watch('property_id')}
              onValueChange={(v) => form.setValue('property_id', v)}
              disabled={loadingProperties}
            >
              <SelectTrigger>
                <SelectValue placeholder="Select property" />
              </SelectTrigger>
              <SelectContent>
                {activeProperties?.map((property) => (
                  <SelectItem key={property.id} value={property.id}>
                    {property.name} - {property.city}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            {form.formState.errors.property_id && (
              <p className="text-sm text-destructive">
                {form.formState.errors.property_id.message}
              </p>
            )}
          </div>

          {/* Inspection Type */}
          <div className="space-y-2">
            <Label htmlFor="inspection_type">Inspection Type</Label>
            <Select
              value={selectedType}
              onValueChange={handleTypeChange}
            >
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                {INSPECTION_TYPES.map((type) => (
                  <SelectItem key={type.value} value={type.value}>
                    {type.label}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          {/* Date */}
          <div className="space-y-2">
            <Label htmlFor="scheduled_date">Date *</Label>
            <Input
              type="date"
              {...form.register('scheduled_date')}
            />
            {form.formState.errors.scheduled_date && (
              <p className="text-sm text-destructive">
                {form.formState.errors.scheduled_date.message}
              </p>
            )}
          </div>

          {/* Time */}
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="scheduled_time_start">Start Time</Label>
              <Input
                type="time"
                {...form.register('scheduled_time_start')}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="estimated_duration_minutes">Duration (min)</Label>
              <Input
                type="number"
                min={15}
                max={480}
                step={15}
                {...form.register('estimated_duration_minutes', { valueAsNumber: true })}
              />
            </div>
          </div>

          {/* Inspector */}
          <div className="space-y-2">
            <Label htmlFor="inspector_id">Assign Inspector</Label>
            <Select
              value={form.watch('inspector_id') || ''}
              onValueChange={(v) => form.setValue('inspector_id', v || undefined)}
              disabled={loadingInspectors}
            >
              <SelectTrigger>
                <SelectValue placeholder="Unassigned" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="">Unassigned</SelectItem>
                {inspectors?.map((inspector) => (
                  <SelectItem key={inspector.id} value={inspector.id}>
                    {inspector.full_name || inspector.email}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          {/* Actions */}
          <div className="flex justify-end gap-2 pt-4">
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
            >
              Cancel
            </Button>
            <Button
              type="submit"
              disabled={scheduleInspection.isPending}
            >
              {scheduleInspection.isPending ? 'Scheduling...' : 'Schedule Inspection'}
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

Use Resolver type cast for zod v4 compatibility (per 04-03 decision).
  </action>
  <verify>TypeScript compiles: cd apps/admin && npx tsc --noEmit</verify>
  <done>ScheduleInspectionDialog renders form with property, type, date, time, and inspector fields</done>
</task>

<task type="auto">
  <name>Task 2: Create inspection detail sheet</name>
  <files>apps/admin/src/components/calendar/inspection-detail-sheet.tsx</files>
  <action>
Create sheet for viewing and managing inspection details:

```tsx
import { format } from 'date-fns'
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetDescription,
} from '@/components/ui/sheet'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog'
import { Calendar, Clock, MapPin, User, X } from 'lucide-react'
import { useToast } from '@/hooks/use-toast'
import { useInspectors } from '@/hooks/use-inspectors'
import { useAssignInspector, useCancelInspection } from '@/hooks/use-inspections'
import type { CalendarInspection } from '@/lib/types/scheduling'
import { INSPECTION_STATUS_COLORS, INSPECTION_TYPES } from '@/lib/constants/scheduling'

interface InspectionDetailSheetProps {
  inspection: CalendarInspection | null
  open: boolean
  onOpenChange: (open: boolean) => void
}

export function InspectionDetailSheet({
  inspection,
  open,
  onOpenChange,
}: InspectionDetailSheetProps) {
  const { toast } = useToast()
  const { data: inspectors } = useInspectors()
  const assignInspector = useAssignInspector()
  const cancelInspection = useCancelInspection()

  if (!inspection) return null

  const statusColor = INSPECTION_STATUS_COLORS[inspection.status || 'scheduled']
  const typeInfo = INSPECTION_TYPES.find(t => t.value === inspection.inspection_type)

  const handleAssignInspector = async (inspectorId: string) => {
    try {
      await assignInspector.mutateAsync({
        inspectionId: inspection.id,
        inspectorId: inspectorId || null,
      })
      toast({
        title: 'Inspector assigned',
        description: inspectorId
          ? 'Inspector has been assigned to this inspection.'
          : 'Inspector has been unassigned.',
      })
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to assign inspector. Please try again.',
        variant: 'destructive',
      })
    }
  }

  const handleCancel = async () => {
    try {
      await cancelInspection.mutateAsync(inspection.id)
      toast({
        title: 'Inspection cancelled',
        description: 'The inspection has been cancelled.',
      })
      onOpenChange(false)
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to cancel inspection. Please try again.',
        variant: 'destructive',
      })
    }
  }

  const isCancellable = inspection.status === 'scheduled' || inspection.status === 'rescheduled'

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent className="w-[400px] sm:w-[540px]">
        <SheetHeader>
          <div className="flex items-start justify-between">
            <div>
              <SheetTitle>{inspection.property?.name || 'Inspection'}</SheetTitle>
              <SheetDescription>
                {typeInfo?.label || inspection.inspection_type} Inspection
              </SheetDescription>
            </div>
            <Badge variant={statusColor.variant}>
              {inspection.status || 'scheduled'}
            </Badge>
          </div>
        </SheetHeader>

        <div className="mt-6 space-y-6">
          {/* Details */}
          <div className="space-y-4">
            <h3 className="font-medium">Details</h3>

            <div className="space-y-3 text-sm">
              <div className="flex items-center gap-3">
                <Calendar className="h-4 w-4 text-muted-foreground" />
                <span>
                  {format(new Date(inspection.scheduled_date), 'EEEE, MMMM d, yyyy')}
                </span>
              </div>

              <div className="flex items-center gap-3">
                <Clock className="h-4 w-4 text-muted-foreground" />
                <span>
                  {inspection.scheduled_time_start?.slice(0, 5) || 'Time TBD'}
                  {inspection.scheduled_time_end && ` - ${inspection.scheduled_time_end.slice(0, 5)}`}
                  {inspection.estimated_duration_minutes && (
                    <span className="text-muted-foreground">
                      {' '}({inspection.estimated_duration_minutes} min)
                    </span>
                  )}
                </span>
              </div>

              {inspection.property && (
                <div className="flex items-start gap-3">
                  <MapPin className="h-4 w-4 text-muted-foreground mt-0.5" />
                  <div>
                    <div>{inspection.property.address_line1}</div>
                    <div className="text-muted-foreground">{inspection.property.city}</div>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Inspector Assignment */}
          <div className="space-y-3">
            <h3 className="font-medium">Inspector</h3>
            <Select
              value={inspection.inspector_id || ''}
              onValueChange={handleAssignInspector}
              disabled={assignInspector.isPending}
            >
              <SelectTrigger>
                <SelectValue placeholder="Assign inspector" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="">Unassigned</SelectItem>
                {inspectors?.map((inspector) => (
                  <SelectItem key={inspector.id} value={inspector.id}>
                    {inspector.full_name || inspector.email}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          {/* Actions */}
          <div className="space-y-3 pt-4 border-t">
            <h3 className="font-medium">Actions</h3>
            <div className="flex gap-2">
              <Button
                variant="outline"
                className="flex-1"
                onClick={() => {
                  // TODO: Open reschedule dialog
                  toast({ title: 'Coming soon', description: 'Reschedule functionality' })
                }}
                disabled={!isCancellable}
              >
                Reschedule
              </Button>

              <AlertDialog>
                <AlertDialogTrigger asChild>
                  <Button
                    variant="destructive"
                    className="flex-1"
                    disabled={!isCancellable || cancelInspection.isPending}
                  >
                    Cancel
                  </Button>
                </AlertDialogTrigger>
                <AlertDialogContent>
                  <AlertDialogHeader>
                    <AlertDialogTitle>Cancel Inspection?</AlertDialogTitle>
                    <AlertDialogDescription>
                      This will cancel the scheduled inspection. This action cannot be undone.
                    </AlertDialogDescription>
                  </AlertDialogHeader>
                  <AlertDialogFooter>
                    <AlertDialogCancel>Keep Inspection</AlertDialogCancel>
                    <AlertDialogAction onClick={handleCancel}>
                      Cancel Inspection
                    </AlertDialogAction>
                  </AlertDialogFooter>
                </AlertDialogContent>
              </AlertDialog>
            </div>
          </div>
        </div>
      </SheetContent>
    </Sheet>
  )
}
```

Use AlertDialog for destructive confirmation (per 04-04 pattern).
  </action>
  <verify>TypeScript compiles: cd apps/admin && npx tsc --noEmit</verify>
  <done>InspectionDetailSheet displays details, allows inspector assignment and cancellation</done>
</task>

<task type="auto">
  <name>Task 3: Create calendar page and update routes</name>
  <files>apps/admin/src/pages/calendar/index.tsx, apps/admin/src/App.tsx, apps/admin/src/components/calendar/index.ts</files>
  <action>
Create pages/calendar/index.tsx:

```tsx
import { useState, useCallback } from 'react'
import { format, startOfMonth, endOfMonth } from 'date-fns'
import { Plus } from 'lucide-react'
import { PageHeader } from '@/components/layout/page-header'
import { Button } from '@/components/ui/button'
import { CalendarView } from '@/components/calendar'
import { ScheduleInspectionDialog } from '@/components/calendar/schedule-inspection-dialog'
import { InspectionDetailSheet } from '@/components/calendar/inspection-detail-sheet'
import { useCalendarInspections } from '@/hooks/use-inspections'
import type { CalendarInspection } from '@/lib/types/scheduling'

export default function CalendarPage() {
  const [dateRange, setDateRange] = useState(() => {
    const now = new Date()
    return {
      start: format(startOfMonth(now), 'yyyy-MM-dd'),
      end: format(endOfMonth(now), 'yyyy-MM-dd'),
    }
  })

  const [scheduleDialogOpen, setScheduleDialogOpen] = useState(false)
  const [selectedDate, setSelectedDate] = useState<Date | undefined>()
  const [selectedInspection, setSelectedInspection] = useState<CalendarInspection | null>(null)
  const [detailSheetOpen, setDetailSheetOpen] = useState(false)

  const { data: inspections, isLoading } = useCalendarInspections(
    dateRange.start,
    dateRange.end
  )

  const handleDateRangeChange = useCallback((start: string, end: string) => {
    setDateRange({ start, end })
  }, [])

  const handleDayClick = (date: Date) => {
    setSelectedDate(date)
    setScheduleDialogOpen(true)
  }

  const handleInspectionClick = (inspection: CalendarInspection) => {
    setSelectedInspection(inspection)
    setDetailSheetOpen(true)
  }

  const handleScheduleNew = () => {
    setSelectedDate(undefined)
    setScheduleDialogOpen(true)
  }

  return (
    <div className="space-y-6">
      <PageHeader
        title="Calendar"
        description="View and manage scheduled inspections"
        action={
          <Button onClick={handleScheduleNew}>
            <Plus className="h-4 w-4 mr-2" />
            Schedule Inspection
          </Button>
        }
      />

      <CalendarView
        inspections={inspections || []}
        isLoading={isLoading}
        onDayClick={handleDayClick}
        onInspectionClick={handleInspectionClick}
        onDateRangeChange={handleDateRangeChange}
      />

      <ScheduleInspectionDialog
        open={scheduleDialogOpen}
        onOpenChange={setScheduleDialogOpen}
        initialDate={selectedDate}
      />

      <InspectionDetailSheet
        inspection={selectedInspection}
        open={detailSheetOpen}
        onOpenChange={setDetailSheetOpen}
      />
    </div>
  )
}
```

Update apps/admin/src/App.tsx - replace placeholder with real page:

```tsx
// Add import at top:
import CalendarPage from '@/pages/calendar'

// Replace the placeholder route:
// FROM:
<Route path="/calendar" element={<PlaceholderPage title="Calendar" />} />

// TO:
<Route path="/calendar" element={<CalendarPage />} />
```

Update components/calendar/index.ts to add new exports:

```ts
export { CalendarView } from './calendar-view'
export { CalendarHeader } from './calendar-header'
export { CalendarGrid } from './calendar-grid'
export { InspectionCard } from './inspection-card'
export { ScheduleInspectionDialog } from './schedule-inspection-dialog'
export { InspectionDetailSheet } from './inspection-detail-sheet'
```
  </action>
  <verify>TypeScript compiles: cd apps/admin && npx tsc --noEmit</verify>
  <done>Calendar page created and routes updated</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete scheduling calendar with ability to view inspections, schedule new ones, assign inspectors, and cancel</what-built>
  <how-to-verify>
    1. Run: cd apps/admin && npm run dev
    2. Login and navigate to /calendar
    3. Verify: Monthly calendar grid displays with weekday headers
    4. Click "Schedule Inspection" button - dialog opens
    5. Fill form: select a property, set date/time, optionally assign inspector
    6. Submit - inspection appears in calendar
    7. Click on the inspection card - detail sheet opens
    8. Change inspector assignment - saves successfully
    9. Click Cancel button - confirmation dialog appears
    10. Confirm cancel - inspection is removed/marked cancelled
    11. Navigate between months - data updates correctly
  </how-to-verify>
  <resume-signal>Type "approved" if calendar works correctly, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd apps/admin && npx tsc --noEmit` passes
- [ ] Calendar page loads at /calendar route
- [ ] Schedule dialog creates new inspections
- [ ] Detail sheet shows inspection info and allows edits
- [ ] Inspector assignment updates successfully
- [ ] Cancel confirmation works
- [ ] Human verification passed
</verification>

<success_criteria>
- All tasks completed
- TypeScript compiles without errors
- Calendar displays inspections correctly
- All CRUD operations work
- User approved visual and functional verification
</success_criteria>

<output>
After completion, create `.planning/phases/06-smart-scheduling/06-05-SUMMARY.md`
</output>
