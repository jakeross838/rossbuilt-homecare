---
wave: 1
depends_on: []
files_modified:
  - components/portal/plan-editor/plan-editor.tsx
  - components/portal/plan-editor/index.ts
  - pages/portal/plans/index.tsx
autonomous: true
---

# Plan 05-01: Self-Service Plan Editor

## Objective
Build a self-service plan editor allowing clients to modify their service plans with live pricing updates. Clients can adjust inspection frequency and toggle add-on services while seeing real-time pricing comparisons with 20% builder markup.

## Prerequisites
- Client portal infrastructure from Phase 4
- Existing pricing configuration hooks (`usePricingConfig`)
- Existing price calculation utilities (`calculateProgramPrice`)
- Existing program update mutation (`useUpdateProgram`)
- Property program data hooks (`usePropertyProgram`)

## Files Created/Modified

### Created
- `components/portal/plan-editor/plan-editor.tsx` (230 lines) - Main plan editor component with frequency selector, addon toggles, and live pricing
- `components/portal/plan-editor/index.ts` - Barrel export for plan editor component

### Modified
- `pages/portal/plans/index.tsx` - Added "Edit Plan" button, Sheet/Drawer integration, automatic refetch after save

## Implementation Tasks

### Task 1: PlanEditor Component
**Files:** `components/portal/plan-editor/plan-editor.tsx`, `components/portal/plan-editor/index.ts`

**What was built:**
- Inspection frequency selector (annual to bi-weekly options)
- Add-on service toggles:
  - Digital Home Manual
  - Warranty Tracking
  - Emergency Response
  - Hurricane Monitoring
- Live pricing calculator with 20% builder markup applied to all fees
- Current vs Proposed price comparison display
- Price difference indicator showing increases/decreases
- Fee breakdown (base fee, tier fee, addons fee)
- Confirmation dialog before saving changes
- Immediate effect messaging to set user expectations

**Pricing Logic:**
```typescript
const BUILDER_MARKUP = 0.20

const proposedPricing = {
  baseFee: base.baseFee * (1 + BUILDER_MARKUP),
  tierFee: base.tierFee * (1 + BUILDER_MARKUP),
  addonsFee: base.addonsFee * (1 + BUILDER_MARKUP),
  monthlyTotal: base.monthlyTotal * (1 + BUILDER_MARKUP),
}
```

### Task 2: Plans Page Integration
**Files:** `pages/portal/plans/index.tsx`

**What was built:**
- "Edit Plan" button added to each property card
- Sheet/Drawer component integration for plan editing overlay
- Connected to `usePropertyProgram` hook for full program data
- Automatic data refetch after successful save
- Proper loading and error state handling

## User Flow

1. Client navigates to `/portal/plans`
2. Clicks "Edit Plan" on a property card
3. Sheet opens with current plan settings loaded
4. Client modifies frequency or toggles addons
5. Live pricing updates show:
   - Current monthly cost
   - New monthly cost
   - Difference (+ or -)
   - Fee breakdown
6. Client clicks "Save Changes"
7. Confirmation dialog shows summary of changes
8. Client confirms -> changes saved immediately
9. Sheet closes, property list refreshes with new data

## Integration Points
- Uses existing `usePricingConfig` hook for price configuration
- Uses existing `calculateProgramPrice` function for calculations
- Uses existing `useUpdateProgram` mutation for saving
- Triggers invoice creation for plan upgrades (via existing backend logic)

## Verification
- Plan editor opens when "Edit Plan" clicked
- Frequency selector shows all options (annual to bi-weekly)
- Addon toggles work correctly
- Live pricing updates instantly on any change
- 20% builder markup correctly applied to all fees
- Current vs proposed comparison displays correctly
- Confirmation dialog appears before save
- Changes persist after save and page refresh
- Property list refreshes with updated pricing

## must_haves
- Client can view current plan settings in the editor
- Client can toggle addon features (Digital Home Manual, Warranty Tracking, Emergency Response, Hurricane Monitoring)
- Client can change inspection frequency (annual to bi-weekly)
- Price updates instantly as options change
- 20% builder markup included in all displayed pricing
- Current vs proposed comparison visible with difference indicator
- Confirmation dialog appears before save
- Changes take effect immediately after confirmation
