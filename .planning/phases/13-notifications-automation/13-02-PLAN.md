# Plan 13-02: Email Edge Function (Resend)

## Objective

Create a Supabase Edge Function for sending transactional emails using the Resend API. This provides reliable email delivery with beautiful HTML templates for inspection reports, invoices, work orders, and other notifications.

## Prerequisites

- Plan 13-01 complete (Notification Data Foundation)
- Resend account created with API key
- Domain verified in Resend (noreply@rossbuilt.com or similar)

## Dependencies

- 13-01 (Notification types and constants)

## Research Notes

**Resend API:**
- Simple REST API for transactional email
- React Email integration for templating
- Webhook support for delivery tracking
- Rate limit: 100 emails/second on growth plan
- SDK available: `npm install resend` (but using fetch for edge function)

**Key endpoints:**
- POST /emails - Send single email
- POST /emails/batch - Send batch emails (up to 100)
- GET /emails/{id} - Get email status

## Tasks

### Task 1: Create email Edge Function
**File**: `supabase/functions/send-email/index.ts`

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

interface EmailRequest {
  to: string | string[]
  cc?: string[]
  bcc?: string[]
  subject: string
  html: string
  text?: string
  reply_to?: string
  attachments?: Array<{
    filename: string
    content: string
  }>
  // Tracking
  notification_id?: string
  organization_id?: string
}

serve(async (req) => {
  // Handle CORS preflight
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const resendKey = Deno.env.get('RESEND_API_KEY')
    if (!resendKey) {
      return new Response(
        JSON.stringify({ error: 'RESEND_API_KEY not configured' }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    const payload: EmailRequest = await req.json()

    // Validate required fields
    if (!payload.to || !payload.subject || !payload.html) {
      return new Response(
        JSON.stringify({ error: 'Missing required fields: to, subject, html' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // Prepare Resend request
    const fromEmail = Deno.env.get('EMAIL_FROM') || 'Ross Built <noreply@rossbuilt.com>'

    const resendPayload = {
      from: fromEmail,
      to: Array.isArray(payload.to) ? payload.to : [payload.to],
      cc: payload.cc,
      bcc: payload.bcc,
      subject: payload.subject,
      html: payload.html,
      text: payload.text || stripHtml(payload.html),
      reply_to: payload.reply_to,
      attachments: payload.attachments?.map((a) => ({
        filename: a.filename,
        content: a.content,
      })),
    }

    // Send via Resend API
    const response = await fetch('https://api.resend.com/emails', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${resendKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(resendPayload),
    })

    const result = await response.json()

    if (!response.ok) {
      console.error('Resend API error:', result)

      // Update notification status if tracking
      if (payload.notification_id) {
        await updateNotificationStatus(payload.notification_id, false, result.message)
      }

      return new Response(
        JSON.stringify({ error: result.message || 'Failed to send email' }),
        { status: response.status, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // Update notification status if tracking
    if (payload.notification_id) {
      await updateNotificationStatus(payload.notification_id, true)
    }

    // Log to activity if org provided
    if (payload.organization_id) {
      await logEmailSent(payload.organization_id, payload.to, payload.subject)
    }

    return new Response(
      JSON.stringify({
        success: true,
        message_id: result.id,
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  } catch (error) {
    console.error('Email send error:', error)
    return new Response(
      JSON.stringify({ error: error instanceof Error ? error.message : 'Unknown error' }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  }
})

/**
 * Strip HTML tags for plain text version
 */
function stripHtml(html: string): string {
  return html
    .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
    .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
    .replace(/<[^>]+>/g, '')
    .replace(/\s+/g, ' ')
    .trim()
}

/**
 * Update notification record with email status
 */
async function updateNotificationStatus(
  notificationId: string,
  success: boolean,
  error?: string
) {
  try {
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    )

    await supabase
      .from('notifications')
      .update({
        email_sent: success,
        email_sent_at: success ? new Date().toISOString() : null,
      })
      .eq('id', notificationId)
  } catch (err) {
    console.error('Failed to update notification status:', err)
  }
}

/**
 * Log email sent to activity log
 */
async function logEmailSent(
  organizationId: string,
  recipients: string | string[],
  subject: string
) {
  try {
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    )

    await supabase.from('activity_log').insert({
      organization_id: organizationId,
      action: 'sent',
      entity_type: 'email',
      entity_id: crypto.randomUUID(),
      entity_name: subject,
      metadata: {
        recipients: Array.isArray(recipients) ? recipients : [recipients],
        sent_at: new Date().toISOString(),
      },
    })
  } catch (err) {
    console.error('Failed to log email activity:', err)
  }
}
```

**Verification**: File exists with email sending logic

### Task 2: Create email templates module
**File**: `apps/admin/src/lib/email/templates.ts`

```typescript
import type { EmailTemplateType } from '@/lib/types/notification'

/**
 * Base email layout wrapper
 */
export function getEmailLayout(content: string, preheader?: string): string {
  return `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Ross Built Home Care</title>
  <!--[if mso]>
  <noscript>
    <xml>
      <o:OfficeDocumentSettings>
        <o:PixelsPerInch>96</o:PixelsPerInch>
      </o:OfficeDocumentSettings>
    </xml>
  </noscript>
  <![endif]-->
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f4f4f5;
      color: #18181b;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      background-color: #ffffff;
      border-radius: 8px;
      padding: 32px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .header {
      text-align: center;
      padding-bottom: 24px;
      border-bottom: 1px solid #e4e4e7;
      margin-bottom: 24px;
    }
    .logo {
      height: 40px;
      margin-bottom: 8px;
    }
    .brand-name {
      font-size: 20px;
      font-weight: 600;
      color: #166534;
    }
    h1 {
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 16px 0;
      color: #18181b;
    }
    p {
      font-size: 16px;
      line-height: 1.6;
      margin: 0 0 16px 0;
      color: #3f3f46;
    }
    .button {
      display: inline-block;
      padding: 12px 24px;
      background-color: #166534;
      color: #ffffff !important;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 500;
      font-size: 16px;
      margin: 16px 0;
    }
    .button:hover {
      background-color: #14532d;
    }
    .info-box {
      background-color: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 6px;
      padding: 16px;
      margin: 16px 0;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e4e4e7;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      color: #71717a;
      font-size: 14px;
    }
    .info-value {
      font-weight: 500;
      color: #18181b;
    }
    .footer {
      text-align: center;
      padding-top: 24px;
      border-top: 1px solid #e4e4e7;
      margin-top: 24px;
    }
    .footer p {
      font-size: 14px;
      color: #71717a;
    }
    .footer a {
      color: #166534;
      text-decoration: none;
    }
    .preheader {
      display: none;
      max-height: 0;
      overflow: hidden;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-green { background-color: #dcfce7; color: #166534; }
    .badge-yellow { background-color: #fef9c3; color: #854d0e; }
    .badge-red { background-color: #fee2e2; color: #991b1b; }
    .badge-blue { background-color: #dbeafe; color: #1e40af; }
  </style>
</head>
<body>
  ${preheader ? `<div class="preheader">${preheader}</div>` : ''}
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="brand-name">Ross Built</div>
        <div style="font-size: 14px; color: #71717a;">Home Care Management</div>
      </div>
      ${content}
      <div class="footer">
        <p>Ross Built Home Care</p>
        <p>Tampa Bay, Florida</p>
        <p style="margin-top: 16px; font-size: 12px;">
          <a href="{unsubscribe_url}">Manage notification preferences</a>
        </p>
      </div>
    </div>
  </div>
</body>
</html>
`
}

/**
 * Inspection scheduled email template
 */
export function getInspectionScheduledTemplate(vars: {
  client_name: string
  property_name: string
  property_address: string
  inspection_date: string
  inspection_time: string
  inspection_type: string
  inspector_name: string
  action_url: string
}): string {
  const content = `
    <h1>Inspection Scheduled</h1>
    <p>Hello ${vars.client_name},</p>
    <p>An inspection has been scheduled for your property. Here are the details:</p>

    <div class="info-box">
      <div class="info-row">
        <span class="info-label">Property</span>
        <span class="info-value">${vars.property_name}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Address</span>
        <span class="info-value">${vars.property_address}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Date</span>
        <span class="info-value">${vars.inspection_date}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Time</span>
        <span class="info-value">${vars.inspection_time}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Type</span>
        <span class="info-value">${vars.inspection_type}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Inspector</span>
        <span class="info-value">${vars.inspector_name}</span>
      </div>
    </div>

    <p>Please ensure the property is accessible at the scheduled time. If you need to reschedule, please contact us as soon as possible.</p>

    <div style="text-align: center;">
      <a href="${vars.action_url}" class="button">View in Portal</a>
    </div>
  `

  return getEmailLayout(content, `Inspection scheduled for ${vars.property_name} on ${vars.inspection_date}`)
}

/**
 * Inspection reminder email template
 */
export function getInspectionReminderTemplate(vars: {
  client_name: string
  property_name: string
  property_address: string
  inspection_date: string
  inspection_time: string
  inspector_name: string
  action_url: string
}): string {
  const content = `
    <h1>Inspection Tomorrow</h1>
    <p>Hello ${vars.client_name},</p>
    <p>This is a friendly reminder that your property inspection is scheduled for <strong>tomorrow</strong>.</p>

    <div class="info-box">
      <div class="info-row">
        <span class="info-label">Property</span>
        <span class="info-value">${vars.property_name}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Address</span>
        <span class="info-value">${vars.property_address}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Date</span>
        <span class="info-value">${vars.inspection_date}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Time</span>
        <span class="info-value">${vars.inspection_time}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Inspector</span>
        <span class="info-value">${vars.inspector_name}</span>
      </div>
    </div>

    <p>Please ensure the property is accessible at the scheduled time.</p>

    <div style="text-align: center;">
      <a href="${vars.action_url}" class="button">View Details</a>
    </div>
  `

  return getEmailLayout(content, `Reminder: Inspection tomorrow at ${vars.property_name}`)
}

/**
 * Report ready email template
 */
export function getReportReadyTemplate(vars: {
  client_name: string
  property_name: string
  inspection_date: string
  overall_condition: string
  findings_summary: string
  recommendations_count: number
  report_url: string
  portal_url: string
}): string {
  const conditionBadge =
    vars.overall_condition === 'good'
      ? '<span class="badge badge-green">Good Condition</span>'
      : vars.overall_condition === 'fair'
      ? '<span class="badge badge-yellow">Fair Condition</span>'
      : '<span class="badge badge-red">Needs Attention</span>'

  const content = `
    <h1>Your Inspection Report is Ready</h1>
    <p>Hello ${vars.client_name},</p>
    <p>The inspection report for your property is now available.</p>

    <div class="info-box">
      <div class="info-row">
        <span class="info-label">Property</span>
        <span class="info-value">${vars.property_name}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Inspection Date</span>
        <span class="info-value">${vars.inspection_date}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Overall Condition</span>
        <span class="info-value">${conditionBadge}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Recommendations</span>
        <span class="info-value">${vars.recommendations_count} item${vars.recommendations_count !== 1 ? 's' : ''}</span>
      </div>
    </div>

    <p>${vars.findings_summary}</p>

    <div style="text-align: center;">
      <a href="${vars.report_url}" class="button">Download Report (PDF)</a>
    </div>

    <p style="text-align: center; margin-top: 8px;">
      <a href="${vars.portal_url}" style="color: #166534;">View in client portal →</a>
    </p>
  `

  return getEmailLayout(content, `Your inspection report for ${vars.property_name} is ready`)
}

/**
 * Invoice created email template
 */
export function getInvoiceCreatedTemplate(vars: {
  client_name: string
  invoice_number: string
  amount: string
  due_date: string
  line_items: Array<{ description: string; amount: string }>
  payment_url: string
  portal_url: string
}): string {
  const lineItemsHtml = vars.line_items
    .map(
      (item) => `
      <div class="info-row">
        <span class="info-label">${item.description}</span>
        <span class="info-value">${item.amount}</span>
      </div>
    `
    )
    .join('')

  const content = `
    <h1>New Invoice</h1>
    <p>Hello ${vars.client_name},</p>
    <p>A new invoice has been created for your account.</p>

    <div class="info-box">
      <div class="info-row">
        <span class="info-label">Invoice #</span>
        <span class="info-value">${vars.invoice_number}</span>
      </div>
      ${lineItemsHtml}
      <div class="info-row" style="border-top: 2px solid #e4e4e7; margin-top: 8px; padding-top: 8px;">
        <span class="info-label" style="font-weight: 600;">Total Due</span>
        <span class="info-value" style="font-size: 18px;">${vars.amount}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Due Date</span>
        <span class="info-value">${vars.due_date}</span>
      </div>
    </div>

    <div style="text-align: center;">
      <a href="${vars.payment_url}" class="button">Pay Now</a>
    </div>

    <p style="text-align: center; margin-top: 8px;">
      <a href="${vars.portal_url}" style="color: #166534;">View in client portal →</a>
    </p>
  `

  return getEmailLayout(content, `Invoice #${vars.invoice_number} - ${vars.amount} due ${vars.due_date}`)
}

/**
 * Invoice overdue email template
 */
export function getInvoiceOverdueTemplate(vars: {
  client_name: string
  invoice_number: string
  amount: string
  due_date: string
  days_overdue: number
  payment_url: string
}): string {
  const content = `
    <h1 style="color: #991b1b;">Invoice Overdue</h1>
    <p>Hello ${vars.client_name},</p>
    <p>Your invoice is now <strong>${vars.days_overdue} day${vars.days_overdue !== 1 ? 's' : ''} overdue</strong>. Please remit payment at your earliest convenience to avoid any service interruption.</p>

    <div class="info-box" style="background-color: #fef2f2; border-color: #fecaca;">
      <div class="info-row">
        <span class="info-label">Invoice #</span>
        <span class="info-value">${vars.invoice_number}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Amount Due</span>
        <span class="info-value" style="font-size: 18px; color: #991b1b;">${vars.amount}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Original Due Date</span>
        <span class="info-value">${vars.due_date}</span>
      </div>
    </div>

    <div style="text-align: center;">
      <a href="${vars.payment_url}" class="button" style="background-color: #991b1b;">Pay Now</a>
    </div>

    <p style="font-size: 14px; color: #71717a;">If you've already made this payment, please disregard this notice. If you have any questions, please contact us.</p>
  `

  return getEmailLayout(content, `OVERDUE: Invoice #${vars.invoice_number} - ${vars.amount}`)
}

/**
 * Work order created email template
 */
export function getWorkOrderCreatedTemplate(vars: {
  recipient_name: string
  work_order_number: string
  property_name: string
  property_address: string
  category: string
  priority: string
  description: string
  action_url: string
}): string {
  const priorityBadge =
    vars.priority === 'urgent'
      ? '<span class="badge badge-red">Urgent</span>'
      : vars.priority === 'high'
      ? '<span class="badge badge-yellow">High Priority</span>'
      : '<span class="badge badge-blue">Normal</span>'

  const content = `
    <h1>New Work Order</h1>
    <p>Hello ${vars.recipient_name},</p>
    <p>A new work order has been created and requires attention.</p>

    <div class="info-box">
      <div class="info-row">
        <span class="info-label">Work Order #</span>
        <span class="info-value">${vars.work_order_number}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Property</span>
        <span class="info-value">${vars.property_name}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Address</span>
        <span class="info-value">${vars.property_address}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Category</span>
        <span class="info-value">${vars.category}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Priority</span>
        <span class="info-value">${priorityBadge}</span>
      </div>
    </div>

    <p><strong>Description:</strong></p>
    <p style="background-color: #f4f4f5; padding: 12px; border-radius: 4px;">${vars.description}</p>

    <div style="text-align: center;">
      <a href="${vars.action_url}" class="button">View Work Order</a>
    </div>
  `

  return getEmailLayout(content, `Work Order #${vars.work_order_number} - ${vars.category}`)
}

/**
 * Payment received email template
 */
export function getPaymentReceivedTemplate(vars: {
  client_name: string
  amount: string
  invoice_number: string
  payment_method: string
  payment_date: string
  remaining_balance: string
}): string {
  const content = `
    <h1 style="color: #166534;">Payment Received</h1>
    <p>Hello ${vars.client_name},</p>
    <p>Thank you! We've received your payment.</p>

    <div class="info-box">
      <div class="info-row">
        <span class="info-label">Amount Received</span>
        <span class="info-value" style="font-size: 20px; color: #166534;">${vars.amount}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Invoice #</span>
        <span class="info-value">${vars.invoice_number}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Payment Method</span>
        <span class="info-value">${vars.payment_method}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Date</span>
        <span class="info-value">${vars.payment_date}</span>
      </div>
      ${
        vars.remaining_balance !== '$0.00'
          ? `
      <div class="info-row">
        <span class="info-label">Remaining Balance</span>
        <span class="info-value">${vars.remaining_balance}</span>
      </div>
      `
          : ''
      }
    </div>

    <p>We appreciate your business. If you have any questions about this payment, please don't hesitate to contact us.</p>
  `

  return getEmailLayout(content, `Payment received: ${vars.amount} - Thank you!`)
}

/**
 * Get template function by type
 */
export function getEmailTemplate(
  type: EmailTemplateType,
  variables: Record<string, unknown>
): string {
  const templateMap: Record<EmailTemplateType, (vars: Record<string, unknown>) => string> = {
    inspection_scheduled: (v) => getInspectionScheduledTemplate(v as Parameters<typeof getInspectionScheduledTemplate>[0]),
    inspection_reminder: (v) => getInspectionReminderTemplate(v as Parameters<typeof getInspectionReminderTemplate>[0]),
    inspection_completed: (v) => getReportReadyTemplate(v as Parameters<typeof getReportReadyTemplate>[0]),
    report_ready: (v) => getReportReadyTemplate(v as Parameters<typeof getReportReadyTemplate>[0]),
    work_order_created: (v) => getWorkOrderCreatedTemplate(v as Parameters<typeof getWorkOrderCreatedTemplate>[0]),
    work_order_status_update: (v) => getWorkOrderCreatedTemplate(v as Parameters<typeof getWorkOrderCreatedTemplate>[0]),
    work_order_completed: (v) => getWorkOrderCreatedTemplate(v as Parameters<typeof getWorkOrderCreatedTemplate>[0]),
    invoice_created: (v) => getInvoiceCreatedTemplate(v as Parameters<typeof getInvoiceCreatedTemplate>[0]),
    invoice_due_soon: (v) => getInvoiceCreatedTemplate(v as Parameters<typeof getInvoiceCreatedTemplate>[0]),
    invoice_overdue: (v) => getInvoiceOverdueTemplate(v as Parameters<typeof getInvoiceOverdueTemplate>[0]),
    payment_received: (v) => getPaymentReceivedTemplate(v as Parameters<typeof getPaymentReceivedTemplate>[0]),
    recommendation_approved: (v) => getEmailLayout(`<h1>Recommendation Approved</h1><p>${JSON.stringify(v)}</p>`),
    service_request_received: (v) => getEmailLayout(`<h1>Service Request Received</h1><p>${JSON.stringify(v)}</p>`),
    service_request_update: (v) => getEmailLayout(`<h1>Service Request Update</h1><p>${JSON.stringify(v)}</p>`),
    daily_digest: (v) => getEmailLayout(`<h1>Daily Summary</h1><p>${JSON.stringify(v)}</p>`),
    weekly_summary: (v) => getEmailLayout(`<h1>Weekly Summary</h1><p>${JSON.stringify(v)}</p>`),
  }

  const templateFn = templateMap[type]
  if (!templateFn) {
    return getEmailLayout(`<h1>Notification</h1><p>${JSON.stringify(variables)}</p>`)
  }

  return templateFn(variables)
}
```

**Verification**: File exists with ~500 lines of email templates

### Task 3: Create email service hook
**File**: `apps/admin/src/hooks/use-email.ts`

```typescript
import { useMutation } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase'
import type { EmailTemplateType } from '@/lib/types/notification'
import { getEmailTemplate } from '@/lib/email/templates'
import { getEmailSubject } from '@/lib/helpers/notifications'

interface SendEmailOptions {
  to: string | string[]
  cc?: string[]
  bcc?: string[]
  template_type: EmailTemplateType
  variables: Record<string, string | number | boolean>
  attachments?: Array<{
    filename: string
    content: string
  }>
  notification_id?: string
}

interface SendEmailResult {
  success: boolean
  message_id?: string
  error?: string
}

/**
 * Send email via edge function
 */
async function sendEmail(options: SendEmailOptions): Promise<SendEmailResult> {
  const subject = getEmailSubject(options.template_type, options.variables)
  const html = getEmailTemplate(options.template_type, options.variables)

  const { data, error } = await supabase.functions.invoke('send-email', {
    body: {
      to: options.to,
      cc: options.cc,
      bcc: options.bcc,
      subject,
      html,
      attachments: options.attachments,
      notification_id: options.notification_id,
    },
  })

  if (error) {
    throw new Error(error.message)
  }

  return data
}

/**
 * Hook for sending emails
 */
export function useSendEmail() {
  return useMutation({
    mutationFn: sendEmail,
  })
}

/**
 * Send inspection scheduled email
 */
export function useSendInspectionScheduledEmail() {
  const { mutateAsync: send, ...rest } = useSendEmail()

  return {
    ...rest,
    send: async (params: {
      to: string
      client_name: string
      property_name: string
      property_address: string
      inspection_date: string
      inspection_time: string
      inspection_type: string
      inspector_name: string
      action_url: string
    }) => {
      return send({
        to: params.to,
        template_type: 'inspection_scheduled',
        variables: params,
      })
    },
  }
}

/**
 * Send inspection reminder email
 */
export function useSendInspectionReminderEmail() {
  const { mutateAsync: send, ...rest } = useSendEmail()

  return {
    ...rest,
    send: async (params: {
      to: string
      client_name: string
      property_name: string
      property_address: string
      inspection_date: string
      inspection_time: string
      inspector_name: string
      action_url: string
    }) => {
      return send({
        to: params.to,
        template_type: 'inspection_reminder',
        variables: params,
      })
    },
  }
}

/**
 * Send report ready email
 */
export function useSendReportReadyEmail() {
  const { mutateAsync: send, ...rest } = useSendEmail()

  return {
    ...rest,
    send: async (params: {
      to: string
      client_name: string
      property_name: string
      inspection_date: string
      overall_condition: string
      findings_summary: string
      recommendations_count: number
      report_url: string
      portal_url: string
      attachments?: Array<{ filename: string; content: string }>
    }) => {
      return send({
        to: params.to,
        template_type: 'report_ready',
        variables: {
          client_name: params.client_name,
          property_name: params.property_name,
          inspection_date: params.inspection_date,
          overall_condition: params.overall_condition,
          findings_summary: params.findings_summary,
          recommendations_count: params.recommendations_count,
          report_url: params.report_url,
          portal_url: params.portal_url,
        },
        attachments: params.attachments,
      })
    },
  }
}

/**
 * Send invoice email
 */
export function useSendInvoiceEmail() {
  const { mutateAsync: send, ...rest } = useSendEmail()

  return {
    ...rest,
    send: async (params: {
      to: string
      client_name: string
      invoice_number: string
      amount: string
      due_date: string
      line_items: Array<{ description: string; amount: string }>
      payment_url: string
      portal_url: string
    }) => {
      return send({
        to: params.to,
        template_type: 'invoice_created',
        variables: params,
      })
    },
  }
}

/**
 * Send invoice overdue email
 */
export function useSendInvoiceOverdueEmail() {
  const { mutateAsync: send, ...rest } = useSendEmail()

  return {
    ...rest,
    send: async (params: {
      to: string
      client_name: string
      invoice_number: string
      amount: string
      due_date: string
      days_overdue: number
      payment_url: string
    }) => {
      return send({
        to: params.to,
        template_type: 'invoice_overdue',
        variables: params,
      })
    },
  }
}

/**
 * Send payment received email
 */
export function useSendPaymentReceivedEmail() {
  const { mutateAsync: send, ...rest } = useSendEmail()

  return {
    ...rest,
    send: async (params: {
      to: string
      client_name: string
      amount: string
      invoice_number: string
      payment_method: string
      payment_date: string
      remaining_balance: string
    }) => {
      return send({
        to: params.to,
        template_type: 'payment_received',
        variables: params,
      })
    },
  }
}

/**
 * Send work order notification email
 */
export function useSendWorkOrderEmail() {
  const { mutateAsync: send, ...rest } = useSendEmail()

  return {
    ...rest,
    send: async (params: {
      to: string
      recipient_name: string
      work_order_number: string
      property_name: string
      property_address: string
      category: string
      priority: string
      description: string
      action_url: string
      template_type?: 'work_order_created' | 'work_order_status_update' | 'work_order_completed'
    }) => {
      return send({
        to: params.to,
        template_type: params.template_type ?? 'work_order_created',
        variables: params,
      })
    },
  }
}
```

**Verification**: File exists with email hooks

### Task 4: Create setup documentation
**File**: `apps/admin/src/lib/email/RESEND_SETUP.md`

```markdown
# Resend Email Setup

## Overview

This application uses [Resend](https://resend.com) for transactional email delivery.

## Setup Steps

### 1. Create Resend Account

1. Go to [resend.com](https://resend.com) and sign up
2. Verify your email address

### 2. Configure Domain (Production)

1. In Resend dashboard, go to **Domains**
2. Add your domain (e.g., `rossbuilt.com`)
3. Add the required DNS records:
   - SPF record
   - DKIM records (2)
   - Optional: DMARC record

### 3. Get API Key

1. In Resend dashboard, go to **API Keys**
2. Create a new API key with "Sending access"
3. Copy the key (starts with `re_`)

### 4. Configure Supabase

Add the following secrets to your Supabase project:

```bash
# Via Supabase CLI
supabase secrets set RESEND_API_KEY=re_your_api_key_here
supabase secrets set EMAIL_FROM="Ross Built <noreply@rossbuilt.com>"

# Or via Dashboard
# Go to: Project Settings > Edge Functions > Secrets
```

### 5. Deploy Edge Function

```bash
supabase functions deploy send-email --no-verify-jwt
```

## Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `RESEND_API_KEY` | Resend API key | `re_123abc...` |
| `EMAIL_FROM` | Default sender address | `Ross Built <noreply@rossbuilt.com>` |

## Testing

### Test via curl

```bash
curl -X POST 'https://your-project.supabase.co/functions/v1/send-email' \
  -H 'Authorization: Bearer YOUR_ANON_KEY' \
  -H 'Content-Type: application/json' \
  -d '{
    "to": "test@example.com",
    "subject": "Test Email",
    "html": "<h1>Hello World</h1>"
  }'
```

### Test in Development

Use Resend's test email address for development:
- To: `delivered@resend.dev` (always succeeds)
- To: `bounced@resend.dev` (simulates bounce)

## Email Templates

Templates are defined in `apps/admin/src/lib/email/templates.ts`:

- `inspection_scheduled` - New inspection notification
- `inspection_reminder` - Day-before reminder
- `report_ready` - Inspection report available
- `invoice_created` - New invoice
- `invoice_overdue` - Overdue payment reminder
- `payment_received` - Payment confirmation
- `work_order_created` - New work order

## Rate Limits

| Plan | Rate Limit |
|------|------------|
| Free | 100 emails/day, 1 email/second |
| Pro | 50,000 emails/month, 10 emails/second |
| Growth | 100 emails/second |

## Webhooks (Optional)

To track email delivery:

1. In Resend dashboard, go to **Webhooks**
2. Add endpoint: `https://your-project.supabase.co/functions/v1/resend-webhook`
3. Select events: `email.sent`, `email.delivered`, `email.bounced`

## Troubleshooting

### Email not sending
- Check RESEND_API_KEY is set correctly
- Verify domain DNS records are propagated
- Check Resend dashboard for error logs

### Emails going to spam
- Ensure SPF, DKIM, DMARC are configured
- Avoid spam trigger words in subject/content
- Include unsubscribe link

### Rate limited
- Implement queuing for bulk sends
- Upgrade Resend plan if needed
```

**Verification**: Documentation file exists

## Verification

```bash
ls -la supabase/functions/send-email/index.ts
ls -la apps/admin/src/lib/email/templates.ts
ls -la apps/admin/src/hooks/use-email.ts
ls -la apps/admin/src/lib/email/RESEND_SETUP.md
```

## Files Created

| File | Description | Lines |
|------|-------------|-------|
| `supabase/functions/send-email/index.ts` | Resend email edge function | ~150 |
| `apps/admin/src/lib/email/templates.ts` | HTML email templates | ~500 |
| `apps/admin/src/hooks/use-email.ts` | Email sending hooks | ~200 |
| `apps/admin/src/lib/email/RESEND_SETUP.md` | Setup documentation | ~120 |

## Commit Message

```
feat(notifications): add Resend email edge function and templates

- Add send-email Supabase Edge Function with Resend integration
- Add HTML email templates for inspections, invoices, work orders
- Add React Query hooks for sending templated emails
- Add Resend setup documentation
```
