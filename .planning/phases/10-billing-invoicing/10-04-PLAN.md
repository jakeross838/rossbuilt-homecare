# Plan 10-04: Stripe Integration Edge Function

## Objective

Create Supabase Edge Functions for Stripe integration: creating payment links, handling webhooks, and syncing subscription status. This enables online payments for invoices.

## Wave

**Wave 2** - Depends on Wave 1 (10-01: Billing Data Foundation), can run parallel with 10-02, 10-03

## Dependencies

- 10-01: Billing types and constants
- Stripe account with API keys
- Supabase Edge Functions environment

## Must-Haves

- [ ] create-payment-link edge function
- [ ] stripe-webhook edge function
- [ ] Payment link generation for invoices
- [ ] Webhook handling for payment success
- [ ] Invoice status sync on payment

## Tasks

### 1. Create payment link edge function (`supabase/functions/create-payment-link/index.ts`)

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import Stripe from 'https://esm.sh/stripe@14.10.0?target=deno'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

interface PaymentLinkRequest {
  invoice_id: string
  success_url?: string
  cancel_url?: string
}

serve(async (req) => {
  // Handle CORS preflight
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // Initialize Stripe
    const stripeKey = Deno.env.get('STRIPE_SECRET_KEY')
    if (!stripeKey) {
      throw new Error('Stripe secret key not configured')
    }
    const stripe = new Stripe(stripeKey, {
      apiVersion: '2023-10-16',
      httpClient: Stripe.createFetchHttpClient(),
    })

    // Initialize Supabase client with service role for admin access
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    const supabase = createClient(supabaseUrl, supabaseServiceKey)

    // Parse request
    const { invoice_id, success_url, cancel_url }: PaymentLinkRequest = await req.json()

    if (!invoice_id) {
      return new Response(
        JSON.stringify({ error: 'invoice_id is required' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // Fetch invoice with client details
    const { data: invoice, error: invoiceError } = await supabase
      .from('invoices')
      .select(`
        *,
        client:clients(
          id,
          email,
          first_name,
          last_name,
          company_name,
          stripe_customer_id
        ),
        line_items:invoice_line_items(*)
      `)
      .eq('id', invoice_id)
      .single()

    if (invoiceError || !invoice) {
      return new Response(
        JSON.stringify({ error: 'Invoice not found' }),
        { status: 404, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // Check invoice is payable
    if (invoice.status === 'paid' || invoice.status === 'void') {
      return new Response(
        JSON.stringify({ error: 'Invoice is not payable' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    const client = invoice.client as {
      id: string
      email: string | null
      first_name: string
      last_name: string
      company_name: string | null
      stripe_customer_id: string | null
    }

    // Create or get Stripe customer
    let customerId = client.stripe_customer_id

    if (!customerId) {
      const customer = await stripe.customers.create({
        email: client.email || undefined,
        name: client.company_name || `${client.first_name} ${client.last_name}`,
        metadata: {
          supabase_client_id: client.id,
        },
      })
      customerId = customer.id

      // Save customer ID to client record
      await supabase
        .from('clients')
        .update({ stripe_customer_id: customerId })
        .eq('id', client.id)
    }

    // Create line items for Stripe
    const lineItems = (invoice.line_items || []).map((item: any) => ({
      price_data: {
        currency: 'usd',
        product_data: {
          name: item.description,
        },
        unit_amount: Math.round(item.unit_price * 100), // Convert to cents
      },
      quantity: Math.round(item.quantity),
    }))

    // Add tax if applicable
    if (invoice.tax_amount && invoice.tax_amount > 0) {
      lineItems.push({
        price_data: {
          currency: 'usd',
          product_data: {
            name: 'Tax',
          },
          unit_amount: Math.round(invoice.tax_amount * 100),
        },
        quantity: 1,
      })
    }

    // Apply discount if applicable
    let discounts: Stripe.Checkout.SessionCreateParams.Discount[] = []
    if (invoice.discount_amount && invoice.discount_amount > 0) {
      // Create a coupon for the discount
      const coupon = await stripe.coupons.create({
        amount_off: Math.round(invoice.discount_amount * 100),
        currency: 'usd',
        name: invoice.discount_description || 'Discount',
        duration: 'once',
      })
      discounts = [{ coupon: coupon.id }]
    }

    // Base URL for redirects
    const baseUrl = Deno.env.get('APP_URL') || 'https://app.rossbuilt.com'

    // Create Checkout Session
    const session = await stripe.checkout.sessions.create({
      customer: customerId,
      mode: 'payment',
      line_items: lineItems,
      discounts,
      success_url: success_url || `${baseUrl}/invoices/${invoice_id}?payment=success`,
      cancel_url: cancel_url || `${baseUrl}/invoices/${invoice_id}?payment=cancelled`,
      metadata: {
        invoice_id: invoice_id,
        invoice_number: invoice.invoice_number,
      },
      payment_intent_data: {
        metadata: {
          invoice_id: invoice_id,
          invoice_number: invoice.invoice_number,
        },
      },
    })

    // Save session ID to invoice
    await supabase
      .from('invoices')
      .update({
        stripe_payment_intent_id: session.payment_intent as string,
        updated_at: new Date().toISOString(),
      })
      .eq('id', invoice_id)

    return new Response(
      JSON.stringify({
        url: session.url,
        session_id: session.id,
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  } catch (error) {
    console.error('Error creating payment link:', error)
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  }
})
```

### 2. Create Stripe webhook handler (`supabase/functions/stripe-webhook/index.ts`)

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import Stripe from 'https://esm.sh/stripe@14.10.0?target=deno'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type, stripe-signature',
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const stripeKey = Deno.env.get('STRIPE_SECRET_KEY')!
    const webhookSecret = Deno.env.get('STRIPE_WEBHOOK_SECRET')!
    const stripe = new Stripe(stripeKey, {
      apiVersion: '2023-10-16',
      httpClient: Stripe.createFetchHttpClient(),
    })

    // Get raw body for signature verification
    const body = await req.text()
    const signature = req.headers.get('stripe-signature')!

    // Verify webhook signature
    let event: Stripe.Event
    try {
      event = stripe.webhooks.constructEvent(body, signature, webhookSecret)
    } catch (err) {
      console.error('Webhook signature verification failed:', err)
      return new Response(
        JSON.stringify({ error: 'Invalid signature' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // Initialize Supabase
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    const supabase = createClient(supabaseUrl, supabaseServiceKey)

    console.log('Processing webhook event:', event.type)

    // Handle different event types
    switch (event.type) {
      case 'checkout.session.completed': {
        const session = event.data.object as Stripe.Checkout.Session
        const invoiceId = session.metadata?.invoice_id

        if (invoiceId && session.payment_status === 'paid') {
          // Get invoice to calculate payment
          const { data: invoice } = await supabase
            .from('invoices')
            .select('balance_due, client_id, organization_id')
            .eq('id', invoiceId)
            .single()

          if (invoice) {
            // Record payment
            await supabase.from('payments').insert({
              organization_id: invoice.organization_id,
              invoice_id: invoiceId,
              client_id: invoice.client_id,
              amount: invoice.balance_due,
              payment_method: 'card',
              stripe_payment_id: session.payment_intent as string,
              payment_date: new Date().toISOString(),
            })

            // Update invoice status
            await supabase
              .from('invoices')
              .update({
                status: 'paid',
                amount_paid: invoice.balance_due,
                balance_due: 0,
                paid_at: new Date().toISOString(),
                stripe_payment_intent_id: session.payment_intent as string,
                payment_method: 'card',
                updated_at: new Date().toISOString(),
              })
              .eq('id', invoiceId)

            console.log('Invoice marked as paid:', invoiceId)
          }
        }
        break
      }

      case 'payment_intent.succeeded': {
        const paymentIntent = event.data.object as Stripe.PaymentIntent
        const invoiceId = paymentIntent.metadata?.invoice_id

        if (invoiceId) {
          // Get payment method details
          let last_four: string | undefined
          let card_brand: string | undefined

          if (paymentIntent.payment_method) {
            try {
              const paymentMethod = await stripe.paymentMethods.retrieve(
                paymentIntent.payment_method as string
              )
              if (paymentMethod.card) {
                last_four = paymentMethod.card.last4
                card_brand = paymentMethod.card.brand
              }
            } catch (err) {
              console.error('Error fetching payment method:', err)
            }
          }

          // Update payment record with card details
          await supabase
            .from('payments')
            .update({
              stripe_charge_id: paymentIntent.latest_charge as string,
              last_four,
              card_brand,
            })
            .eq('stripe_payment_id', paymentIntent.id)

          console.log('Payment details updated for:', invoiceId)
        }
        break
      }

      case 'payment_intent.payment_failed': {
        const paymentIntent = event.data.object as Stripe.PaymentIntent
        const invoiceId = paymentIntent.metadata?.invoice_id

        if (invoiceId) {
          console.log('Payment failed for invoice:', invoiceId)
          // Could add notification or status update here
        }
        break
      }

      default:
        console.log('Unhandled event type:', event.type)
    }

    return new Response(
      JSON.stringify({ received: true }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  } catch (error) {
    console.error('Webhook error:', error)
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  }
})
```

### 3. Create hook for payment links (`apps/admin/src/hooks/use-stripe.ts`)

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase'
import { invoiceKeys } from './use-invoices'

interface PaymentLinkResponse {
  url: string
  session_id: string
}

/**
 * Hook to create a Stripe payment link for an invoice
 */
export function useCreatePaymentLink() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({
      invoiceId,
      successUrl,
      cancelUrl,
    }: {
      invoiceId: string
      successUrl?: string
      cancelUrl?: string
    }) => {
      const { data, error } = await supabase.functions.invoke<PaymentLinkResponse>(
        'create-payment-link',
        {
          body: {
            invoice_id: invoiceId,
            success_url: successUrl,
            cancel_url: cancelUrl,
          },
        }
      )

      if (error) throw error
      if (!data) throw new Error('No response from payment link function')

      return data
    },
    onSuccess: (data, variables) => {
      // Could invalidate invoice if needed
      queryClient.invalidateQueries({
        queryKey: invoiceKeys.detail(variables.invoiceId),
      })
    },
  })
}

/**
 * Open Stripe payment link in new tab
 */
export function openPaymentLink(url: string) {
  window.open(url, '_blank', 'noopener,noreferrer')
}
```

### 4. Add stripe_customer_id to clients migration (`supabase/migrations/021_stripe_customer_id.sql`)

```sql
-- 021_stripe_customer_id.sql
-- Add Stripe customer ID to clients table

ALTER TABLE clients
ADD COLUMN IF NOT EXISTS stripe_customer_id TEXT;

-- Index for lookups
CREATE INDEX IF NOT EXISTS idx_clients_stripe_customer
ON clients(stripe_customer_id)
WHERE stripe_customer_id IS NOT NULL;

-- Comment
COMMENT ON COLUMN clients.stripe_customer_id IS 'Stripe Customer ID for payment processing';
```

### 5. Create setup instructions (`apps/admin/src/lib/stripe/STRIPE_SETUP.md`)

```markdown
# Stripe Integration Setup

## Prerequisites

1. Stripe account (https://stripe.com)
2. Supabase project with Edge Functions enabled

## Configuration Steps

### 1. Get Stripe API Keys

1. Log into Stripe Dashboard
2. Go to Developers > API Keys
3. Copy your Secret Key (starts with `sk_`)
4. For production, use live keys; for testing, use test keys

### 2. Set Supabase Secrets

```bash
supabase secrets set STRIPE_SECRET_KEY=sk_test_xxx
supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_xxx
supabase secrets set APP_URL=https://your-app-url.com
```

### 3. Configure Webhook Endpoint

1. In Stripe Dashboard, go to Developers > Webhooks
2. Click "Add endpoint"
3. Enter URL: `https://[project-ref].supabase.co/functions/v1/stripe-webhook`
4. Select events:
   - `checkout.session.completed`
   - `payment_intent.succeeded`
   - `payment_intent.payment_failed`
5. Copy the Signing Secret (starts with `whsec_`)
6. Set as `STRIPE_WEBHOOK_SECRET` in Supabase

### 4. Deploy Edge Functions

```bash
supabase functions deploy create-payment-link --no-verify-jwt
supabase functions deploy stripe-webhook --no-verify-jwt
```

### 5. Test the Integration

1. Create a test invoice
2. Generate a payment link
3. Complete payment with Stripe test card: 4242 4242 4242 4242
4. Verify invoice status updates to "paid"

## Test Cards

- Success: 4242 4242 4242 4242
- Decline: 4000 0000 0000 0002
- Requires Auth: 4000 0025 0000 3155

Use any future expiry date and any 3-digit CVC.
```

## Files Created

- `supabase/functions/create-payment-link/index.ts` - Payment link generation
- `supabase/functions/stripe-webhook/index.ts` - Webhook handler
- `apps/admin/src/hooks/use-stripe.ts` - React hook for payment links
- `supabase/migrations/021_stripe_customer_id.sql` - Add Stripe customer ID
- `apps/admin/src/lib/stripe/STRIPE_SETUP.md` - Setup instructions

## Checkpoint

After completion:
- [ ] Edge functions deploy successfully
- [ ] Payment link hook compiles
- [ ] Migration applies without error
- [ ] Setup instructions are clear
- [ ] Commit: `feat(billing): add Stripe integration - payment links, webhooks`

## Notes

- Uses Stripe Checkout for secure, hosted payment pages
- Webhook verifies signature for security
- Customer ID cached on client record for repeat payments
- Invoice metadata links Stripe to Supabase records
- Supports discounts via Stripe coupons
