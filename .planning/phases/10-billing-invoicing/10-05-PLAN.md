# Plan 10-05: Invoice UI Components

## Objective

Create UI components for invoice management: status badges, cards, forms, dialogs for creating invoices and recording payments. Follows existing shadcn/ui patterns.

## Wave

**Wave 3** - Depends on Wave 2 (10-02: Invoice Hooks, 10-03: Payment Hooks, 10-04: Stripe)

## Dependencies

- 10-01: Billing types, constants, validations
- 10-02: Invoice hooks
- 10-03: Payment hooks
- 10-04: Stripe hook

## Must-Haves

- [ ] InvoiceStatusBadge - Color-coded status display
- [ ] InvoiceCard - Summary card for list views
- [ ] InvoiceLineItemRow - Editable line item component
- [ ] CreateInvoiceDialog - Multi-step invoice creation
- [ ] RecordPaymentDialog - Record manual payments
- [ ] SendInvoiceDialog - Send invoice to client
- [ ] PaymentLinkButton - Generate Stripe payment link

## Tasks

### 1. Create invoice status badge (`apps/admin/src/components/billing/invoice-status-badge.tsx`)

```typescript
import { Badge } from '@/components/ui/badge'
import type { InvoiceStatus } from '@/lib/types/billing'
import { INVOICE_STATUS_CONFIG } from '@/lib/constants/billing'

interface InvoiceStatusBadgeProps {
  status: InvoiceStatus
  showDot?: boolean
}

export function InvoiceStatusBadge({ status, showDot = false }: InvoiceStatusBadgeProps) {
  const config = INVOICE_STATUS_CONFIG[status]

  return (
    <Badge variant={config.variant}>
      {showDot && (
        <span
          className={`mr-1.5 h-2 w-2 rounded-full bg-${config.color}-500`}
          aria-hidden="true"
        />
      )}
      {config.label}
    </Badge>
  )
}
```

### 2. Create invoice card (`apps/admin/src/components/billing/invoice-card.tsx`)

```typescript
import { Card, CardContent, CardHeader } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { InvoiceStatusBadge } from './invoice-status-badge'
import { formatCurrency, getDaysUntilDue, isInvoiceOverdue } from '@/lib/helpers/billing'
import type { InvoiceListItem } from '@/lib/types/billing'
import { Calendar, User, AlertTriangle, ExternalLink } from 'lucide-react'
import { Link } from 'react-router-dom'

interface InvoiceCardProps {
  invoice: InvoiceListItem
  onPaymentLink?: () => void
}

export function InvoiceCard({ invoice, onPaymentLink }: InvoiceCardProps) {
  const daysUntilDue = getDaysUntilDue(invoice.due_date)
  const isOverdue = isInvoiceOverdue(invoice.due_date, invoice.status)

  return (
    <Card>
      <CardHeader className="pb-3">
        <div className="flex items-start justify-between">
          <div>
            <Link
              to={`/billing/invoices/${invoice.id}`}
              className="font-semibold hover:underline"
            >
              {invoice.invoice_number}
            </Link>
            <p className="text-sm text-muted-foreground">
              {invoice.invoice_type === 'subscription' ? 'Subscription' : 'Service'}
            </p>
          </div>
          <InvoiceStatusBadge status={invoice.status} />
        </div>
      </CardHeader>
      <CardContent className="space-y-3">
        <div className="flex items-center gap-2 text-sm text-muted-foreground">
          <User className="h-4 w-4" />
          <span>{invoice.client_name}</span>
        </div>

        <div className="flex items-center gap-2 text-sm text-muted-foreground">
          <Calendar className="h-4 w-4" />
          <span>Due {new Date(invoice.due_date).toLocaleDateString()}</span>
          {isOverdue && (
            <span className="flex items-center gap-1 text-destructive">
              <AlertTriangle className="h-3 w-3" />
              {Math.abs(daysUntilDue)} days overdue
            </span>
          )}
          {!isOverdue && daysUntilDue <= 7 && daysUntilDue > 0 && (
            <span className="text-warning">Due in {daysUntilDue} days</span>
          )}
        </div>

        <div className="flex items-center justify-between pt-2 border-t">
          <div>
            <p className="text-2xl font-bold">{formatCurrency(invoice.balance_due)}</p>
            {invoice.balance_due < invoice.total && (
              <p className="text-xs text-muted-foreground">
                of {formatCurrency(invoice.total)} total
              </p>
            )}
          </div>

          {invoice.status !== 'paid' && invoice.status !== 'void' && onPaymentLink && (
            <Button variant="outline" size="sm" onClick={onPaymentLink}>
              <ExternalLink className="h-4 w-4 mr-1" />
              Pay Online
            </Button>
          )}
        </div>
      </CardContent>
    </Card>
  )
}
```

### 3. Create line item row (`apps/admin/src/components/billing/invoice-line-item-row.tsx`)

```typescript
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { LINE_ITEM_TYPES } from '@/lib/constants/billing'
import { calculateLineItemAmount, formatCurrency } from '@/lib/helpers/billing'
import { Trash2 } from 'lucide-react'

interface LineItemData {
  description: string
  quantity: number
  unit_price: number
  line_type?: string
}

interface InvoiceLineItemRowProps {
  item: LineItemData
  index: number
  onChange: (index: number, field: keyof LineItemData, value: string | number) => void
  onRemove: (index: number) => void
  disabled?: boolean
}

export function InvoiceLineItemRow({
  item,
  index,
  onChange,
  onRemove,
  disabled,
}: InvoiceLineItemRowProps) {
  const amount = calculateLineItemAmount(item.quantity, item.unit_price)

  return (
    <div className="flex items-center gap-2 py-2">
      <div className="flex-1">
        <Input
          placeholder="Description"
          value={item.description}
          onChange={(e) => onChange(index, 'description', e.target.value)}
          disabled={disabled}
        />
      </div>
      <div className="w-24">
        <Select
          value={item.line_type || 'other'}
          onValueChange={(value) => onChange(index, 'line_type', value)}
          disabled={disabled}
        >
          <SelectTrigger>
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            {LINE_ITEM_TYPES.map((type) => (
              <SelectItem key={type.value} value={type.value}>
                {type.label}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
      <div className="w-20">
        <Input
          type="number"
          min="0.01"
          step="0.01"
          placeholder="Qty"
          value={item.quantity}
          onChange={(e) => onChange(index, 'quantity', parseFloat(e.target.value) || 0)}
          disabled={disabled}
        />
      </div>
      <div className="w-28">
        <Input
          type="number"
          min="0"
          step="0.01"
          placeholder="Price"
          value={item.unit_price}
          onChange={(e) => onChange(index, 'unit_price', parseFloat(e.target.value) || 0)}
          disabled={disabled}
        />
      </div>
      <div className="w-24 text-right font-medium">
        {formatCurrency(amount)}
      </div>
      <Button
        type="button"
        variant="ghost"
        size="icon"
        onClick={() => onRemove(index)}
        disabled={disabled}
      >
        <Trash2 className="h-4 w-4" />
      </Button>
    </div>
  )
}
```

### 4. Create invoice form (`apps/admin/src/components/billing/create-invoice-dialog.tsx`)

```typescript
import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { InvoiceLineItemRow } from './invoice-line-item-row'
import { useClients } from '@/hooks/use-clients'
import { useCreateInvoice } from '@/hooks/use-invoices'
import { useToast } from '@/hooks/use-toast'
import { createInvoiceSchema, type CreateInvoiceFormData } from '@/lib/validations/billing'
import {
  INVOICE_TYPES,
  DUE_DATE_OPTIONS,
  DEFAULT_INVOICE_TERMS,
} from '@/lib/constants/billing'
import {
  calculateSubtotal,
  calculateInvoiceTotal,
  getDueDate,
  formatCurrency,
} from '@/lib/helpers/billing'
import { Plus, Loader2 } from 'lucide-react'
import type { Resolver } from 'react-hook-form'

interface CreateInvoiceDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  defaultClientId?: string
}

interface LineItemData {
  description: string
  quantity: number
  unit_price: number
  line_type?: string
}

export function CreateInvoiceDialog({
  open,
  onOpenChange,
  defaultClientId,
}: CreateInvoiceDialogProps) {
  const { toast } = useToast()
  const { data: clients } = useClients()
  const createInvoice = useCreateInvoice()

  const [lineItems, setLineItems] = useState<LineItemData[]>([
    { description: '', quantity: 1, unit_price: 0 },
  ])
  const [taxRate, setTaxRate] = useState(0)
  const [discountAmount, setDiscountAmount] = useState(0)

  const today = new Date().toISOString().split('T')[0]

  const {
    register,
    handleSubmit,
    watch,
    setValue,
    formState: { errors },
    reset,
  } = useForm<CreateInvoiceFormData>({
    resolver: zodResolver(createInvoiceSchema) as Resolver<CreateInvoiceFormData>,
    defaultValues: {
      client_id: defaultClientId || '',
      invoice_type: 'service',
      invoice_date: today,
      due_date: getDueDate(today, 30),
      terms: DEFAULT_INVOICE_TERMS,
      line_items: [],
    },
  })

  const invoiceDate = watch('invoice_date')

  // Calculate totals
  const subtotal = calculateSubtotal(lineItems)
  const { taxAmount, total } = calculateInvoiceTotal(subtotal, taxRate, discountAmount)

  const handleAddLineItem = () => {
    setLineItems([...lineItems, { description: '', quantity: 1, unit_price: 0 }])
  }

  const handleLineItemChange = (
    index: number,
    field: keyof LineItemData,
    value: string | number
  ) => {
    const updated = [...lineItems]
    updated[index] = { ...updated[index], [field]: value }
    setLineItems(updated)
  }

  const handleRemoveLineItem = (index: number) => {
    if (lineItems.length === 1) return
    setLineItems(lineItems.filter((_, i) => i !== index))
  }

  const handleDueDatePreset = (days: number) => {
    setValue('due_date', getDueDate(invoiceDate, days))
  }

  const onSubmit = async (data: CreateInvoiceFormData) => {
    try {
      // Validate line items
      const validLineItems = lineItems.filter(
        (item) => item.description && item.quantity > 0 && item.unit_price >= 0
      )
      if (validLineItems.length === 0) {
        toast({
          title: 'Error',
          description: 'Please add at least one line item',
          variant: 'destructive',
        })
        return
      }

      await createInvoice.mutateAsync({
        ...data,
        tax_rate: taxRate,
        discount_amount: discountAmount,
        line_items: validLineItems,
      })

      toast({
        title: 'Invoice Created',
        description: 'Invoice has been created as a draft',
      })

      reset()
      setLineItems([{ description: '', quantity: 1, unit_price: 0 }])
      setTaxRate(0)
      setDiscountAmount(0)
      onOpenChange(false)
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to create invoice',
        variant: 'destructive',
      })
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Create Invoice</DialogTitle>
          <DialogDescription>
            Create a new invoice for a client
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          {/* Client & Type */}
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label>Client</Label>
              <Select
                value={watch('client_id')}
                onValueChange={(value) => setValue('client_id', value)}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Select client" />
                </SelectTrigger>
                <SelectContent>
                  {clients?.map((client) => (
                    <SelectItem key={client.id} value={client.id}>
                      {client.company_name ||
                        `${client.first_name} ${client.last_name}`}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              {errors.client_id && (
                <p className="text-sm text-destructive">{errors.client_id.message}</p>
              )}
            </div>

            <div className="space-y-2">
              <Label>Invoice Type</Label>
              <Select
                value={watch('invoice_type')}
                onValueChange={(value: 'subscription' | 'service' | 'mixed') =>
                  setValue('invoice_type', value)
                }
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {INVOICE_TYPES.map((type) => (
                    <SelectItem key={type.value} value={type.value}>
                      {type.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>

          {/* Dates */}
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label>Invoice Date</Label>
              <Input type="date" {...register('invoice_date')} />
            </div>

            <div className="space-y-2">
              <Label>Due Date</Label>
              <Input type="date" {...register('due_date')} />
              <div className="flex gap-2 mt-1">
                {DUE_DATE_OPTIONS.map((option) => (
                  <Button
                    key={option.value}
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => handleDueDatePreset(option.value)}
                  >
                    {option.label}
                  </Button>
                ))}
              </div>
            </div>
          </div>

          {/* Line Items */}
          <div className="space-y-2">
            <Label>Line Items</Label>
            <div className="border rounded-lg p-4">
              <div className="flex items-center gap-2 pb-2 border-b text-sm font-medium text-muted-foreground">
                <div className="flex-1">Description</div>
                <div className="w-24">Type</div>
                <div className="w-20">Qty</div>
                <div className="w-28">Price</div>
                <div className="w-24 text-right">Amount</div>
                <div className="w-10" />
              </div>

              {lineItems.map((item, index) => (
                <InvoiceLineItemRow
                  key={index}
                  item={item}
                  index={index}
                  onChange={handleLineItemChange}
                  onRemove={handleRemoveLineItem}
                />
              ))}

              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={handleAddLineItem}
                className="mt-2"
              >
                <Plus className="h-4 w-4 mr-1" />
                Add Line Item
              </Button>
            </div>
          </div>

          {/* Totals */}
          <div className="flex justify-end">
            <div className="w-64 space-y-2">
              <div className="flex justify-between">
                <span>Subtotal:</span>
                <span>{formatCurrency(subtotal)}</span>
              </div>

              <div className="flex items-center justify-between gap-2">
                <span>Tax %:</span>
                <Input
                  type="number"
                  min="0"
                  max="100"
                  step="0.1"
                  className="w-20"
                  value={taxRate * 100}
                  onChange={(e) => setTaxRate(parseFloat(e.target.value) / 100 || 0)}
                />
                <span className="w-20 text-right">{formatCurrency(taxAmount)}</span>
              </div>

              <div className="flex items-center justify-between gap-2">
                <span>Discount:</span>
                <Input
                  type="number"
                  min="0"
                  step="0.01"
                  className="w-20"
                  value={discountAmount}
                  onChange={(e) => setDiscountAmount(parseFloat(e.target.value) || 0)}
                />
                <span className="w-20 text-right">-{formatCurrency(discountAmount)}</span>
              </div>

              <div className="flex justify-between text-lg font-bold pt-2 border-t">
                <span>Total:</span>
                <span>{formatCurrency(total)}</span>
              </div>
            </div>
          </div>

          {/* Notes & Terms */}
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label>Notes</Label>
              <Textarea
                {...register('notes')}
                placeholder="Additional notes for the client"
                rows={3}
              />
            </div>

            <div className="space-y-2">
              <Label>Payment Terms</Label>
              <Textarea {...register('terms')} rows={3} />
            </div>
          </div>

          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={createInvoice.isPending}>
              {createInvoice.isPending && (
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              )}
              Create Draft
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

### 5. Create record payment dialog (`apps/admin/src/components/billing/record-payment-dialog.tsx`)

```typescript
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { useRecordPayment } from '@/hooks/use-payments'
import { useToast } from '@/hooks/use-toast'
import { recordPaymentSchema, type RecordPaymentFormData } from '@/lib/validations/billing'
import { PAYMENT_METHODS } from '@/lib/constants/billing'
import { formatCurrency } from '@/lib/helpers/billing'
import { Loader2 } from 'lucide-react'
import type { Resolver } from 'react-hook-form'

interface RecordPaymentDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  invoiceId: string
  invoiceNumber: string
  balanceDue: number
}

export function RecordPaymentDialog({
  open,
  onOpenChange,
  invoiceId,
  invoiceNumber,
  balanceDue,
}: RecordPaymentDialogProps) {
  const { toast } = useToast()
  const recordPayment = useRecordPayment()

  const today = new Date().toISOString().split('T')[0]

  const {
    register,
    handleSubmit,
    watch,
    setValue,
    formState: { errors },
    reset,
  } = useForm<RecordPaymentFormData>({
    resolver: zodResolver(recordPaymentSchema) as Resolver<RecordPaymentFormData>,
    defaultValues: {
      invoice_id: invoiceId,
      amount: balanceDue,
      payment_method: 'check',
      payment_date: today,
    },
  })

  const paymentMethod = watch('payment_method')

  const onSubmit = async (data: RecordPaymentFormData) => {
    try {
      await recordPayment.mutateAsync(data)

      toast({
        title: 'Payment Recorded',
        description: `Payment of ${formatCurrency(data.amount)} has been recorded`,
      })

      reset()
      onOpenChange(false)
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to record payment',
        variant: 'destructive',
      })
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Record Payment</DialogTitle>
          <DialogDescription>
            Record a payment for invoice {invoiceNumber}
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <div className="p-4 bg-muted rounded-lg">
            <p className="text-sm text-muted-foreground">Balance Due</p>
            <p className="text-2xl font-bold">{formatCurrency(balanceDue)}</p>
          </div>

          <div className="space-y-2">
            <Label>Amount</Label>
            <Input
              type="number"
              min="0.01"
              step="0.01"
              max={balanceDue}
              {...register('amount', { valueAsNumber: true })}
            />
            {errors.amount && (
              <p className="text-sm text-destructive">{errors.amount.message}</p>
            )}
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={() => setValue('amount', balanceDue)}
            >
              Pay in Full
            </Button>
          </div>

          <div className="space-y-2">
            <Label>Payment Method</Label>
            <Select
              value={paymentMethod}
              onValueChange={(value: RecordPaymentFormData['payment_method']) =>
                setValue('payment_method', value)
              }
            >
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                {PAYMENT_METHODS.map((method) => (
                  <SelectItem key={method.value} value={method.value}>
                    {method.label}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-2">
            <Label>Payment Date</Label>
            <Input type="date" {...register('payment_date')} />
          </div>

          {paymentMethod === 'check' && (
            <div className="space-y-2">
              <Label>Check Number</Label>
              <Input {...register('check_number')} placeholder="Check #" />
            </div>
          )}

          {paymentMethod === 'card' && (
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Last 4 Digits</Label>
                <Input
                  {...register('last_four')}
                  placeholder="1234"
                  maxLength={4}
                />
              </div>
              <div className="space-y-2">
                <Label>Card Brand</Label>
                <Input {...register('card_brand')} placeholder="Visa" />
              </div>
            </div>
          )}

          <div className="space-y-2">
            <Label>Notes</Label>
            <Textarea {...register('notes')} placeholder="Optional notes" rows={2} />
          </div>

          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={recordPayment.isPending}>
              {recordPayment.isPending && (
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              )}
              Record Payment
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

### 6. Create payment link button (`apps/admin/src/components/billing/payment-link-button.tsx`)

```typescript
import { Button } from '@/components/ui/button'
import { useCreatePaymentLink, openPaymentLink } from '@/hooks/use-stripe'
import { useToast } from '@/hooks/use-toast'
import { CreditCard, Loader2, Copy, ExternalLink } from 'lucide-react'
import { useState } from 'react'

interface PaymentLinkButtonProps {
  invoiceId: string
  variant?: 'default' | 'outline' | 'secondary'
  size?: 'default' | 'sm' | 'lg'
}

export function PaymentLinkButton({
  invoiceId,
  variant = 'default',
  size = 'default',
}: PaymentLinkButtonProps) {
  const { toast } = useToast()
  const createPaymentLink = useCreatePaymentLink()
  const [paymentUrl, setPaymentUrl] = useState<string | null>(null)

  const handleCreate = async () => {
    try {
      const result = await createPaymentLink.mutateAsync({ invoiceId })
      setPaymentUrl(result.url)
      openPaymentLink(result.url)
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to create payment link',
        variant: 'destructive',
      })
    }
  }

  const handleCopy = async () => {
    if (paymentUrl) {
      await navigator.clipboard.writeText(paymentUrl)
      toast({
        title: 'Copied',
        description: 'Payment link copied to clipboard',
      })
    }
  }

  if (paymentUrl) {
    return (
      <div className="flex gap-2">
        <Button variant="outline" size={size} onClick={handleCopy}>
          <Copy className="h-4 w-4 mr-1" />
          Copy Link
        </Button>
        <Button variant={variant} size={size} onClick={() => openPaymentLink(paymentUrl)}>
          <ExternalLink className="h-4 w-4 mr-1" />
          Open
        </Button>
      </div>
    )
  }

  return (
    <Button
      variant={variant}
      size={size}
      onClick={handleCreate}
      disabled={createPaymentLink.isPending}
    >
      {createPaymentLink.isPending ? (
        <Loader2 className="h-4 w-4 mr-1 animate-spin" />
      ) : (
        <CreditCard className="h-4 w-4 mr-1" />
      )}
      Pay Online
    </Button>
  )
}
```

### 7. Create send invoice dialog (`apps/admin/src/components/billing/send-invoice-dialog.tsx`)

```typescript
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { useSendInvoice } from '@/hooks/use-invoices'
import { useToast } from '@/hooks/use-toast'
import { sendInvoiceSchema, type SendInvoiceFormData } from '@/lib/validations/billing'
import { Loader2, Send } from 'lucide-react'
import type { Resolver } from 'react-hook-form'

interface SendInvoiceDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  invoiceId: string
  invoiceNumber: string
  clientEmail: string | null
  clientName: string
}

export function SendInvoiceDialog({
  open,
  onOpenChange,
  invoiceId,
  invoiceNumber,
  clientEmail,
  clientName,
}: SendInvoiceDialogProps) {
  const { toast } = useToast()
  const sendInvoice = useSendInvoice()

  const {
    register,
    handleSubmit,
    formState: { errors },
    reset,
  } = useForm<SendInvoiceFormData>({
    resolver: zodResolver(sendInvoiceSchema) as Resolver<SendInvoiceFormData>,
    defaultValues: {
      invoice_id: invoiceId,
      email: clientEmail || '',
      subject: `Invoice ${invoiceNumber} from Ross Built Home Services`,
      message: `Dear ${clientName},\n\nPlease find attached invoice ${invoiceNumber}.\n\nYou can pay online using the secure payment link in the invoice.\n\nThank you for your business.\n\nRoss Built Home Services`,
    },
  })

  const onSubmit = async (data: SendInvoiceFormData) => {
    try {
      await sendInvoice.mutateAsync({
        id: invoiceId,
        email: data.email,
      })

      toast({
        title: 'Invoice Sent',
        description: `Invoice sent to ${data.email}`,
      })

      reset()
      onOpenChange(false)
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to send invoice',
        variant: 'destructive',
      })
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Send Invoice</DialogTitle>
          <DialogDescription>
            Send invoice {invoiceNumber} to the client
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <div className="space-y-2">
            <Label>Email Address</Label>
            <Input
              type="email"
              {...register('email')}
              placeholder="client@example.com"
            />
            {errors.email && (
              <p className="text-sm text-destructive">{errors.email.message}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label>Subject</Label>
            <Input {...register('subject')} />
          </div>

          <div className="space-y-2">
            <Label>Message</Label>
            <Textarea {...register('message')} rows={6} />
          </div>

          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={sendInvoice.isPending}>
              {sendInvoice.isPending ? (
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              ) : (
                <Send className="h-4 w-4 mr-2" />
              )}
              Send Invoice
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

## Files Created

- `apps/admin/src/components/billing/invoice-status-badge.tsx`
- `apps/admin/src/components/billing/invoice-card.tsx`
- `apps/admin/src/components/billing/invoice-line-item-row.tsx`
- `apps/admin/src/components/billing/create-invoice-dialog.tsx`
- `apps/admin/src/components/billing/record-payment-dialog.tsx`
- `apps/admin/src/components/billing/payment-link-button.tsx`
- `apps/admin/src/components/billing/send-invoice-dialog.tsx`

## Checkpoint

After completion:
- [ ] All components render without errors
- [ ] Form validation works correctly
- [ ] Dialogs open and close properly
- [ ] Line items calculate correctly
- [ ] Commit: `feat(billing): add invoice UI components - badges, cards, dialogs`

## Notes

- InvoiceStatusBadge uses existing Badge variants
- CreateInvoiceDialog includes real-time total calculation
- RecordPaymentDialog shows conditional fields based on payment method
- PaymentLinkButton handles Stripe integration state
- SendInvoiceDialog pre-fills with client email and template message
