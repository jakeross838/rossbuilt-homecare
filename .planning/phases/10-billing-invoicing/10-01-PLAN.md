# Plan 10-01: Billing Data Foundation

## Objective

Create TypeScript types, constants, and validation schemas for billing, invoices, and payments. This establishes the data layer for the entire billing system.

## Wave

**Wave 1** - No dependencies (can run parallel with 10-02, 10-03)

## Dependencies

- Phase 9 Complete (work orders can be invoiced)
- Existing database schema (012_invoices.sql)

## Must-Haves

- [ ] Invoice types matching database schema
- [ ] Payment types matching database schema
- [ ] Invoice status constants with workflow transitions
- [ ] Invoice line type constants
- [ ] Payment method constants
- [ ] Validation schemas for invoice creation
- [ ] Validation schemas for payment recording
- [ ] Helper functions for invoice calculations

## Tasks

### 1. Create billing types (`apps/admin/src/lib/types/billing.ts`)

```typescript
import type { Enums, Tables } from '@/lib/supabase'

// Invoice status from database enum
export type InvoiceStatus = Enums<'invoice_status'>

// Invoice from database
export type Invoice = Tables<'invoices'>
export type InvoiceLineItem = Tables<'invoice_line_items'>
export type Payment = Tables<'payments'>

// Invoice with relations for display
export interface InvoiceWithRelations extends Invoice {
  client?: {
    id: string
    first_name: string
    last_name: string
    email: string | null
    company_name: string | null
  }
  line_items?: InvoiceLineItem[]
  payments?: Payment[]
}

// Invoice list item for list views
export interface InvoiceListItem {
  id: string
  invoice_number: string
  invoice_type: string
  invoice_date: string
  due_date: string
  total: number
  balance_due: number
  status: InvoiceStatus
  client_name: string
  client_email: string | null
  property_count: number
}

// Line item types
export type LineItemType = 'subscription' | 'addon' | 'service' | 'work_order' | 'materials' | 'other'
export type ReferenceType = 'program' | 'work_order' | 'service_request'

// Payment method types
export type PaymentMethod = 'card' | 'ach' | 'check' | 'cash' | 'other'

// Create invoice data
export interface CreateInvoiceData {
  client_id: string
  invoice_type: 'subscription' | 'service' | 'mixed'
  invoice_date: string
  due_date: string
  period_start?: string
  period_end?: string
  tax_rate?: number
  discount_amount?: number
  discount_description?: string
  notes?: string
  terms?: string
  line_items: CreateLineItemData[]
}

// Create line item data
export interface CreateLineItemData {
  description: string
  quantity: number
  unit_price: number
  line_type?: LineItemType
  reference_type?: ReferenceType
  reference_id?: string
  property_id?: string
}

// Record payment data
export interface RecordPaymentData {
  invoice_id: string
  amount: number
  payment_method: PaymentMethod
  payment_date?: string
  last_four?: string
  card_brand?: string
  check_number?: string
  notes?: string
}

// Invoice filter options
export interface InvoiceFilters {
  status?: InvoiceStatus[]
  client_id?: string
  invoice_type?: string
  date_from?: string
  date_to?: string
  overdue_only?: boolean
  search?: string
}

// Invoice summary for dashboard
export interface InvoiceSummary {
  total_outstanding: number
  total_overdue: number
  invoices_sent: number
  invoices_paid_this_month: number
  average_days_to_pay: number
}
```

### 2. Create billing constants (`apps/admin/src/lib/constants/billing.ts`)

```typescript
// Invoice status configuration
export const INVOICE_STATUS_CONFIG = {
  draft: {
    label: 'Draft',
    description: 'Not yet sent to client',
    color: 'gray',
    variant: 'secondary' as const,
    allowedTransitions: ['sent', 'void'],
    canEdit: true,
    canDelete: true,
  },
  sent: {
    label: 'Sent',
    description: 'Sent to client, awaiting payment',
    color: 'blue',
    variant: 'default' as const,
    allowedTransitions: ['viewed', 'paid', 'partial', 'overdue', 'void'],
    canEdit: false,
    canDelete: false,
  },
  viewed: {
    label: 'Viewed',
    description: 'Client has viewed the invoice',
    color: 'purple',
    variant: 'default' as const,
    allowedTransitions: ['paid', 'partial', 'overdue', 'void'],
    canEdit: false,
    canDelete: false,
  },
  paid: {
    label: 'Paid',
    description: 'Payment received in full',
    color: 'green',
    variant: 'success' as const,
    allowedTransitions: ['void'],
    canEdit: false,
    canDelete: false,
  },
  partial: {
    label: 'Partial',
    description: 'Partial payment received',
    color: 'yellow',
    variant: 'warning' as const,
    allowedTransitions: ['paid', 'overdue', 'void'],
    canEdit: false,
    canDelete: false,
  },
  overdue: {
    label: 'Overdue',
    description: 'Past due date without full payment',
    color: 'red',
    variant: 'destructive' as const,
    allowedTransitions: ['paid', 'partial', 'void'],
    canEdit: false,
    canDelete: false,
  },
  void: {
    label: 'Void',
    description: 'Cancelled, no longer valid',
    color: 'gray',
    variant: 'outline' as const,
    allowedTransitions: [],
    canEdit: false,
    canDelete: false,
  },
} as const

// Invoice types
export const INVOICE_TYPES = [
  { value: 'subscription', label: 'Subscription', description: 'Monthly program fees' },
  { value: 'service', label: 'Service', description: 'One-time services or work orders' },
  { value: 'mixed', label: 'Mixed', description: 'Subscription + additional services' },
] as const

// Line item types
export const LINE_ITEM_TYPES = [
  { value: 'subscription', label: 'Subscription' },
  { value: 'addon', label: 'Add-on' },
  { value: 'service', label: 'Service' },
  { value: 'work_order', label: 'Work Order' },
  { value: 'materials', label: 'Materials' },
  { value: 'other', label: 'Other' },
] as const

// Payment methods
export const PAYMENT_METHODS = [
  { value: 'card', label: 'Credit/Debit Card', icon: 'CreditCard' },
  { value: 'ach', label: 'Bank Transfer (ACH)', icon: 'Building' },
  { value: 'check', label: 'Check', icon: 'FileText' },
  { value: 'cash', label: 'Cash', icon: 'Banknote' },
  { value: 'other', label: 'Other', icon: 'MoreHorizontal' },
] as const

// Card brands
export const CARD_BRANDS = [
  'visa',
  'mastercard',
  'amex',
  'discover',
  'other',
] as const

// Default payment terms (days)
export const DEFAULT_PAYMENT_TERMS = 30

// Default tax rate (as decimal, e.g., 0.07 for 7%)
export const DEFAULT_TAX_RATE = 0

// Invoice number prefix
export const INVOICE_NUMBER_PREFIX = 'INV-'

// Due date options
export const DUE_DATE_OPTIONS = [
  { value: 0, label: 'Due on receipt' },
  { value: 15, label: 'Net 15' },
  { value: 30, label: 'Net 30' },
  { value: 45, label: 'Net 45' },
  { value: 60, label: 'Net 60' },
] as const

// Invoice terms template
export const DEFAULT_INVOICE_TERMS = `Payment is due within 30 days of invoice date.
Late payments may be subject to a 1.5% monthly finance charge.
Please make checks payable to Ross Built Home Services.`

// Invoice status order for sorting
export const INVOICE_STATUS_ORDER: Record<string, number> = {
  overdue: 0,
  sent: 1,
  viewed: 2,
  partial: 3,
  draft: 4,
  paid: 5,
  void: 6,
}
```

### 3. Create billing validation schemas (`apps/admin/src/lib/validations/billing.ts`)

```typescript
import { z } from 'zod'

// Line item schema
export const lineItemSchema = z.object({
  description: z.string().min(1, 'Description is required'),
  quantity: z.coerce.number().min(0.01, 'Quantity must be greater than 0'),
  unit_price: z.coerce.number().min(0, 'Unit price must be 0 or greater'),
  line_type: z.enum(['subscription', 'addon', 'service', 'work_order', 'materials', 'other']).optional(),
  reference_type: z.enum(['program', 'work_order', 'service_request']).optional(),
  reference_id: z.string().uuid().optional(),
  property_id: z.string().uuid().optional(),
})

// Create invoice schema
export const createInvoiceSchema = z.object({
  client_id: z.string().uuid('Invalid client'),
  invoice_type: z.enum(['subscription', 'service', 'mixed']),
  invoice_date: z.string().min(1, 'Invoice date is required'),
  due_date: z.string().min(1, 'Due date is required'),
  period_start: z.string().optional(),
  period_end: z.string().optional(),
  tax_rate: z.coerce.number().min(0).max(1).optional(),
  discount_amount: z.coerce.number().min(0).optional(),
  discount_description: z.string().optional(),
  notes: z.string().optional(),
  terms: z.string().optional(),
  line_items: z.array(lineItemSchema).min(1, 'At least one line item is required'),
})

// Update invoice schema (draft only)
export const updateInvoiceSchema = createInvoiceSchema.partial()

// Record payment schema
export const recordPaymentSchema = z.object({
  invoice_id: z.string().uuid('Invalid invoice'),
  amount: z.coerce.number().min(0.01, 'Amount must be greater than 0'),
  payment_method: z.enum(['card', 'ach', 'check', 'cash', 'other']),
  payment_date: z.string().optional(),
  last_four: z.string().length(4).optional(),
  card_brand: z.string().optional(),
  check_number: z.string().optional(),
  notes: z.string().optional(),
})

// Send invoice schema
export const sendInvoiceSchema = z.object({
  invoice_id: z.string().uuid(),
  email: z.string().email('Invalid email address'),
  subject: z.string().optional(),
  message: z.string().optional(),
})

// Types
export type LineItemFormData = z.infer<typeof lineItemSchema>
export type CreateInvoiceFormData = z.infer<typeof createInvoiceSchema>
export type UpdateInvoiceFormData = z.infer<typeof updateInvoiceSchema>
export type RecordPaymentFormData = z.infer<typeof recordPaymentSchema>
export type SendInvoiceFormData = z.infer<typeof sendInvoiceSchema>
```

### 4. Create billing helpers (`apps/admin/src/lib/helpers/billing.ts`)

```typescript
import type { InvoiceLineItem, CreateLineItemData, InvoiceStatus } from '@/lib/types/billing'
import { INVOICE_STATUS_CONFIG, DEFAULT_PAYMENT_TERMS } from '@/lib/constants/billing'

/**
 * Calculate line item amount
 */
export function calculateLineItemAmount(quantity: number, unitPrice: number): number {
  return Math.round(quantity * unitPrice * 100) / 100
}

/**
 * Calculate invoice subtotal from line items
 */
export function calculateSubtotal(lineItems: Array<{ quantity: number; unit_price: number }>): number {
  return lineItems.reduce((sum, item) => {
    return sum + calculateLineItemAmount(item.quantity, item.unit_price)
  }, 0)
}

/**
 * Calculate tax amount
 */
export function calculateTaxAmount(subtotal: number, taxRate: number): number {
  return Math.round(subtotal * taxRate * 100) / 100
}

/**
 * Calculate invoice total
 */
export function calculateInvoiceTotal(
  subtotal: number,
  taxRate: number = 0,
  discountAmount: number = 0
): { taxAmount: number; total: number } {
  const taxAmount = calculateTaxAmount(subtotal, taxRate)
  const total = Math.round((subtotal + taxAmount - discountAmount) * 100) / 100
  return { taxAmount, total: Math.max(0, total) }
}

/**
 * Calculate balance due
 */
export function calculateBalanceDue(total: number, amountPaid: number): number {
  return Math.round((total - amountPaid) * 100) / 100
}

/**
 * Get due date from invoice date and terms
 */
export function getDueDate(invoiceDate: string, terms: number = DEFAULT_PAYMENT_TERMS): string {
  const date = new Date(invoiceDate)
  date.setDate(date.getDate() + terms)
  return date.toISOString().split('T')[0]
}

/**
 * Check if invoice is overdue
 */
export function isInvoiceOverdue(dueDate: string, status: InvoiceStatus): boolean {
  if (status === 'paid' || status === 'void') return false
  const today = new Date()
  today.setHours(0, 0, 0, 0)
  const due = new Date(dueDate)
  due.setHours(0, 0, 0, 0)
  return due < today
}

/**
 * Get days until due / days overdue
 */
export function getDaysUntilDue(dueDate: string): number {
  const today = new Date()
  today.setHours(0, 0, 0, 0)
  const due = new Date(dueDate)
  due.setHours(0, 0, 0, 0)
  const diffTime = due.getTime() - today.getTime()
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24))
}

/**
 * Check if status transition is allowed
 */
export function canTransitionTo(currentStatus: InvoiceStatus, newStatus: InvoiceStatus): boolean {
  const config = INVOICE_STATUS_CONFIG[currentStatus]
  return config.allowedTransitions.includes(newStatus)
}

/**
 * Format currency for display
 */
export function formatCurrency(amount: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(amount)
}

/**
 * Format invoice number
 */
export function formatInvoiceNumber(sequenceNum: number): string {
  return `INV-${sequenceNum.toString().padStart(5, '0')}`
}

/**
 * Generate period description for subscription invoices
 */
export function getPeriodDescription(periodStart: string, periodEnd: string): string {
  const start = new Date(periodStart)
  const end = new Date(periodEnd)
  const startStr = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
  const endStr = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
  return `${startStr} - ${endStr}`
}
```

## Files Created

- `apps/admin/src/lib/types/billing.ts` - TypeScript types
- `apps/admin/src/lib/constants/billing.ts` - Constants and configuration
- `apps/admin/src/lib/validations/billing.ts` - Zod validation schemas
- `apps/admin/src/lib/helpers/billing.ts` - Calculation and formatting helpers

## Checkpoint

After completion:
- [ ] All type definitions compile without errors
- [ ] Constants export correctly
- [ ] Validation schemas parse valid data
- [ ] Helper functions calculate correctly
- [ ] Commit: `feat(billing): add billing data foundation - types, constants, validations, helpers`

## Notes

- Invoice status enum matches database exactly: draft, sent, viewed, paid, partial, overdue, void
- Tax rate stored as decimal (0.07 for 7%)
- All amounts stored in dollars with 2 decimal precision
- Line items support work order references for billing completed work
