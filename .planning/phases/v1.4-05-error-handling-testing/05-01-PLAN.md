---
phase: v1.4-05-error-handling-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/admin/src/App.tsx
  - apps/admin/src/lib/queries/config.ts
  - apps/admin/src/hooks/use-base-mutation.ts
autonomous: false

must_haves:
  truths:
    - "ErrorBoundary wraps QueryClientProvider (catches query-level errors)"
    - "Mutation errors logged to console with context (operation type, variables)"
    - "Query errors logged consistently across the app"
    - "User-friendly error messages displayed (never raw technical errors)"
    - "Two-tab sync works (change in Tab 1 appears in Tab 2 < 5 seconds)"
    - "Console shows no red errors during normal operation"
  artifacts:
    - path: "apps/admin/src/App.tsx"
      provides: "ErrorBoundary wrapping QueryClientProvider"
      contains: "ErrorBoundary"
    - path: "apps/admin/src/lib/queries/config.ts"
      provides: "Query error handler and retry config (retry: 1 for SYNC-10.4)"
      contains: "onError"
    - path: "apps/admin/src/hooks/use-base-mutation.ts"
      provides: "Enhanced error logging with context"
      contains: "console.error"
  key_links:
    - from: "apps/admin/src/App.tsx"
      to: "config.ts"
      via: "DEFAULT_QUERY_OPTIONS"
      pattern: "DEFAULT_QUERY_OPTIONS"
    - from: "use-base-mutation.ts"
      to: "toast"
      via: "error notification"
      pattern: "toast.*variant.*destructive"
---

<objective>
Finalize error handling enhancements and verify two-tab sync functionality.

Purpose: Complete v1.4 milestone by ensuring errors are caught gracefully and realtime sync works across browser tabs.
Output: Enhanced error logging configuration, verified two-tab sync, clean console during normal operation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS-v1.4.md

# Prior phase context
@.planning/phases/v1.4-04-pattern-templates/04-03-SUMMARY.md

# Key files to modify/reference
@apps/admin/src/App.tsx
@apps/admin/src/lib/queries/config.ts
@apps/admin/src/hooks/use-base-mutation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move ErrorBoundary to Wrap QueryClientProvider (SYNC-10.1)</name>
  <files>apps/admin/src/App.tsx</files>
  <action>
Move the ErrorBoundary to be the OUTERMOST component, wrapping QueryClientProvider.

**Current structure (WRONG):**
```typescript
<QueryClientProvider client={queryClient}>
  <AuthProvider>
    <PermissionProvider>
      <ErrorBoundary>
        <BrowserRouter>
          ...
        </BrowserRouter>
      </ErrorBoundary>
    </PermissionProvider>
  </AuthProvider>
</QueryClientProvider>
```

**Target structure (CORRECT):**
```typescript
<ErrorBoundary>
  <QueryClientProvider client={queryClient}>
    <AuthProvider>
      <PermissionProvider>
        <BrowserRouter>
          ...
        </BrowserRouter>
      </PermissionProvider>
    </AuthProvider>
  </QueryClientProvider>
</ErrorBoundary>
```

This ensures that any errors thrown by React Query (e.g., during query/mutation execution that propagate to React) are caught by the ErrorBoundary rather than crashing the entire app.
  </action>
  <verify>
1. Run `npm run build` - should compile without errors
2. Check App.tsx visually: ErrorBoundary should be the outermost component
3. App should still load and function normally
  </verify>
  <done>ErrorBoundary wraps QueryClientProvider, satisfying SYNC-10.1.</done>
</task>

<task type="auto">
  <name>Task 2: Add Global Query Error Handler</name>
  <files>apps/admin/src/lib/queries/config.ts</files>
  <action>
Add a global query error handler to DEFAULT_QUERY_OPTIONS in config.ts:

1. In `apps/admin/src/lib/queries/config.ts`:
   - Add a `queryErrorHandler` function that logs errors with context
   - Include error type, query key (if available), and timestamp
   - Format: `[Query Error] {timestamp} - {errorMessage}`
   - Only log in development mode (check `import.meta.env.DEV`)

2. Update DEFAULT_QUERY_OPTIONS to include the error handler and mutations section:
   ```typescript
   export const DEFAULT_QUERY_OPTIONS = {
     queries: {
       staleTime: STALE_STANDARD,
       gcTime: CACHE_STANDARD,
       retry: 1,  // SYNC-10.4: Retry mechanism already configured
       refetchOnWindowFocus: false,
     },
     mutations: {
       onError: (error: Error) => {
         if (import.meta.env.DEV) {
           console.error('[Query Error]', new Date().toISOString(), error.message)
         }
       }
     }
   }
   ```

**Note on SYNC-10.4 (Retry Mechanism):** The existing `retry: 1` configuration already satisfies the retry mechanism requirement. This provides one automatic retry on failure before surfacing the error, which is appropriate for network hiccups without being overly aggressive.
  </action>
  <verify>
1. Run `npm run build` - should compile without errors
2. Open browser console in dev mode
3. Trigger an error (e.g., disconnect network) - should see formatted error log
  </verify>
  <done>Global query error handler logs errors with timestamp in development mode. Retry mechanism (retry: 1) already in place for SYNC-10.4.</done>
</task>

<task type="auto">
  <name>Task 3: Enhance Mutation Error Logging</name>
  <files>apps/admin/src/hooks/use-base-mutation.ts</files>
  <action>
Enhance the mutation error logging to include more context:

1. In `useBaseMutation` onError handler (around line 79-92):
   - Add operation context (mutation name if provided via options)
   - Add timestamp to error log
   - Format: `[Mutation Error] {timestamp} - {operationType}: {errorMessage}`
   - Add the variables in a collapsed group for debugging

2. In `useOptimisticMutation` onError handler (around line 152-169):
   - Apply same enhanced logging pattern
   - Include info about the rollback occurring

Updated pattern:
```typescript
onError: (error, variables, context) => {
  // Log with context
  if (import.meta.env.DEV) {
    console.group(`[Mutation Error] ${new Date().toISOString()}`)
    console.error('Error:', (error as Error).message)
    console.log('Variables:', variables)
    console.groupEnd()
  }

  // Show user-friendly toast (existing code)
  toast({
    title: 'Error',
    description: errorMessage || (error as Error).message || 'An error occurred',
    variant: 'destructive',
  })

  // Call custom onError
  onError?.(error, variables, context)
}
```

For optimistic mutation, add before rollback:
```typescript
if (import.meta.env.DEV) {
  console.group(`[Mutation Error - Rolling back] ${new Date().toISOString()}`)
  console.error('Error:', (error as Error).message)
  console.log('Variables:', variables)
  console.log('Rolling back to previous state')
  console.groupEnd()
}
```
  </action>
  <verify>
1. Run `npm run build` - should compile without errors
2. Trigger a mutation error in dev mode
3. Console should show grouped error log with timestamp, message, and variables
  </verify>
  <done>Mutation errors logged with enhanced context including timestamp, message, variables, and rollback indicator.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Two-Tab Sync Verification</name>
  <what-built>
Enhanced error handling and complete v1.4 sync infrastructure:
- ErrorBoundary now wraps QueryClientProvider (SYNC-10.1)
- Global query error handler in config.ts
- Enhanced mutation error logging with context
- Retry mechanism via retry:1 (SYNC-10.4)
- Realtime sync via Supabase postgres_changes (from prior phases)
- Optimistic UI with rollback (from Phase 4)
  </what-built>
  <how-to-verify>
**Two-Tab Sync Test:**

1. Start the dev server: `cd apps/admin && npm run dev`
2. Open http://localhost:5173 in Tab 1
3. Login as admin user
4. Open http://localhost:5173 in Tab 2 (same browser)
5. Navigate to Clients page in both tabs

**Test A: Client Update Sync**
- In Tab 1: Edit a client's name
- Click Save
- Observe Tab 2: The updated name should appear within 5 seconds
- Expected: Name updates in Tab 2 without refresh

**Test B: Create New Record Sync**
- In Tab 1: Create a new client
- Observe Tab 2: New client should appear in the list within 5 seconds
- Expected: New client shows in Tab 2 without refresh

**Test C: Error Handling**
- Open browser DevTools Console in both tabs
- During normal operation (navigate around, view pages)
- Expected: No red errors in console
- Check: Mutation errors (if any) should show formatted logs

**Test D: Console Cleanliness**
- Navigate to: Dashboard, Clients, Properties, Calendar, Inspections
- Check console for red errors
- Expected: Console clean (warnings OK, no errors)

**Report Results:**
- Two-tab sync working: YES/NO
- Sync latency: <5 seconds / >5 seconds
- Console clean: YES/NO (list any errors)
  </how-to-verify>
  <resume-signal>Report test results. Type "approved" if all tests pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
## Phase Verification

After checkpoint approval:
- [ ] ErrorBoundary wraps QueryClientProvider (SYNC-10.1)
- [ ] Global error handler added to query config
- [ ] Mutation error logging enhanced with context
- [ ] Retry mechanism in place (retry: 1 satisfies SYNC-10.4)
- [ ] Two-tab sync verified working (< 5 seconds)
- [ ] Console shows no red errors during normal operation
- [ ] TypeScript compiles with no errors
- [ ] Production build succeeds
</verification>

<success_criteria>
1. ErrorBoundary is the outermost component, wrapping QueryClientProvider
2. Mutation errors logged to console with timestamp, message, variables
3. Query errors handled gracefully with user-friendly messages
4. Retry mechanism configured (retry: 1)
5. Two-tab sync test passes (change appears in < 5 seconds)
6. Console shows no red errors during normal navigation
7. Production build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/v1.4-05-error-handling-testing/05-01-SUMMARY.md`
</output>
