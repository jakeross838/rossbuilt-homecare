---
phase: 07-inspector-mobile
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/admin/vite.config.ts
  - apps/admin/public/manifest.json
  - apps/admin/public/sw.js
  - apps/admin/src/lib/pwa.ts
  - apps/admin/index.html
autonomous: true
must_haves:
  truths:
    - "App can be installed as PWA on mobile device"
    - "Service worker registers successfully"
    - "Manifest defines app name, icons, and display mode"
  artifacts:
    - path: "apps/admin/public/manifest.json"
      provides: "PWA manifest with app metadata"
    - path: "apps/admin/public/sw.js"
      provides: "Service worker for offline capability"
    - path: "apps/admin/src/lib/pwa.ts"
      provides: "PWA registration and update utilities"
  key_links:
    - from: "index.html"
      to: "manifest.json"
      via: "link rel=manifest"
    - from: "pwa.ts"
      to: "sw.js"
      via: "navigator.serviceWorker.register"
---

<objective>
Set up PWA foundation with manifest, service worker, and Vite PWA plugin configuration.

Purpose: Enable the app to be installed on mobile devices and work offline.
Output: PWA configuration that passes Lighthouse PWA audit.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing Vite config
@apps/admin/vite.config.ts
@apps/admin/index.html
@apps/admin/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vite-plugin-pwa and create manifest</name>
  <files>apps/admin/package.json, apps/admin/public/manifest.json</files>
  <action>
1. Install vite-plugin-pwa:
   ```bash
   cd apps/admin && npm install vite-plugin-pwa -D
   ```

2. Create apps/admin/public/manifest.json:
```json
{
  "name": "Ross Built Home Care",
  "short_name": "Ross Built",
  "description": "Home care management for luxury properties",
  "theme_color": "#2D5A27",
  "background_color": "#ffffff",
  "display": "standalone",
  "scope": "/",
  "start_url": "/",
  "orientation": "portrait",
  "icons": [
    {
      "src": "/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "maskable"
    }
  ]
}
```

3. Create placeholder icons in apps/admin/public/icons/ (192x192 and 512x512 PNG files).
   Use simple green (#2D5A27) squares with "RB" text as placeholders.
  </action>
  <verify>manifest.json exists and is valid JSON</verify>
  <done>PWA manifest created with Ross Built branding</done>
</task>

<task type="auto">
  <name>Task 2: Configure Vite PWA plugin</name>
  <files>apps/admin/vite.config.ts</files>
  <action>
Update vite.config.ts to include PWA plugin:

```ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'
import path from 'path'

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'prompt', // Show update prompt instead of auto-update
      includeAssets: ['favicon.ico', 'icons/*.png'],
      manifest: false, // Use our own manifest.json
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/.*\.supabase\.co\/.*/i,
            handler: 'NetworkFirst',
            options: {
              cacheName: 'supabase-api',
              expiration: {
                maxEntries: 100,
                maxAgeSeconds: 60 * 60, // 1 hour
              },
              networkTimeoutSeconds: 10,
            },
          },
        ],
      },
      devOptions: {
        enabled: true, // Enable PWA in dev mode for testing
      },
    }),
  ],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
})
```

Key configuration:
- registerType: 'prompt' - lets user choose when to update
- NetworkFirst for Supabase API - try network, fall back to cache
- Enable in dev mode for easier testing
  </action>
  <verify>npm run build completes without errors</verify>
  <done>Vite PWA plugin configured with caching strategy</done>
</task>

<task type="auto">
  <name>Task 3: Create PWA utilities and update index.html</name>
  <files>apps/admin/src/lib/pwa.ts, apps/admin/index.html</files>
  <action>
1. Create apps/admin/src/lib/pwa.ts:

```ts
import { registerSW } from 'virtual:pwa-register'

export interface PWAUpdateState {
  needRefresh: boolean
  offlineReady: boolean
  updateServiceWorker: (reloadPage?: boolean) => Promise<void>
}

let updateSW: ((reloadPage?: boolean) => Promise<void>) | undefined

export function registerPWA(
  onNeedRefresh: () => void,
  onOfflineReady: () => void
): () => void {
  updateSW = registerSW({
    onNeedRefresh() {
      onNeedRefresh()
    },
    onOfflineReady() {
      onOfflineReady()
    },
    onRegistered(registration) {
      console.log('SW registered:', registration)
    },
    onRegisterError(error) {
      console.error('SW registration error:', error)
    },
  })

  return () => {
    // Cleanup function
  }
}

export function updateServiceWorker(reloadPage = true): Promise<void> {
  if (updateSW) {
    return updateSW(reloadPage)
  }
  return Promise.resolve()
}

export function isPWAInstalled(): boolean {
  return window.matchMedia('(display-mode: standalone)').matches
}

export function canInstallPWA(): boolean {
  // Check if beforeinstallprompt event is available
  return 'BeforeInstallPromptEvent' in window
}
```

2. Update apps/admin/index.html to include manifest link:

Add inside <head>:
```html
<link rel="manifest" href="/manifest.json" />
<meta name="theme-color" content="#2D5A27" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="Ross Built" />
<link rel="apple-touch-icon" href="/icons/icon-192.png" />
```

3. Add virtual:pwa-register types. Create apps/admin/src/vite-env.d.ts if not exists, add:
```ts
/// <reference types="vite-plugin-pwa/client" />
```
  </action>
  <verify>TypeScript compiles: cd apps/admin && npx tsc --noEmit</verify>
  <done>PWA utilities created and index.html updated with meta tags</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd apps/admin && npm run build` succeeds
- [ ] manifest.json is valid and accessible at /manifest.json
- [ ] Service worker generates in dist/sw.js
- [ ] TypeScript compiles without errors
- [ ] PWA utilities export correctly
</verification>

<success_criteria>
- All tasks completed
- vite-plugin-pwa installed and configured
- Manifest with Ross Built branding
- Service worker with Supabase API caching
- PWA utilities for registration and updates
</success_criteria>

<output>
After completion, create `.planning/phases/07-inspector-mobile/07-01-SUMMARY.md`
</output>
