---
phase: v1.4-01-query-configuration
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/admin/src/App.tsx
  - apps/admin/src/hooks/use-portal-dashboard.ts
  - apps/admin/src/hooks/use-activity-log.ts
  - apps/admin/src/hooks/use-notifications.ts
  - apps/admin/src/hooks/use-notification-preferences.ts
  - apps/admin/src/hooks/use-inspector-schedule.ts
  - apps/admin/src/hooks/use-checklist.ts
  - apps/admin/src/hooks/use-dashboard-overview.ts
  - apps/admin/src/hooks/use-dashboard-activity.ts
  - apps/admin/src/hooks/use-inspection-metrics.ts
  - apps/admin/src/hooks/use-work-order-metrics.ts
  - apps/admin/src/hooks/use-revenue-metrics.ts
  - apps/admin/src/components/portal/plan-editor/plan-editor.tsx
  - apps/admin/src/lib/constants/work-order.ts
  - apps/admin/src/components/billing/create-invoice-dialog.tsx
  - apps/admin/src/lib/validations/pricing.ts
  - apps/admin/src/lib/validations/program.ts
  - apps/admin/src/lib/validations/work-order.ts
autonomous: true

must_haves:
  truths:
    - "Zero hardcoded staleTime values in any hook"
    - "All hooks import cache timing from config"
    - "Pricing markup in plan-editor comes from config"
    - "Zero hardcoded 15% vendor markup values in codebase"
  artifacts:
    - path: "apps/admin/src/App.tsx"
      provides: "QueryClient with config-based defaults"
      contains: "DEFAULT_QUERY_OPTIONS"
    - path: "apps/admin/src/hooks/use-portal-dashboard.ts"
      provides: "Portal dashboard hook using config"
      contains: "STALE_STANDARD"
    - path: "apps/admin/src/components/portal/plan-editor/plan-editor.tsx"
      provides: "Plan editor using centralized markup"
      contains: "BUILDER_MARKUP"
    - path: "apps/admin/src/lib/constants/work-order.ts"
      provides: "Work order constants using centralized vendor markup"
      contains: "VENDOR_MARKUP"
  key_links:
    - from: "apps/admin/src/hooks/*"
      to: "apps/admin/src/lib/queries/config.ts"
      via: "import statement"
      pattern: "from '@/lib/queries/config'"
    - from: "apps/admin/src/components/portal/plan-editor/plan-editor.tsx"
      to: "apps/admin/src/config/app-config.ts"
      via: "import statement"
      pattern: "from '@/config/app-config'"
    - from: "apps/admin/src/lib/constants/work-order.ts"
      to: "apps/admin/src/config/app-config.ts"
      via: "import VENDOR_MARKUP"
      pattern: "from '@/config/app-config'"
---

<objective>
Migrate all hooks and components to use centralized configuration.

Purpose: Eliminate all hardcoded staleTime values and pricing markup. After this plan, all cache timing and business values come from the config files created in 01-01.

Output: Updated hooks and components importing from config files. Zero hardcoded magic numbers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@P:/Claude Projects/home-care-os/.planning/PROJECT.md
@P:/Claude Projects/home-care-os/.planning/ROADMAP.md
@P:/Claude Projects/home-care-os/.planning/REQUIREMENTS-v1.4.md

# Prior plan summary (depends on 01-01)
@P:/Claude Projects/home-care-os/.planning/phases/v1.4-01-query-configuration/01-01-SUMMARY.md

# Files to modify
@P:/Claude Projects/home-care-os/apps/admin/src/App.tsx
@P:/Claude Projects/home-care-os/apps/admin/src/hooks/use-portal-dashboard.ts
@P:/Claude Projects/home-care-os/apps/admin/src/components/portal/plan-editor/plan-editor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update App.tsx QueryClient Configuration</name>
  <files>apps/admin/src/App.tsx</files>
  <action>
Update App.tsx to use DEFAULT_QUERY_OPTIONS from config:

1. Add import at top:
```typescript
import { DEFAULT_QUERY_OPTIONS } from '@/lib/queries/config'
```

2. Replace the hardcoded QueryClient configuration:

BEFORE:
```typescript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5, // 5 minutes
      retry: 1,
      refetchOnWindowFocus: false,
    },
  },
})
```

AFTER:
```typescript
const queryClient = new QueryClient({
  defaultOptions: DEFAULT_QUERY_OPTIONS,
})
```

This centralizes the default query configuration.
  </action>
  <verify>
```bash
cd apps/admin && npx tsc --noEmit src/App.tsx
```
  </verify>
  <done>
- App.tsx imports DEFAULT_QUERY_OPTIONS from config
- No hardcoded staleTime in QueryClient initialization
  </done>
</task>

<task type="auto">
  <name>Task 2: Update All Hooks with Hardcoded staleTime</name>
  <files>
apps/admin/src/hooks/use-portal-dashboard.ts
apps/admin/src/hooks/use-activity-log.ts
apps/admin/src/hooks/use-notifications.ts
apps/admin/src/hooks/use-notification-preferences.ts
apps/admin/src/hooks/use-inspector-schedule.ts
apps/admin/src/hooks/use-checklist.ts
apps/admin/src/hooks/use-dashboard-overview.ts
apps/admin/src/hooks/use-dashboard-activity.ts
apps/admin/src/hooks/use-inspection-metrics.ts
apps/admin/src/hooks/use-work-order-metrics.ts
apps/admin/src/hooks/use-revenue-metrics.ts
  </files>
  <action>
For each hook file listed, make the following changes:

1. Add import at top of file:
```typescript
import { STALE_STANDARD, STALE_ACTIVITY, STALE_FAST } from '@/lib/queries/config'
```

2. Replace hardcoded staleTime values with constants:

| Old Value | New Constant | Used In |
|-----------|--------------|---------|
| `staleTime: 1000 * 60 * 5` | `staleTime: STALE_STANDARD` | Most hooks |
| `staleTime: 5 * 60 * 1000` | `staleTime: STALE_STANDARD` | Most hooks |
| `staleTime: 60 * 1000` | `staleTime: STALE_ACTIVITY` | Activity/dashboard hooks |
| `staleTime: 30 * 1000` | `staleTime: STALE_FAST` | Notifications |
| `staleTime: 15 * 1000` | `staleTime: STALE_FAST` | Notification count |

Specific files and their replacements:

**use-portal-dashboard.ts** (1 replacement):
- Line ~109: `staleTime: 1000 * 60 * 5` -> `staleTime: STALE_STANDARD`

**use-activity-log.ts** (1 replacement):
- Line ~82: `staleTime: 60 * 1000` -> `staleTime: STALE_ACTIVITY`

**use-notifications.ts** (3 replacements):
- Line ~68: `staleTime: 30 * 1000` -> `staleTime: STALE_FAST`
- Line ~91: `staleTime: 15 * 1000` -> `staleTime: STALE_FAST`
- Line ~124: `staleTime: 30 * 1000` -> `staleTime: STALE_FAST`

**use-notification-preferences.ts** (1 replacement):
- Line ~67: `staleTime: 5 * 60 * 1000` -> `staleTime: STALE_STANDARD`

**use-inspector-schedule.ts** (1 replacement):
- Line ~144: `staleTime: 1000 * 60 * 5` -> `staleTime: STALE_STANDARD`

**use-checklist.ts** (1 replacement):
- Line ~77: `staleTime: 5 * 60 * 1000` -> `staleTime: STALE_STANDARD`

**use-dashboard-overview.ts** (1 replacement):
- Line ~160: `staleTime: 5 * 60 * 1000` -> `staleTime: STALE_STANDARD`

**use-dashboard-activity.ts** (3 replacements):
- Line ~115: `staleTime: 60 * 1000` -> `staleTime: STALE_ACTIVITY`
- Line ~173: `staleTime: 5 * 60 * 1000` -> `staleTime: STALE_STANDARD`
- Line ~262: `staleTime: 5 * 60 * 1000` -> `staleTime: STALE_STANDARD`

**use-inspection-metrics.ts** (4 replacements):
- Lines ~119, ~150, ~179, ~212: `staleTime: 5 * 60 * 1000` -> `staleTime: STALE_STANDARD`

**use-work-order-metrics.ts** (4 replacements):
- Lines ~138, ~168, ~197, ~226: `staleTime: 5 * 60 * 1000` -> `staleTime: STALE_STANDARD`

**use-revenue-metrics.ts** (3 replacements):
- Lines ~155, ~190, ~233: `staleTime: 5 * 60 * 1000` -> `staleTime: STALE_STANDARD`

Remove any comments like `// 5 minutes` or `// 30 seconds` since the constant names are self-documenting.
  </action>
  <verify>
```bash
cd apps/admin && npx tsc --noEmit

# Verify no hardcoded staleTime values remain
grep -r "staleTime.*1000" src/hooks/ || echo "No hardcoded staleTime found - PASS"
```
  </verify>
  <done>
- All 11 hook files import from '@/lib/queries/config'
- Zero hardcoded `staleTime: X * Y * Z` patterns in hooks
- All staleTime values use named constants
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Plan Editor to Use Centralized Markup</name>
  <files>apps/admin/src/components/portal/plan-editor/plan-editor.tsx</files>
  <action>
Update plan-editor.tsx to use centralized pricing configuration:

1. Add import at top:
```typescript
import { BUILDER_MARKUP } from '@/config/app-config'
```

2. Remove the local BUILDER_MARKUP constant (around line 48):
```typescript
// REMOVE THIS:
// 20% builder markup
const BUILDER_MARKUP = 0.20
```

3. Keep the existing pricing calculation pattern (applying markup to each field individually).
   The code already uses `(1 + BUILDER_MARKUP)` on each pricing field - this is correct.
   Do NOT change to use calculateClientPrice helper since the code operates on an object
   with multiple fields (baseFee, tierFee, addonsFee, monthlyTotal), not a single number.

The existing calculation pattern at lines ~111-116 and ~134-139 is correct:
```typescript
return {
  baseFee: base.baseFee * (1 + BUILDER_MARKUP),
  tierFee: base.tierFee * (1 + BUILDER_MARKUP),
  addonsFee: base.addonsFee * (1 + BUILDER_MARKUP),
  monthlyTotal: base.monthlyTotal * (1 + BUILDER_MARKUP),
}
```

This pattern should remain - we're only changing WHERE BUILDER_MARKUP comes from (import vs local const).

4. Update the docstring comment at top of file to reference the config:
```typescript
/**
 * Self-Service Plan Editor
 *
 * Allows clients to modify their property's service plan with live pricing.
 * Pricing markup configured in src/config/app-config.ts
 */
```

This ensures the 20% markup is now configurable from a single location.
  </action>
  <verify>
```bash
cd apps/admin && npx tsc --noEmit src/components/portal/plan-editor/plan-editor.tsx

# Verify no local BUILDER_MARKUP constant
grep -n "const BUILDER_MARKUP" src/components/portal/plan-editor/plan-editor.tsx && echo "FAIL: Local constant still exists" || echo "PASS: No local constant"

# Verify import exists
grep -n "from '@/config/app-config'" src/components/portal/plan-editor/plan-editor.tsx && echo "PASS: Import exists" || echo "FAIL: Import missing"
```
  </verify>
  <done>
- plan-editor.tsx imports BUILDER_MARKUP from config
- No local BUILDER_MARKUP constant defined in the component
- Existing pricing calculation pattern preserved (applies markup to each field)
  </done>
</task>

<task type="auto">
  <name>Task 4: Migrate Hardcoded Vendor Markup (15%) to Config</name>
  <files>
apps/admin/src/lib/constants/work-order.ts
apps/admin/src/components/billing/create-invoice-dialog.tsx
apps/admin/src/lib/validations/pricing.ts
apps/admin/src/lib/validations/program.ts
apps/admin/src/lib/validations/work-order.ts
  </files>
  <action>
Migrate all hardcoded 15% vendor markup values to use VENDOR_MARKUP from app-config.

**File 1: apps/admin/src/lib/constants/work-order.ts (line 135)**

1. Add import at top:
```typescript
import { VENDOR_MARKUP } from '@/config/app-config'
```

2. Replace the local constant:
```typescript
// REMOVE THIS:
export const DEFAULT_MARKUP_PERCENT = 15

// REPLACE WITH:
export const DEFAULT_MARKUP_PERCENT = VENDOR_MARKUP * 100  // Convert decimal to percent
```

Note: This file exports DEFAULT_MARKUP_PERCENT which is used elsewhere. The value stays the same (15),
but now it derives from the centralized VENDOR_MARKUP (0.15) constant.

**File 2: apps/admin/src/components/billing/create-invoice-dialog.tsx (line ~64)**

1. Add import:
```typescript
import { VENDOR_MARKUP } from '@/config/app-config'
```

2. Find and replace any hardcoded `0.15` or `15` markup with:
- If decimal: use `VENDOR_MARKUP` directly
- If percent: use `VENDOR_MARKUP * 100`

**File 3: apps/admin/src/lib/validations/pricing.ts (line ~74)**

1. Add import:
```typescript
import { VENDOR_MARKUP } from '@/config/app-config'
```

2. Replace hardcoded `0.15` with `VENDOR_MARKUP`

**File 4: apps/admin/src/lib/validations/program.ts (lines ~43, ~74)**

1. Add import:
```typescript
import { VENDOR_MARKUP } from '@/config/app-config'
```

2. Replace both hardcoded `0.15` values with `VENDOR_MARKUP`

**File 5: apps/admin/src/lib/validations/work-order.ts (line ~85)**

1. Add import:
```typescript
import { VENDOR_MARKUP } from '@/config/app-config'
```

2. Replace hardcoded `0.15` with `VENDOR_MARKUP`

**Important:** Some files may use the value as a percentage (15) and some as a decimal (0.15).
- If file uses `15`: replace with `VENDOR_MARKUP * 100`
- If file uses `0.15`: replace with `VENDOR_MARKUP`
  </action>
  <verify>
```bash
cd apps/admin && npx tsc --noEmit

# Verify no hardcoded 0.15 markup values remain (excluding config file itself)
grep -rn "0\.15" src/lib/validations/ src/components/billing/create-invoice-dialog.tsx src/lib/constants/work-order.ts | grep -v "app-config" || echo "PASS: No hardcoded 0.15 found"

# Verify imports exist in all files
for f in src/lib/constants/work-order.ts src/components/billing/create-invoice-dialog.tsx src/lib/validations/pricing.ts src/lib/validations/program.ts src/lib/validations/work-order.ts; do
  grep -q "VENDOR_MARKUP" "$f" && echo "PASS: $f has VENDOR_MARKUP" || echo "FAIL: $f missing VENDOR_MARKUP"
done
```
  </verify>
  <done>
- All 5 files import VENDOR_MARKUP from '@/config/app-config'
- Zero hardcoded 0.15 or 15% markup values remain in these files
- Calculations still produce same results (just sourced from config)
  </done>
</task>

</tasks>

<verification>
After all tasks complete, run comprehensive verification:

1. TypeScript compilation:
```bash
cd apps/admin && npx tsc --noEmit
```

2. Verify no hardcoded staleTime in hooks:
```bash
grep -r "staleTime.*\(1000\|60\|30\|15\).*\*" apps/admin/src/hooks/ || echo "PASS: No hardcoded staleTime"
```

3. Verify no hardcoded staleTime in App.tsx:
```bash
grep "staleTime.*1000" apps/admin/src/App.tsx || echo "PASS: No hardcoded staleTime in App.tsx"
```

4. Verify BUILDER_MARKUP not defined locally in plan-editor:
```bash
grep "const BUILDER_MARKUP" apps/admin/src/components/portal/plan-editor/plan-editor.tsx || echo "PASS: No local BUILDER_MARKUP"
```

5. Verify no hardcoded vendor markup (0.15) in validation/billing files:
```bash
grep -rn "0\.15" apps/admin/src/lib/validations/ apps/admin/src/components/billing/ apps/admin/src/lib/constants/work-order.ts | grep -v "app-config" || echo "PASS: No hardcoded vendor markup"
```

6. Production build test:
```bash
cd apps/admin && npm run build
```
</verification>

<success_criteria>
1. Zero hardcoded `staleTime: 1000 * 60 * 5` patterns in any hook file
2. App.tsx uses DEFAULT_QUERY_OPTIONS from config
3. All pricing markup values come from app-config.ts (not hardcoded in components)
4. Zero hardcoded 15% vendor markup in validation/billing/constants files
5. TypeScript compiles without errors
6. Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/v1.4-01-query-configuration/01-02-SUMMARY.md`
</output>
