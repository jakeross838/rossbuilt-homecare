---
phase: v1.4-01-query-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/admin/src/lib/queries/config.ts
  - apps/admin/src/config/app-config.ts
autonomous: true

must_haves:
  truths:
    - "All cache timing constants defined in single config file"
    - "All business configuration values defined in single config file"
    - "Pricing markup value is configurable, not hardcoded"
    - "Status labels/colors accessible from app-config (SYNC-09.3)"
    - "Tier definitions accessible from app-config (SYNC-09.4)"
  artifacts:
    - path: "apps/admin/src/lib/queries/config.ts"
      provides: "Cache timing constants for React Query"
      exports: ["STALE_REALTIME", "STALE_FAST", "STALE_STANDARD", "STALE_ACTIVITY", "getCacheConfig"]
    - path: "apps/admin/src/config/app-config.ts"
      provides: "Business configuration values"
      exports: ["APP_CONFIG", "BUILDER_MARKUP", "VENDOR_MARKUP", "calculateClientPrice", "calculateVendorMarkup", "WORK_ORDER_STATUS", "PRIORITY_LEVELS", "INSPECTION_TIERS"]
  key_links:
    - from: "apps/admin/src/lib/queries/config.ts"
      to: "React Query staleTime options"
      via: "import and apply in useQuery calls"
      pattern: "STALE_"
    - from: "apps/admin/src/config/app-config.ts"
      to: "Pricing calculations"
      via: "import and use BUILDER_MARKUP"
      pattern: "BUILDER_MARKUP|calculateClientPrice"
    - from: "apps/admin/src/config/app-config.ts"
      to: "Status/Tier constants"
      via: "re-export from constants files"
      pattern: "WORK_ORDER_STATUS|INSPECTION_TIERS"
---

<objective>
Create centralized configuration files for cache timing and business rules.

Purpose: Eliminate hardcoded magic numbers scattered across the codebase. All cache timing values and business configuration should come from single source of truth files. Also provides centralized re-exports for status configs (SYNC-09.3) and tier definitions (SYNC-09.4).

Output: Two new config files ready for import by hooks and components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@P:/Claude Projects/home-care-os/.planning/PROJECT.md
@P:/Claude Projects/home-care-os/.planning/ROADMAP.md
@P:/Claude Projects/home-care-os/.planning/REQUIREMENTS-v1.4.md

# Existing patterns
@P:/Claude Projects/home-care-os/apps/admin/src/lib/constants/pricing.ts
@P:/Claude Projects/home-care-os/apps/admin/src/lib/constants/work-order.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Query Cache Configuration</name>
  <files>apps/admin/src/lib/queries/config.ts</files>
  <action>
Create the queries directory and config file with cache timing constants:

```typescript
/**
 * Query cache configuration
 * All staleTime and cacheTime values should come from here
 *
 * Principle: Realtime-synced data should have staleTime: 0
 * Other data should have appropriate staleness based on update frequency
 */

// Cache timing constants (in milliseconds)
export const STALE_REALTIME = 0           // For realtime-synced data
export const STALE_FAST = 30 * 1000       // 30 seconds - for frequently updated data
export const STALE_ACTIVITY = 60 * 1000   // 1 minute - for activity feeds
export const STALE_STANDARD = 5 * 60 * 1000  // 5 minutes - for standard data

// Cache time (how long to keep in cache after unmount)
export const CACHE_STANDARD = 10 * 60 * 1000  // 10 minutes

// Refetch intervals for polling (only for non-realtime data)
export const REFETCH_NOTIFICATIONS = 15 * 1000  // 15 seconds
export const REFETCH_ACTIVITY = 60 * 1000       // 1 minute

/**
 * Get standard cache config for a query type
 */
export type CacheStrategy = 'realtime' | 'fast' | 'activity' | 'standard'

export function getCacheConfig(strategy: CacheStrategy) {
  switch (strategy) {
    case 'realtime':
      return { staleTime: STALE_REALTIME }
    case 'fast':
      return { staleTime: STALE_FAST }
    case 'activity':
      return { staleTime: STALE_ACTIVITY }
    case 'standard':
    default:
      return { staleTime: STALE_STANDARD }
  }
}

/**
 * Default QueryClient options
 * Use these when creating the QueryClient in App.tsx
 */
export const DEFAULT_QUERY_OPTIONS = {
  queries: {
    staleTime: STALE_STANDARD,
    gcTime: CACHE_STANDARD,
    retry: 1,
    refetchOnWindowFocus: false,
  },
}
```

Key points:
- STALE_REALTIME (0ms) for data that has realtime subscriptions
- STALE_FAST (30s) for data that needs to be relatively fresh
- STALE_ACTIVITY (1min) for activity feeds
- STALE_STANDARD (5min) for normal data
- Helper function getCacheConfig for consistent usage
- DEFAULT_QUERY_OPTIONS for QueryClient initialization
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/admin && npx tsc --noEmit src/lib/queries/config.ts
```
  </verify>
  <done>
- `src/lib/queries/config.ts` exists with all timing constants
- Exports: STALE_REALTIME, STALE_FAST, STALE_STANDARD, STALE_ACTIVITY, getCacheConfig, DEFAULT_QUERY_OPTIONS
  </done>
</task>

<task type="auto">
  <name>Task 2: Create App Configuration File</name>
  <files>apps/admin/src/config/app-config.ts</files>
  <action>
Create the config directory and app-config file with business rules:

```typescript
/**
 * Application configuration
 * All business rules and magic numbers should come from here
 *
 * This is the single source of truth for:
 * - Pricing configuration
 * - Feature flags
 * - Business constants
 * - Re-exports of status/tier configs for centralized access
 */

// ============================================
// RE-EXPORTS FOR CENTRALIZED ACCESS
// These already exist in constants files but are re-exported
// here for centralized configuration access (SYNC-09.3, SYNC-09.4)
// ============================================

export {
  WORK_ORDER_STATUS,
  PRIORITY_LEVELS,
  WORK_ORDER_CATEGORIES,
  DEFAULT_MARKUP_PERCENT,
} from '@/lib/constants/work-order'

export {
  INSPECTION_TIERS,
  INSPECTION_FREQUENCIES,
  PROGRAM_ADDONS,
} from '@/lib/constants/pricing'

// ============================================
// PRICING CONFIGURATION
// ============================================

/**
 * Builder markup percentage applied to all client-facing prices
 * Used in plan editor and work order client costs
 */
export const BUILDER_MARKUP = 0.20  // 20%

/**
 * Default vendor markup for work orders
 */
export const VENDOR_MARKUP = 0.15  // 15%

/**
 * Calculate client price with builder markup
 * @param basePrice - The base price before markup
 * @returns Price with markup applied
 */
export function calculateClientPrice(basePrice: number): number {
  return Math.round(basePrice * (1 + BUILDER_MARKUP) * 100) / 100
}

/**
 * Calculate vendor markup for work orders
 * @param vendorCost - The vendor's cost
 * @returns Client cost with markup
 */
export function calculateVendorMarkup(vendorCost: number): number {
  return Math.round(vendorCost * (1 + VENDOR_MARKUP) * 100) / 100
}

// ============================================
// FEATURE FLAGS
// ============================================

export const FEATURES = {
  /** Enable realtime subscriptions */
  realtimeEnabled: true,
  /** Enable offline mode for inspectors */
  offlineEnabled: true,
  /** Enable AI report summaries */
  aiSummariesEnabled: true,
  /** Enable email notifications */
  emailNotificationsEnabled: true,
  /** Show debug information in console */
  debugMode: import.meta.env.DEV,
} as const

// ============================================
// PAGINATION DEFAULTS
// ============================================

export const PAGINATION = {
  /** Default page size for lists */
  defaultPageSize: 20,
  /** Max items per page */
  maxPageSize: 100,
  /** Activity feed page size */
  activityPageSize: 10,
} as const

// ============================================
// TIMEOUTS AND INTERVALS
// ============================================

export const TIMEOUTS = {
  /** Toast auto-dismiss duration (ms) */
  toastDuration: 5000,
  /** Debounce delay for search inputs (ms) */
  searchDebounce: 300,
  /** Sync retry delay (ms) */
  syncRetryDelay: 5000,
} as const

// ============================================
// COMBINED APP CONFIG
// ============================================

export const APP_CONFIG = {
  pricing: {
    builderMarkup: BUILDER_MARKUP,
    vendorMarkup: VENDOR_MARKUP,
  },
  features: FEATURES,
  pagination: PAGINATION,
  timeouts: TIMEOUTS,
} as const
```

Key points:
- Re-exports WORK_ORDER_STATUS, PRIORITY_LEVELS from work-order.ts (SYNC-09.3)
- Re-exports INSPECTION_TIERS, INSPECTION_FREQUENCIES from pricing.ts (SYNC-09.4)
- BUILDER_MARKUP (20%) centralized - currently hardcoded in plan-editor.tsx
- VENDOR_MARKUP (15%) centralized - currently hardcoded in work-order.ts and other files
- Helper functions for price calculations
- Feature flags for toggling functionality
- Pagination defaults
- Timeout configurations
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/admin && npx tsc --noEmit src/config/app-config.ts
```
  </verify>
  <done>
- `src/config/app-config.ts` exists with all business configuration
- Re-exports: WORK_ORDER_STATUS, PRIORITY_LEVELS, INSPECTION_TIERS, INSPECTION_FREQUENCIES (SYNC-09.3, SYNC-09.4)
- Exports: BUILDER_MARKUP, VENDOR_MARKUP, calculateClientPrice, calculateVendorMarkup, FEATURES, PAGINATION, TIMEOUTS, APP_CONFIG
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Verify both files exist:
```bash
ls -la apps/admin/src/lib/queries/config.ts
ls -la apps/admin/src/config/app-config.ts
```

2. Verify TypeScript compilation:
```bash
cd apps/admin && npx tsc --noEmit
```

3. Verify exports are importable:
```bash
cd apps/admin && npx tsc --noEmit -p tsconfig.json
```

4. Verify re-exports work:
```bash
# Check that WORK_ORDER_STATUS is accessible from app-config
grep -n "WORK_ORDER_STATUS" apps/admin/src/config/app-config.ts
grep -n "INSPECTION_TIERS" apps/admin/src/config/app-config.ts
```
</verification>

<success_criteria>
- src/lib/queries/config.ts exists with STALE_REALTIME, STALE_FAST, STALE_STANDARD, STALE_ACTIVITY
- src/config/app-config.ts exists with BUILDER_MARKUP, VENDOR_MARKUP, FEATURES, PAGINATION, APP_CONFIG
- src/config/app-config.ts re-exports WORK_ORDER_STATUS, PRIORITY_LEVELS (SYNC-09.3)
- src/config/app-config.ts re-exports INSPECTION_TIERS, INSPECTION_FREQUENCIES (SYNC-09.4)
- Both files compile without TypeScript errors
- Zero hardcoded values in the new files (all values are named constants)
</success_criteria>

<output>
After completion, create `.planning/phases/v1.4-01-query-configuration/01-01-SUMMARY.md`
</output>
