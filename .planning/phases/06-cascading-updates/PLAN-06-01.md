---
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/028_program_cascade_function.sql
  - components/portal/plan-editor/plan-editor.tsx
autonomous: true
---

# Plan 06-01: Cascading Program Updates

## Objective

Create RPC function for cascading plan changes to billing, schedules, and checklists with transaction integrity. When a program is updated (frequency change, addon change, price change), all related entities are updated atomically.

## Prerequisites

- Phase 5 (Templates & Checklists) complete
- Programs & pricing engine operational (Phase 4)
- Existing database schema with inspections, invoices, notifications, activity_log tables

## Files Created/Modified

### Created

**`supabase/migrations/028_program_cascade_function.sql`**
PostgreSQL function `cascade_program_update()` with:
- Transaction-wrapped atomic operations
- SECURITY DEFINER for proper permissions
- Error handling with RAISE EXCEPTION

### Modified

**`components/portal/plan-editor/plan-editor.tsx`**
- Added RPC call to `cascade_program_update` after saving program changes
- Passes old and new frequency, addon settings, price difference, and new monthly total

## Implementation Tasks

### Task 1: Create Cascade RPC Function

**Files:** `supabase/migrations/028_program_cascade_function.sql`

**Action:** Created PostgreSQL function with the following parameters:
- `p_program_id` - Program being updated
- `p_old_frequency` - Previous inspection frequency
- `p_new_frequency` - New inspection frequency
- `p_old_addons` - Previous addon settings (JSONB)
- `p_new_addons` - New addon settings (JSONB)
- `p_price_difference` - Price increase amount (for invoicing)
- `p_new_monthly_total` - New monthly total

**Cascade Operations Implemented:**

1. **Schedule Cascade**
   - Cancels future scheduled inspections if frequency changed
   - Creates new inspections based on new frequency
   - Adds notes explaining automatic changes

2. **Billing Cascade**
   - Creates invoice for price increases (upgrades)
   - Generates unique invoice number
   - Creates corresponding line item
   - Sets 30-day due date

3. **Notification Cascade**
   - Notifies all admin/manager users
   - Includes property name, old/new frequency, price change
   - Notification type: 'plan_change'

4. **Activity Log**
   - Records the change in activity_log table
   - Includes full change details as JSONB

**Return Value:**
```json
{
  "success": true,
  "inspections_rescheduled": 3,
  "invoice_created": true,
  "invoice_id": "uuid",
  "notification_sent": true
}
```

**Verify:** Migration applied successfully via `npx supabase db push`

**Done:** Function exists and can be called via `supabase.rpc('cascade_program_update', {...})`

### Task 2: Integrate Cascade Function with Plan Editor

**Files:** `components/portal/plan-editor/plan-editor.tsx`

**Action:** Updated the plan editor component to call the cascade function after saving program changes:

```typescript
const { error: cascadeError } = await supabase.rpc('cascade_program_update', {
  p_program_id: program.id,
  p_old_frequency: program.inspection_frequency,
  p_new_frequency: frequency,
  p_old_addons: program.addons,
  p_new_addons: addons,
  p_price_difference: priceDifference,
  p_new_monthly_total: newMonthlyTotal
})
```

**Verify:** Plan editor successfully calls RPC function and handles response

**Done:** Saving a program change triggers cascade operations

## Verification

- [x] Migration 028 applied without errors
- [x] RPC function callable from TypeScript client
- [x] Schedule cascade: Future inspections cancelled and recreated on frequency change
- [x] Billing cascade: Invoice created for price increases
- [x] Notification cascade: Admins/managers notified on plan changes
- [x] Activity log: Changes recorded with full details
- [x] Transaction integrity: All operations succeed together or none are applied

## must_haves

- Billing/invoice automatically updates when plan changes
- Inspection schedule adjusts when frequency changes
- Changes take effect immediately
- All cascades complete or all roll back (transaction)
- Admin notifications sent on plan changes
- Activity logged for audit trail
