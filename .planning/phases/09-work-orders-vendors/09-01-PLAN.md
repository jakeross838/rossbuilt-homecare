# Plan 09-01: Work Order Data Foundation

## Wave
1

## Dependencies
None (first plan in phase)

## Objective
Create TypeScript types, constants, and validation schemas for work orders. Establish the data foundation that supports the full work order lifecycle from creation to completion.

## Why This Plan
Work orders are the bridge between inspection findings/recommendations and actual maintenance work. This foundation must support:
- Creating work orders from recommendations or manually
- Status workflow tracking (pending → vendor_assigned → scheduled → in_progress → completed)
- Cost tracking with vendor markup calculations
- Assignment to vendors or internal staff
- Photo documentation (before/after)

## Files to Create

### 1. `apps/admin/src/lib/types/work-order.ts`
TypeScript types for work orders.

```typescript
import type { Enums, Tables } from '@/lib/supabase'

/**
 * Work order status flow
 */
export type WorkOrderStatus = Enums<'work_order_status'>

/**
 * Priority level for work orders
 */
export type PriorityLevel = Enums<'priority_level'>

/**
 * Work order from database with relations
 */
export type WorkOrder = Tables<'work_orders'>

/**
 * Work order with expanded relations for display
 */
export interface WorkOrderWithRelations extends WorkOrder {
  property?: {
    id: string
    name: string
    address_line1: string
    city: string
    state: string
    zip: string
  }
  client?: {
    id: string
    first_name: string
    last_name: string
    email: string | null
    phone: string | null
  }
  vendor?: {
    id: string
    company_name: string
    contact_first_name: string | null
    contact_last_name: string | null
    email: string | null
    phone: string | null
  }
  assigned_user?: {
    id: string
    first_name: string
    last_name: string
    email: string
  }
  recommendation?: {
    id: string
    title: string
    description: string
    priority: PriorityLevel
  }
}

/**
 * Work order list item (minimal fields for list views)
 */
export interface WorkOrderListItem {
  id: string
  work_order_number: string
  title: string
  status: WorkOrderStatus
  priority: PriorityLevel | null
  category: string | null
  scheduled_date: string | null
  property_name: string
  property_address: string
  client_name: string
  vendor_name: string | null
  estimated_cost: number | null
  created_at: string
}

/**
 * Work order cost breakdown
 */
export interface WorkOrderCostBreakdown {
  estimated_cost: number | null
  actual_cost: number | null
  markup_percent: number | null
  markup_amount: number | null
  total_client_cost: number | null
}

/**
 * Work order creation source
 */
export type WorkOrderSource = 'recommendation' | 'service_request' | 'manual'

/**
 * Form data for creating a work order
 */
export interface CreateWorkOrderData {
  property_id: string
  client_id: string
  title: string
  description: string
  category?: string
  priority?: PriorityLevel
  vendor_id?: string
  assigned_to?: string
  scheduled_date?: string
  scheduled_time_start?: string
  scheduled_time_end?: string
  estimated_cost?: number
  recommendation_id?: string
  internal_notes?: string
}

/**
 * Form data for updating a work order
 */
export interface UpdateWorkOrderData {
  title?: string
  description?: string
  category?: string
  priority?: PriorityLevel
  status?: WorkOrderStatus
  vendor_id?: string | null
  assigned_to?: string | null
  scheduled_date?: string | null
  scheduled_time_start?: string | null
  scheduled_time_end?: string | null
  estimated_cost?: number | null
  actual_cost?: number | null
  markup_percent?: number | null
  completion_notes?: string
  internal_notes?: string
  client_visible_notes?: string
}

/**
 * Work order completion data
 */
export interface CompleteWorkOrderData {
  actual_cost: number
  completion_notes?: string
  after_photos?: string[]
}

/**
 * Work order filter options
 */
export interface WorkOrderFilters {
  status?: WorkOrderStatus[]
  priority?: PriorityLevel[]
  category?: string[]
  vendor_id?: string
  assigned_to?: string
  property_id?: string
  client_id?: string
  date_from?: string
  date_to?: string
  search?: string
}
```

### 2. `apps/admin/src/lib/constants/work-order.ts`
Constants for work order management.

```typescript
import type { WorkOrderStatus, PriorityLevel } from '@/lib/types/work-order'

/**
 * Work order status configuration
 */
export const WORK_ORDER_STATUS: Record<
  WorkOrderStatus,
  {
    label: string
    color: 'default' | 'warning' | 'info' | 'success' | 'destructive'
    description: string
    allowedTransitions: WorkOrderStatus[]
  }
> = {
  pending: {
    label: 'Pending',
    color: 'default',
    description: 'Work order created, awaiting assignment',
    allowedTransitions: ['vendor_assigned', 'scheduled', 'cancelled'],
  },
  vendor_assigned: {
    label: 'Vendor Assigned',
    color: 'info',
    description: 'Vendor has been assigned, awaiting scheduling',
    allowedTransitions: ['scheduled', 'pending', 'cancelled'],
  },
  scheduled: {
    label: 'Scheduled',
    color: 'warning',
    description: 'Work has been scheduled',
    allowedTransitions: ['in_progress', 'vendor_assigned', 'cancelled'],
  },
  in_progress: {
    label: 'In Progress',
    color: 'warning',
    description: 'Work is currently being performed',
    allowedTransitions: ['completed', 'on_hold'],
  },
  completed: {
    label: 'Completed',
    color: 'success',
    description: 'Work has been completed',
    allowedTransitions: ['invoiced'],
  },
  on_hold: {
    label: 'On Hold',
    color: 'destructive',
    description: 'Work is temporarily paused',
    allowedTransitions: ['in_progress', 'cancelled'],
  },
  cancelled: {
    label: 'Cancelled',
    color: 'destructive',
    description: 'Work order has been cancelled',
    allowedTransitions: [],
  },
  invoiced: {
    label: 'Invoiced',
    color: 'success',
    description: 'Work has been invoiced to client',
    allowedTransitions: [],
  },
}

/**
 * Priority level configuration
 */
export const PRIORITY_LEVELS: Record<
  PriorityLevel,
  {
    label: string
    color: 'default' | 'warning' | 'destructive' | 'info'
    icon: string
    sortOrder: number
  }
> = {
  low: {
    label: 'Low',
    color: 'default',
    icon: 'ArrowDown',
    sortOrder: 1,
  },
  medium: {
    label: 'Medium',
    color: 'info',
    icon: 'Minus',
    sortOrder: 2,
  },
  high: {
    label: 'High',
    color: 'warning',
    icon: 'ArrowUp',
    sortOrder: 3,
  },
  urgent: {
    label: 'Urgent',
    color: 'destructive',
    icon: 'AlertTriangle',
    sortOrder: 4,
  },
}

/**
 * Work order categories (aligned with equipment categories and vendor trades)
 */
export const WORK_ORDER_CATEGORIES = [
  { value: 'hvac', label: 'HVAC' },
  { value: 'plumbing', label: 'Plumbing' },
  { value: 'electrical', label: 'Electrical' },
  { value: 'appliance', label: 'Appliance Repair' },
  { value: 'pool_spa', label: 'Pool & Spa' },
  { value: 'roofing', label: 'Roofing' },
  { value: 'painting', label: 'Painting' },
  { value: 'flooring', label: 'Flooring' },
  { value: 'landscaping', label: 'Landscaping' },
  { value: 'pest_control', label: 'Pest Control' },
  { value: 'cleaning', label: 'Cleaning' },
  { value: 'security', label: 'Security Systems' },
  { value: 'general', label: 'General Maintenance' },
  { value: 'other', label: 'Other' },
] as const

export type WorkOrderCategory = (typeof WORK_ORDER_CATEGORIES)[number]['value']

/**
 * Default markup percentage for vendor work
 */
export const DEFAULT_MARKUP_PERCENT = 15

/**
 * Work order number prefix
 */
export const WORK_ORDER_PREFIX = 'WO'

/**
 * Calculate total client cost with markup
 */
export function calculateClientCost(
  actualCost: number,
  markupPercent: number = DEFAULT_MARKUP_PERCENT
): { markupAmount: number; totalCost: number } {
  const markupAmount = actualCost * (markupPercent / 100)
  const totalCost = actualCost + markupAmount
  return {
    markupAmount: Math.round(markupAmount * 100) / 100,
    totalCost: Math.round(totalCost * 100) / 100,
  }
}

/**
 * Format work order number for display
 */
export function formatWorkOrderNumber(number: string): string {
  return number.startsWith(WORK_ORDER_PREFIX) ? number : `${WORK_ORDER_PREFIX}-${number}`
}

/**
 * Get status badge variant
 */
export function getStatusBadgeVariant(
  status: WorkOrderStatus
): 'default' | 'secondary' | 'destructive' | 'outline' {
  const config = WORK_ORDER_STATUS[status]
  switch (config.color) {
    case 'success':
    case 'info':
      return 'default'
    case 'warning':
      return 'secondary'
    case 'destructive':
      return 'destructive'
    default:
      return 'outline'
  }
}

/**
 * Get priority badge variant
 */
export function getPriorityBadgeVariant(
  priority: PriorityLevel
): 'default' | 'secondary' | 'destructive' | 'outline' {
  const config = PRIORITY_LEVELS[priority]
  switch (config.color) {
    case 'destructive':
      return 'destructive'
    case 'warning':
      return 'secondary'
    case 'info':
      return 'default'
    default:
      return 'outline'
  }
}
```

### 3. `apps/admin/src/lib/validations/work-order.ts`
Zod validation schemas for work order forms.

```typescript
import { z } from 'zod'
import { WORK_ORDER_CATEGORIES } from '@/lib/constants/work-order'

/**
 * Schema for creating a new work order
 */
export const createWorkOrderSchema = z.object({
  property_id: z.string().uuid('Invalid property'),
  client_id: z.string().uuid('Invalid client'),
  title: z
    .string()
    .min(3, 'Title must be at least 3 characters')
    .max(200, 'Title must be less than 200 characters'),
  description: z
    .string()
    .min(10, 'Description must be at least 10 characters')
    .max(2000, 'Description must be less than 2000 characters'),
  category: z
    .enum(WORK_ORDER_CATEGORIES.map((c) => c.value) as [string, ...string[]])
    .optional(),
  priority: z.enum(['low', 'medium', 'high', 'urgent']).optional(),
  vendor_id: z.string().uuid().optional().nullable(),
  assigned_to: z.string().uuid().optional().nullable(),
  scheduled_date: z.string().optional().nullable(),
  scheduled_time_start: z.string().optional().nullable(),
  scheduled_time_end: z.string().optional().nullable(),
  estimated_cost: z.coerce.number().min(0).optional().nullable(),
  recommendation_id: z.string().uuid().optional().nullable(),
  internal_notes: z.string().max(2000).optional().nullable(),
})

export type CreateWorkOrderFormData = z.infer<typeof createWorkOrderSchema>

/**
 * Schema for updating a work order
 */
export const updateWorkOrderSchema = z.object({
  title: z
    .string()
    .min(3, 'Title must be at least 3 characters')
    .max(200, 'Title must be less than 200 characters')
    .optional(),
  description: z
    .string()
    .min(10, 'Description must be at least 10 characters')
    .max(2000, 'Description must be less than 2000 characters')
    .optional(),
  category: z
    .enum(WORK_ORDER_CATEGORIES.map((c) => c.value) as [string, ...string[]])
    .optional()
    .nullable(),
  priority: z.enum(['low', 'medium', 'high', 'urgent']).optional().nullable(),
  status: z
    .enum([
      'pending',
      'vendor_assigned',
      'scheduled',
      'in_progress',
      'completed',
      'on_hold',
      'cancelled',
      'invoiced',
    ])
    .optional(),
  vendor_id: z.string().uuid().optional().nullable(),
  assigned_to: z.string().uuid().optional().nullable(),
  scheduled_date: z.string().optional().nullable(),
  scheduled_time_start: z.string().optional().nullable(),
  scheduled_time_end: z.string().optional().nullable(),
  estimated_cost: z.coerce.number().min(0).optional().nullable(),
  actual_cost: z.coerce.number().min(0).optional().nullable(),
  markup_percent: z.coerce.number().min(0).max(100).optional().nullable(),
  completion_notes: z.string().max(2000).optional().nullable(),
  internal_notes: z.string().max(2000).optional().nullable(),
  client_visible_notes: z.string().max(2000).optional().nullable(),
})

export type UpdateWorkOrderFormData = z.infer<typeof updateWorkOrderSchema>

/**
 * Schema for completing a work order
 */
export const completeWorkOrderSchema = z.object({
  actual_cost: z.coerce.number().min(0, 'Actual cost is required'),
  markup_percent: z.coerce.number().min(0).max(100).default(15),
  completion_notes: z.string().max(2000).optional(),
})

export type CompleteWorkOrderFormData = z.infer<typeof completeWorkOrderSchema>

/**
 * Schema for assigning a vendor to a work order
 */
export const assignVendorSchema = z.object({
  vendor_id: z.string().uuid('Please select a vendor'),
  scheduled_date: z.string().optional(),
  scheduled_time_start: z.string().optional(),
  scheduled_time_end: z.string().optional(),
  estimated_cost: z.coerce.number().min(0).optional(),
  internal_notes: z.string().max(2000).optional(),
})

export type AssignVendorFormData = z.infer<typeof assignVendorSchema>

/**
 * Schema for scheduling a work order
 */
export const scheduleWorkOrderSchema = z.object({
  scheduled_date: z.string().min(1, 'Scheduled date is required'),
  scheduled_time_start: z.string().optional(),
  scheduled_time_end: z.string().optional(),
})

export type ScheduleWorkOrderFormData = z.infer<typeof scheduleWorkOrderSchema>
```

## Verification
- [ ] Types file exports all work order types
- [ ] Constants file exports status config, priorities, categories
- [ ] Validation schemas cover create, update, complete, assign, schedule
- [ ] Helper functions for cost calculation work correctly
- [ ] All files have no TypeScript errors
