# Plan 09-02: Vendor Data Foundation

## Wave
1

## Dependencies
None (parallel with 09-01)

## Objective
Create TypeScript types, constants, and validation schemas for vendor management. Vendors are third-party service providers who perform maintenance work on properties.

## Why This Plan
Vendors are essential for outsourced maintenance work. The foundation must support:
- Vendor company and contact information
- Trade categories (what services they provide)
- Service area coverage
- Business compliance (licenses, insurance, W-9)
- Performance tracking (jobs completed, ratings)
- Preferred vendor designation

## Files to Create

### 1. `apps/admin/src/lib/types/vendor.ts`
TypeScript types for vendors.

```typescript
import type { Tables } from '@/lib/supabase'

/**
 * Vendor from database
 */
export type Vendor = Tables<'vendors'>

/**
 * Vendor for list views (minimal fields)
 */
export interface VendorListItem {
  id: string
  company_name: string
  contact_name: string | null
  email: string | null
  phone: string | null
  trade_categories: string[]
  is_preferred: boolean
  is_active: boolean
  total_jobs: number
  completed_jobs: number
  average_rating: number | null
}

/**
 * Vendor with computed fields for display
 */
export interface VendorWithStats extends Vendor {
  contact_name: string | null
  completion_rate: number | null
  open_work_orders: number
}

/**
 * Vendor compliance status
 */
export interface VendorCompliance {
  license_valid: boolean
  license_expires_soon: boolean
  insurance_valid: boolean
  insurance_expires_soon: boolean
  w9_on_file: boolean
  is_compliant: boolean
  issues: string[]
}

/**
 * Form data for creating a vendor
 */
export interface CreateVendorData {
  company_name: string
  contact_first_name?: string
  contact_last_name?: string
  email?: string
  phone?: string
  address_line1?: string
  address_line2?: string
  city?: string
  state?: string
  zip?: string
  trade_categories?: string[]
  service_area?: string[]
  license_number?: string
  license_expiration?: string
  insurance_company?: string
  insurance_policy_number?: string
  insurance_expiration?: string
  w9_on_file?: boolean
  w9_received_date?: string
  is_preferred?: boolean
  notes?: string
}

/**
 * Form data for updating a vendor
 */
export interface UpdateVendorData extends Partial<CreateVendorData> {
  is_active?: boolean
}

/**
 * Vendor filter options
 */
export interface VendorFilters {
  trade_category?: string
  service_area?: string
  is_preferred?: boolean
  is_active?: boolean
  has_valid_license?: boolean
  has_valid_insurance?: boolean
  search?: string
}

/**
 * Vendor search result for assignment
 */
export interface VendorSearchResult {
  id: string
  company_name: string
  contact_name: string | null
  phone: string | null
  trade_categories: string[]
  is_preferred: boolean
  average_rating: number | null
  average_response_hours: number | null
  compliance: VendorCompliance
}
```

### 2. `apps/admin/src/lib/constants/vendor.ts`
Constants for vendor management.

```typescript
/**
 * Trade categories for vendors (aligned with work order categories)
 */
export const TRADE_CATEGORIES = [
  { value: 'hvac', label: 'HVAC', icon: 'Thermometer' },
  { value: 'plumbing', label: 'Plumbing', icon: 'Droplets' },
  { value: 'electrical', label: 'Electrical', icon: 'Zap' },
  { value: 'appliance', label: 'Appliance Repair', icon: 'Refrigerator' },
  { value: 'pool_spa', label: 'Pool & Spa', icon: 'Waves' },
  { value: 'roofing', label: 'Roofing', icon: 'Home' },
  { value: 'painting', label: 'Painting', icon: 'Paintbrush' },
  { value: 'flooring', label: 'Flooring', icon: 'LayoutGrid' },
  { value: 'landscaping', label: 'Landscaping', icon: 'TreePine' },
  { value: 'pest_control', label: 'Pest Control', icon: 'Bug' },
  { value: 'cleaning', label: 'Cleaning', icon: 'Sparkles' },
  { value: 'security', label: 'Security Systems', icon: 'Shield' },
  { value: 'general', label: 'General Maintenance', icon: 'Wrench' },
] as const

export type TradeCategory = (typeof TRADE_CATEGORIES)[number]['value']

/**
 * Compliance warning thresholds (days before expiration)
 */
export const COMPLIANCE_WARNING_DAYS = 30

/**
 * Rating configuration
 */
export const RATING_CONFIG = {
  min: 1,
  max: 5,
  labels: {
    1: 'Poor',
    2: 'Fair',
    3: 'Good',
    4: 'Very Good',
    5: 'Excellent',
  },
}

/**
 * US States for address forms
 */
export const US_STATES = [
  { value: 'AL', label: 'Alabama' },
  { value: 'AK', label: 'Alaska' },
  { value: 'AZ', label: 'Arizona' },
  { value: 'AR', label: 'Arkansas' },
  { value: 'CA', label: 'California' },
  { value: 'CO', label: 'Colorado' },
  { value: 'CT', label: 'Connecticut' },
  { value: 'DE', label: 'Delaware' },
  { value: 'FL', label: 'Florida' },
  { value: 'GA', label: 'Georgia' },
  { value: 'HI', label: 'Hawaii' },
  { value: 'ID', label: 'Idaho' },
  { value: 'IL', label: 'Illinois' },
  { value: 'IN', label: 'Indiana' },
  { value: 'IA', label: 'Iowa' },
  { value: 'KS', label: 'Kansas' },
  { value: 'KY', label: 'Kentucky' },
  { value: 'LA', label: 'Louisiana' },
  { value: 'ME', label: 'Maine' },
  { value: 'MD', label: 'Maryland' },
  { value: 'MA', label: 'Massachusetts' },
  { value: 'MI', label: 'Michigan' },
  { value: 'MN', label: 'Minnesota' },
  { value: 'MS', label: 'Mississippi' },
  { value: 'MO', label: 'Missouri' },
  { value: 'MT', label: 'Montana' },
  { value: 'NE', label: 'Nebraska' },
  { value: 'NV', label: 'Nevada' },
  { value: 'NH', label: 'New Hampshire' },
  { value: 'NJ', label: 'New Jersey' },
  { value: 'NM', label: 'New Mexico' },
  { value: 'NY', label: 'New York' },
  { value: 'NC', label: 'North Carolina' },
  { value: 'ND', label: 'North Dakota' },
  { value: 'OH', label: 'Ohio' },
  { value: 'OK', label: 'Oklahoma' },
  { value: 'OR', label: 'Oregon' },
  { value: 'PA', label: 'Pennsylvania' },
  { value: 'RI', label: 'Rhode Island' },
  { value: 'SC', label: 'South Carolina' },
  { value: 'SD', label: 'South Dakota' },
  { value: 'TN', label: 'Tennessee' },
  { value: 'TX', label: 'Texas' },
  { value: 'UT', label: 'Utah' },
  { value: 'VT', label: 'Vermont' },
  { value: 'VA', label: 'Virginia' },
  { value: 'WA', label: 'Washington' },
  { value: 'WV', label: 'West Virginia' },
  { value: 'WI', label: 'Wisconsin' },
  { value: 'WY', label: 'Wyoming' },
] as const

/**
 * Get trade category label by value
 */
export function getTradeCategoryLabel(value: string): string {
  const category = TRADE_CATEGORIES.find((c) => c.value === value)
  return category?.label || value
}

/**
 * Get trade category icon by value
 */
export function getTradeCategoryIcon(value: string): string {
  const category = TRADE_CATEGORIES.find((c) => c.value === value)
  return category?.icon || 'Wrench'
}

/**
 * Format contact name from first and last name
 */
export function formatContactName(
  firstName: string | null | undefined,
  lastName: string | null | undefined
): string | null {
  const parts = [firstName, lastName].filter(Boolean)
  return parts.length > 0 ? parts.join(' ') : null
}

/**
 * Check vendor compliance status
 */
export function checkVendorCompliance(vendor: {
  license_expiration: string | null
  insurance_expiration: string | null
  w9_on_file: boolean | null
}): {
  license_valid: boolean
  license_expires_soon: boolean
  insurance_valid: boolean
  insurance_expires_soon: boolean
  w9_on_file: boolean
  is_compliant: boolean
  issues: string[]
} {
  const today = new Date()
  const warningDate = new Date()
  warningDate.setDate(warningDate.getDate() + COMPLIANCE_WARNING_DAYS)

  const licenseExpiration = vendor.license_expiration
    ? new Date(vendor.license_expiration)
    : null
  const insuranceExpiration = vendor.insurance_expiration
    ? new Date(vendor.insurance_expiration)
    : null

  const license_valid = !licenseExpiration || licenseExpiration > today
  const license_expires_soon =
    licenseExpiration !== null &&
    licenseExpiration > today &&
    licenseExpiration <= warningDate
  const insurance_valid = !insuranceExpiration || insuranceExpiration > today
  const insurance_expires_soon =
    insuranceExpiration !== null &&
    insuranceExpiration > today &&
    insuranceExpiration <= warningDate
  const w9_on_file = vendor.w9_on_file ?? false

  const issues: string[] = []
  if (!license_valid) issues.push('License expired')
  else if (license_expires_soon) issues.push('License expires soon')
  if (!insurance_valid) issues.push('Insurance expired')
  else if (insurance_expires_soon) issues.push('Insurance expires soon')
  if (!w9_on_file) issues.push('W-9 not on file')

  const is_compliant = license_valid && insurance_valid && w9_on_file

  return {
    license_valid,
    license_expires_soon,
    insurance_valid,
    insurance_expires_soon,
    w9_on_file,
    is_compliant,
    issues,
  }
}

/**
 * Format rating as stars
 */
export function formatRating(rating: number | null): string {
  if (rating === null) return 'No rating'
  return `${rating.toFixed(1)} / 5`
}

/**
 * Get rating label
 */
export function getRatingLabel(rating: number): string {
  const rounded = Math.round(rating)
  return RATING_CONFIG.labels[rounded as keyof typeof RATING_CONFIG.labels] || 'Unknown'
}
```

### 3. `apps/admin/src/lib/validations/vendor.ts`
Zod validation schemas for vendor forms.

```typescript
import { z } from 'zod'
import { TRADE_CATEGORIES, US_STATES } from '@/lib/constants/vendor'

const tradeCategoryValues = TRADE_CATEGORIES.map((c) => c.value) as [string, ...string[]]
const stateValues = US_STATES.map((s) => s.value) as [string, ...string[]]

/**
 * Phone number validation regex
 */
const phoneRegex = /^[\d\s\-().+]+$/

/**
 * Schema for creating a new vendor
 */
export const createVendorSchema = z.object({
  company_name: z
    .string()
    .min(2, 'Company name must be at least 2 characters')
    .max(200, 'Company name must be less than 200 characters'),
  contact_first_name: z.string().max(100).optional().nullable(),
  contact_last_name: z.string().max(100).optional().nullable(),
  email: z.string().email('Invalid email address').optional().nullable().or(z.literal('')),
  phone: z
    .string()
    .regex(phoneRegex, 'Invalid phone number format')
    .optional()
    .nullable()
    .or(z.literal('')),
  address_line1: z.string().max(200).optional().nullable(),
  address_line2: z.string().max(200).optional().nullable(),
  city: z.string().max(100).optional().nullable(),
  state: z.enum(stateValues).optional().nullable(),
  zip: z
    .string()
    .regex(/^\d{5}(-\d{4})?$/, 'Invalid ZIP code')
    .optional()
    .nullable()
    .or(z.literal('')),
  trade_categories: z.array(z.enum(tradeCategoryValues)).default([]),
  service_area: z.array(z.string()).default([]),
  license_number: z.string().max(100).optional().nullable(),
  license_expiration: z.string().optional().nullable(),
  insurance_company: z.string().max(200).optional().nullable(),
  insurance_policy_number: z.string().max(100).optional().nullable(),
  insurance_expiration: z.string().optional().nullable(),
  w9_on_file: z.boolean().default(false),
  w9_received_date: z.string().optional().nullable(),
  is_preferred: z.boolean().default(false),
  notes: z.string().max(2000).optional().nullable(),
})

export type CreateVendorFormData = z.infer<typeof createVendorSchema>

/**
 * Schema for updating a vendor
 */
export const updateVendorSchema = createVendorSchema.partial().extend({
  is_active: z.boolean().optional(),
})

export type UpdateVendorFormData = z.infer<typeof updateVendorSchema>

/**
 * Schema for vendor compliance update
 */
export const vendorComplianceSchema = z.object({
  license_number: z.string().max(100).optional().nullable(),
  license_expiration: z.string().optional().nullable(),
  insurance_company: z.string().max(200).optional().nullable(),
  insurance_policy_number: z.string().max(100).optional().nullable(),
  insurance_expiration: z.string().optional().nullable(),
  w9_on_file: z.boolean(),
  w9_received_date: z.string().optional().nullable(),
})

export type VendorComplianceFormData = z.infer<typeof vendorComplianceSchema>

/**
 * Schema for vendor search/filter
 */
export const vendorFilterSchema = z.object({
  trade_category: z.enum(tradeCategoryValues).optional(),
  is_preferred: z.boolean().optional(),
  is_active: z.boolean().optional(),
  search: z.string().optional(),
})

export type VendorFilterFormData = z.infer<typeof vendorFilterSchema>
```

## Verification
- [ ] Types file exports all vendor types
- [ ] Constants file exports trade categories, states, compliance helpers
- [ ] Validation schemas cover create, update, compliance, filter
- [ ] Compliance check function works correctly
- [ ] All files have no TypeScript errors
