---
phase: 08-findings-reports
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - supabase/functions/generate-report-summary/index.ts
autonomous: true
must_haves:
  truths:
    - "Edge function generates AI summary from findings"
    - "Summary is professional and client-facing"
    - "Function handles all inspection types"
  artifacts:
    - path: "supabase/functions/generate-report-summary/index.ts"
      provides: "AI-powered report summary generation"
  key_links:
    - from: "generate-report-summary"
      to: "Claude API"
      via: "anthropic SDK"
---

<objective>
Create Supabase Edge Function for AI-powered report summary generation.

Purpose: Generate professional, client-facing summaries from inspection findings.
Output: Edge function that produces AI-enhanced report summaries.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Report types
@apps/admin/src/lib/types/report.ts
@apps/admin/src/lib/types/inspector.ts

# Existing AI edge function pattern
@supabase/functions/generate-equipment-maintenance/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI summary edge function</name>
  <files>supabase/functions/generate-report-summary/index.ts</files>
  <action>
Create supabase/functions/generate-report-summary/index.ts:

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import Anthropic from 'npm:@anthropic-ai/sdk@0.24.3'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

interface FindingsSummary {
  total_items: number
  passed: number
  failed: number
  needs_attention: number
  urgent: number
  not_applicable: number
}

interface SectionFinding {
  section_name: string
  items: Array<{
    label: string
    status: string
    notes?: string
  }>
}

interface Recommendation {
  title: string
  description: string
  priority: string
  category?: string
}

interface ReportSummaryRequest {
  property_name: string
  property_address: string
  client_name: string
  inspection_date: string
  inspection_type: string
  overall_condition: string | null
  inspector_summary: string | null
  findings_summary: FindingsSummary
  sections: SectionFinding[]
  recommendations: Recommendation[]
  weather?: {
    temperature?: number
    humidity?: number
    conditions?: string
  }
}

interface ReportSummaryResponse {
  executive_summary: string
  key_findings: string[]
  priority_actions: string[]
  closing_statement: string
}

serve(async (req: Request) => {
  // Handle CORS preflight
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const apiKey = Deno.env.get('ANTHROPIC_API_KEY')
    if (!apiKey) {
      throw new Error('ANTHROPIC_API_KEY not configured')
    }

    const requestData: ReportSummaryRequest = await req.json()

    const anthropic = new Anthropic({ apiKey })

    // Build the prompt
    const prompt = buildPrompt(requestData)

    const message = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1500,
      messages: [
        {
          role: 'user',
          content: prompt,
        },
      ],
    })

    // Extract text content
    const textContent = message.content.find((block) => block.type === 'text')
    if (!textContent || textContent.type !== 'text') {
      throw new Error('No text response from Claude')
    }

    // Parse the response
    const response = parseResponse(textContent.text)

    return new Response(JSON.stringify(response), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    })
  } catch (error) {
    console.error('Error generating report summary:', error)
    return new Response(
      JSON.stringify({
        error: error instanceof Error ? error.message : 'Unknown error',
      }),
      {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      }
    )
  }
})

function buildPrompt(data: ReportSummaryRequest): string {
  // Build issues list from sections
  const issues: string[] = []
  for (const section of data.sections) {
    for (const item of section.items) {
      if (['fail', 'needs_attention', 'urgent'].includes(item.status)) {
        const statusLabel =
          item.status === 'fail'
            ? 'Failed'
            : item.status === 'urgent'
            ? 'URGENT'
            : 'Needs Attention'
        issues.push(
          `- [${statusLabel}] ${section.section_name}: ${item.label}${
            item.notes ? ` - ${item.notes}` : ''
          }`
        )
      }
    }
  }

  // Build recommendations list
  const recommendations = data.recommendations
    .map(
      (rec) =>
        `- [${rec.priority.toUpperCase()}] ${rec.title}: ${rec.description}`
    )
    .join('\n')

  return `You are a professional home inspector writing a summary for a luxury home care report. Write in a professional, reassuring tone appropriate for high-net-worth homeowners.

PROPERTY INFORMATION:
- Property: ${data.property_name}
- Address: ${data.property_address}
- Client: ${data.client_name}
- Inspection Date: ${data.inspection_date}
- Inspection Type: ${data.inspection_type}
- Overall Condition: ${data.overall_condition || 'Not rated'}
${data.weather ? `- Weather: ${data.weather.temperature}Â°F, ${data.weather.humidity}% humidity, ${data.weather.conditions}` : ''}

INSPECTION RESULTS:
- Total Items Checked: ${data.findings_summary.total_items}
- Passed: ${data.findings_summary.passed}
- Failed: ${data.findings_summary.failed}
- Needs Attention: ${data.findings_summary.needs_attention}
- Urgent Issues: ${data.findings_summary.urgent}
- Not Applicable: ${data.findings_summary.not_applicable}

${data.inspector_summary ? `INSPECTOR'S NOTES:\n${data.inspector_summary}\n` : ''}

${issues.length > 0 ? `ISSUES FOUND:\n${issues.join('\n')}\n` : 'No significant issues found.'}

${recommendations ? `RECOMMENDATIONS:\n${recommendations}\n` : 'No specific recommendations at this time.'}

Please generate a professional report summary with the following sections. Format your response as JSON:

{
  "executive_summary": "A 2-3 paragraph professional summary of the inspection findings, written for the homeowner. Be reassuring where appropriate, but honest about any concerns.",
  "key_findings": ["Array of 3-5 bullet points highlighting the most important observations"],
  "priority_actions": ["Array of recommended actions in priority order, if any issues were found. Empty array if no issues."],
  "closing_statement": "A brief, professional closing statement thanking them for their trust and commitment to home care."
}

Important guidelines:
- Write for an affluent audience who expects premium service
- Be professional but warm, not overly technical
- Emphasize proactive care and prevention
- For "excellent" or "good" conditions, be reassuring
- For issues, be clear but not alarmist
- Always end on a positive, forward-looking note`
}

function parseResponse(text: string): ReportSummaryResponse {
  // Try to extract JSON from the response
  const jsonMatch = text.match(/\{[\s\S]*\}/)
  if (!jsonMatch) {
    // Return a fallback response
    return {
      executive_summary:
        'This property has been inspected according to our comprehensive standards. Please review the detailed findings in the sections below.',
      key_findings: ['Inspection completed successfully'],
      priority_actions: [],
      closing_statement:
        'Thank you for trusting Ross Built Home Care with your property. We are committed to maintaining your home to the highest standards.',
    }
  }

  try {
    const parsed = JSON.parse(jsonMatch[0])
    return {
      executive_summary:
        parsed.executive_summary || 'Inspection summary not available.',
      key_findings: Array.isArray(parsed.key_findings)
        ? parsed.key_findings
        : [],
      priority_actions: Array.isArray(parsed.priority_actions)
        ? parsed.priority_actions
        : [],
      closing_statement:
        parsed.closing_statement ||
        'Thank you for choosing Ross Built Home Care.',
    }
  } catch (e) {
    console.error('Failed to parse response:', e)
    return {
      executive_summary: text.slice(0, 500),
      key_findings: [],
      priority_actions: [],
      closing_statement:
        'Thank you for choosing Ross Built Home Care.',
    }
  }
}
```
  </action>
  <verify>Deno checks: deno check supabase/functions/generate-report-summary/index.ts</verify>
  <done>AI summary edge function with Claude API integration</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Edge function file exists
- [ ] Function handles request/response correctly
- [ ] Prompt generates professional summaries
- [ ] JSON parsing has fallback handling
</verification>

<success_criteria>
- All tasks completed
- Edge function compiles with Deno
- Professional tone in generated summaries
- Error handling for API failures
</success_criteria>

<output>
After completion, create `.planning/phases/08-findings-reports/08-03-SUMMARY.md`
</output>
