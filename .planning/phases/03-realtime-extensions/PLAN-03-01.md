---
wave: 1
depends_on: []
files_modified:
  - apps/admin/src/hooks/use-realtime-sync.ts
autonomous: true
status: complete
---

# Plan 03-01: Extend Realtime Subscriptions

## Objective

Extend real-time subscriptions to programs and notifications tables so data changes propagate instantly to all connected users. This enables instant cross-portal synchronization when clients modify their plans or when notifications are created.

## Prerequisites

- Phase 2 Core Entities complete (base realtime sync infrastructure exists)
- `useRealtimeSync` hook operational
- React Query cache invalidation pattern established

## Files Created/Modified

| File | Change Type | Description |
|------|-------------|-------------|
| `apps/admin/src/hooks/use-realtime-sync.ts` | Modified | Extended TableName type, query key mappings, and sync hooks |

## Implementation Tasks

### Task 1: Extend TableName Type (auto)

**Files:** `apps/admin/src/hooks/use-realtime-sync.ts`

**Action:** Added 'programs' and 'notifications' to the TableName union type:

```typescript
type TableName =
  | 'clients'
  | 'properties'
  // ... existing tables ...
  | 'programs'      // NEW
  | 'notifications' // NEW
```

**Verify:** TypeScript compilation succeeds
**Done:** New table types recognized throughout the hook

### Task 2: Configure Query Key Mappings (auto)

**Files:** `apps/admin/src/hooks/use-realtime-sync.ts`

**Action:** Added cache invalidation mappings for new tables:

```typescript
const queryKeyMap: Record<TableName, string[][]> = {
  // ... existing mappings ...
  programs: [['programs'], ['portal', 'plan'], ['portal', 'dashboard'], ['admin', 'properties-overview']],
  notifications: [['notifications'], ['portal', 'notifications'], ['admin', 'notifications']],
}
```

**Verify:** Query keys match actual React Query usage patterns
**Done:** Cache invalidation triggers for all relevant views

### Task 3: Update Global Realtime Sync (auto)

**Files:** `apps/admin/src/hooks/use-realtime-sync.ts`

**Action:** Added programs and notifications to `useGlobalRealtimeSync()` tables array:
- Admin dashboard receives live updates when any client modifies their plan
- Notifications appear instantly across all connected users

**Verify:** `useGlobalRealtimeSync` includes both new tables
**Done:** Admin portal receives real-time updates for programs and notifications

### Task 4: Update Portal Realtime Sync (auto)

**Files:** `apps/admin/src/hooks/use-realtime-sync.ts`

**Action:** Added programs and notifications to `usePortalRealtimeSync()` tables array:
- Client portal sees plan changes in real-time
- Clients receive notifications instantly without page refresh

**Verify:** `usePortalRealtimeSync` includes both new tables
**Done:** Client portal receives real-time updates for programs and notifications

## Verification

1. **Subscription Flow:**
   - When user loads app, `useRealtimeSync` subscribes to Supabase channels for all configured tables
   - Subscriptions filter by `organization_id=eq.${orgId}` for security
   - Listens for INSERT, UPDATE, DELETE events on each table
   - On any event, invalidates relevant React Query cache keys
   - React Query automatically refetches stale data

2. **TypeScript:** No compilation errors
3. **Console Logs:** `[Realtime] programs INSERT/UPDATE/DELETE` and `[Realtime] notifications INSERT/UPDATE/DELETE` appear when data changes

## must_haves

- Programs table has realtime subscription
- Notifications table has realtime subscription
- Admin dashboard sees plan changes from clients instantly
- Client portal sees plan changes in real-time
- Query cache invalidation triggers on database changes
- Subscriptions filter by organization_id for multi-tenant security
