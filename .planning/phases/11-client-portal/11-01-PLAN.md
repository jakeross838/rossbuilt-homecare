# Plan 11-01: Client Portal Data Foundation

## Objective

Create the type definitions, constants, and validation schemas for the client portal. This establishes the data foundation for portal-specific features including client dashboard, property views, service requests, and recommendation approvals.

## Dependencies

- Phase 10 complete (Billing & Invoicing)
- Existing types: `Tables<'clients'>`, `Tables<'properties'>`, `Tables<'inspections'>`, etc.
- Existing RLS policies supporting `user_role = 'client'` via `get_user_client_id()`

## Constraints

- Client portal uses same Supabase backend but different auth context (client role)
- Must work with existing RLS policies for client access
- Reuse existing types where possible, extend for portal-specific views

## Tasks

### Task 1: Client Portal Types

Create `apps/admin/src/lib/types/portal.ts`:

```typescript
import type { Tables, Enums } from '@/lib/supabase'

/**
 * Client portal types for client-facing views
 */

// Client profile as seen in portal
export interface PortalClient {
  id: string
  first_name: string
  last_name: string
  email: string | null
  phone: string | null
  secondary_first_name: string | null
  secondary_last_name: string | null
  secondary_email: string | null
  secondary_phone: string | null
}

// Property summary for portal dashboard
export interface PortalProperty {
  id: string
  name: string
  address_line1: string
  city: string
  state: string
  zip: string
  primary_photo_url: string | null

  // Program summary
  program: {
    id: string
    tier: Enums<'inspection_tier'>
    frequency: Enums<'inspection_frequency'>
    status: Enums<'program_status'>
    monthly_price: number
    next_inspection_date: string | null
  } | null

  // Status indicators
  equipment_count: number
  open_work_order_count: number
  pending_recommendation_count: number
  last_inspection_date: string | null
  overall_condition: Enums<'condition_rating'> | null
}

// Property detail with full information for portal
export interface PortalPropertyDetail extends PortalProperty {
  address_line2: string | null
  property_type: string | null
  square_footage: number | null
  year_built: number | null

  // Access info (limited view for client)
  gate_code: string | null
  alarm_code: string | null

  // Equipment list
  equipment: PortalEquipment[]

  // Recent inspections
  recent_inspections: PortalInspection[]

  // Active work orders
  active_work_orders: PortalWorkOrder[]

  // Pending recommendations
  pending_recommendations: PortalRecommendation[]
}

// Equipment as seen by client
export interface PortalEquipment {
  id: string
  name: string
  category: string
  location: string | null
  condition: Enums<'condition_rating'> | null
  last_serviced_at: string | null
  next_service_date: string | null
}

// Inspection summary for client
export interface PortalInspection {
  id: string
  inspection_date: string
  inspection_type: Enums<'inspection_tier'>
  status: Enums<'inspection_status'>
  overall_condition: Enums<'condition_rating'> | null
  summary: string | null
  report_url: string | null

  // Inspector info
  inspector: {
    first_name: string
    last_name: string
  } | null

  // Findings summary
  findings_summary: {
    total: number
    passed: number
    needs_attention: number
    urgent: number
  }
}

// Work order as seen by client
export interface PortalWorkOrder {
  id: string
  work_order_number: string
  title: string
  description: string | null
  category: string
  priority: Enums<'priority_level'>
  status: Enums<'work_order_status'>
  estimated_cost: number | null
  client_cost: number | null
  scheduled_date: string | null
  completed_at: string | null
  created_at: string
}

// Recommendation awaiting client approval
export interface PortalRecommendation {
  id: string
  title: string
  description: string
  priority: Enums<'priority_level'>
  status: Enums<'recommendation_status'>
  estimated_cost: number | null
  category: string

  // Source inspection
  inspection: {
    id: string
    inspection_date: string
  } | null

  created_at: string
}

// Service request from client portal
export interface PortalServiceRequest {
  id: string
  request_number: string
  request_type: string
  title: string
  description: string
  priority: Enums<'priority_level'>
  status: Enums<'service_request_status'>
  photos: string[]

  // Property info
  property: {
    id: string
    name: string
    address_line1: string
  }

  // Resolution
  resolution: string | null
  resolved_at: string | null

  // Communication
  acknowledged_at: string | null
  work_order_id: string | null

  created_at: string
  updated_at: string
}

// Service request comment (non-internal only for clients)
export interface PortalServiceRequestComment {
  id: string
  comment: string
  created_at: string

  // User info (may be client or staff)
  user: {
    first_name: string
    last_name: string
    role: Enums<'user_role'>
  } | null
}

// Invoice as seen by client
export interface PortalInvoice {
  id: string
  invoice_number: string
  status: Enums<'invoice_status'>
  issue_date: string
  due_date: string
  total: number
  balance_due: number

  // Line items
  line_items: {
    description: string
    quantity: number
    unit_price: number
    amount: number
  }[]

  // Payment link
  stripe_payment_url: string | null
}

// Dashboard summary for client portal home
export interface PortalDashboardSummary {
  properties_count: number
  upcoming_inspections: number
  open_service_requests: number
  pending_approvals: number
  outstanding_balance: number
}
```

### Task 2: Client Portal Constants

Create `apps/admin/src/lib/constants/portal.ts`:

```typescript
/**
 * Client portal constants
 */

// Service request types
export const SERVICE_REQUEST_TYPES = [
  { value: 'maintenance', label: 'Maintenance Request', description: 'General home maintenance needs' },
  { value: 'emergency', label: 'Emergency', description: 'Urgent issues requiring immediate attention' },
  { value: 'storm_prep', label: 'Storm Preparation', description: 'Pre-storm preparation services' },
  { value: 'arrival', label: 'Arrival Preparation', description: 'Prepare home for your arrival' },
  { value: 'departure', label: 'Departure Services', description: 'Services when leaving the property' },
  { value: 'question', label: 'Question', description: 'General questions about your property' },
  { value: 'other', label: 'Other', description: 'Other requests' },
] as const

export type ServiceRequestType = typeof SERVICE_REQUEST_TYPES[number]['value']

// Service request status display config
export const SERVICE_REQUEST_STATUS_CONFIG = {
  new: { label: 'New', color: 'bg-blue-100 text-blue-800', description: 'Request submitted' },
  acknowledged: { label: 'Acknowledged', color: 'bg-purple-100 text-purple-800', description: 'We\'ve received your request' },
  in_progress: { label: 'In Progress', color: 'bg-yellow-100 text-yellow-800', description: 'Being worked on' },
  scheduled: { label: 'Scheduled', color: 'bg-cyan-100 text-cyan-800', description: 'Work has been scheduled' },
  completed: { label: 'Completed', color: 'bg-green-100 text-green-800', description: 'Request completed' },
  cancelled: { label: 'Cancelled', color: 'bg-gray-100 text-gray-600', description: 'Request cancelled' },
} as const

// Recommendation response options for client
export const RECOMMENDATION_RESPONSES = [
  { value: 'approved', label: 'Approve', description: 'Proceed with this recommendation' },
  { value: 'declined', label: 'Decline', description: 'Do not proceed at this time' },
] as const

// Portal navigation items
export const PORTAL_NAV_ITEMS = [
  { label: 'Dashboard', href: '/portal', icon: 'LayoutDashboard' },
  { label: 'Properties', href: '/portal/properties', icon: 'Home' },
  { label: 'Inspections', href: '/portal/inspections', icon: 'ClipboardCheck' },
  { label: 'Service Requests', href: '/portal/requests', icon: 'MessageSquare' },
  { label: 'Invoices', href: '/portal/invoices', icon: 'Receipt' },
] as const

// Condition rating display for client-friendly language
export const CONDITION_DISPLAY = {
  excellent: { label: 'Excellent', description: 'No issues found', color: 'text-green-600' },
  good: { label: 'Good', description: 'Minor items noted', color: 'text-green-500' },
  fair: { label: 'Fair', description: 'Some attention needed', color: 'text-yellow-600' },
  needs_attention: { label: 'Needs Attention', description: 'Issues requiring action', color: 'text-orange-500' },
  poor: { label: 'Poor', description: 'Significant issues present', color: 'text-red-600' },
} as const

// Priority display for clients
export const PRIORITY_DISPLAY = {
  low: { label: 'Low', color: 'bg-gray-100 text-gray-700' },
  medium: { label: 'Medium', color: 'bg-blue-100 text-blue-700' },
  high: { label: 'High', color: 'bg-orange-100 text-orange-700' },
  urgent: { label: 'Urgent', color: 'bg-red-100 text-red-700' },
} as const
```

### Task 3: Service Request Validation Schemas

Create `apps/admin/src/lib/validations/service-request.ts`:

```typescript
import { z } from 'zod'

/**
 * Service request validation schemas for client portal
 */

// Create service request (from client)
export const createServiceRequestSchema = z.object({
  property_id: z.string().uuid('Please select a property'),
  request_type: z.enum([
    'maintenance',
    'emergency',
    'storm_prep',
    'arrival',
    'departure',
    'question',
    'other',
  ], { required_error: 'Please select a request type' }),
  title: z.string()
    .min(5, 'Title must be at least 5 characters')
    .max(100, 'Title must be less than 100 characters'),
  description: z.string()
    .min(10, 'Please provide more details (at least 10 characters)')
    .max(2000, 'Description must be less than 2000 characters'),
  priority: z.enum(['low', 'medium', 'high', 'urgent']).default('medium'),
  photos: z.array(z.string().url()).max(10, 'Maximum 10 photos allowed').optional(),
})

export type CreateServiceRequestInput = z.infer<typeof createServiceRequestSchema>

// Add comment to service request
export const addServiceRequestCommentSchema = z.object({
  service_request_id: z.string().uuid(),
  comment: z.string()
    .min(1, 'Comment cannot be empty')
    .max(1000, 'Comment must be less than 1000 characters'),
})

export type AddServiceRequestCommentInput = z.infer<typeof addServiceRequestCommentSchema>

// Recommendation response from client
export const recommendationResponseSchema = z.object({
  recommendation_id: z.string().uuid(),
  status: z.enum(['approved', 'declined']),
  notes: z.string().max(500, 'Notes must be less than 500 characters').optional(),
})

export type RecommendationResponseInput = z.infer<typeof recommendationResponseSchema>
```

### Task 4: Portal Helper Functions

Create `apps/admin/src/lib/helpers/portal.ts`:

```typescript
import type { Enums } from '@/lib/supabase'
import { CONDITION_DISPLAY, PRIORITY_DISPLAY, SERVICE_REQUEST_STATUS_CONFIG } from '@/lib/constants/portal'

/**
 * Portal helper functions
 */

// Format condition for client-friendly display
export function formatCondition(condition: Enums<'condition_rating'> | null): {
  label: string
  description: string
  color: string
} {
  if (!condition) {
    return { label: 'Not Rated', description: 'Condition not yet assessed', color: 'text-gray-400' }
  }
  return CONDITION_DISPLAY[condition]
}

// Get priority badge styles
export function getPriorityStyles(priority: Enums<'priority_level'>): {
  label: string
  color: string
} {
  return PRIORITY_DISPLAY[priority]
}

// Get service request status display
export function getServiceRequestStatus(status: Enums<'service_request_status'>): {
  label: string
  color: string
  description: string
} {
  return SERVICE_REQUEST_STATUS_CONFIG[status]
}

// Format inspection tier for display
export function formatInspectionTier(tier: Enums<'inspection_tier'>): string {
  const labels: Record<Enums<'inspection_tier'>, string> = {
    visual: 'Visual Inspection',
    functional: 'Functional Inspection',
    comprehensive: 'Comprehensive Inspection',
    preventative: 'Preventative Care',
  }
  return labels[tier]
}

// Format frequency for display
export function formatFrequency(frequency: Enums<'inspection_frequency'>): string {
  const labels: Record<Enums<'inspection_frequency'>, string> = {
    annual: 'Annual',
    semi_annual: 'Semi-Annual',
    quarterly: 'Quarterly',
    monthly: 'Monthly',
    bi_weekly: 'Bi-Weekly',
  }
  return labels[frequency]
}

// Calculate days until next inspection
export function getDaysUntilInspection(nextDate: string | null): number | null {
  if (!nextDate) return null
  const today = new Date()
  today.setHours(0, 0, 0, 0)
  const inspection = new Date(nextDate)
  inspection.setHours(0, 0, 0, 0)
  const diffTime = inspection.getTime() - today.getTime()
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24))
}

// Format relative date for client display
export function formatRelativeDate(date: string): string {
  const now = new Date()
  const target = new Date(date)
  const diffDays = Math.floor((target.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))

  if (diffDays === 0) return 'Today'
  if (diffDays === 1) return 'Tomorrow'
  if (diffDays === -1) return 'Yesterday'
  if (diffDays > 0 && diffDays < 7) return `In ${diffDays} days`
  if (diffDays < 0 && diffDays > -7) return `${Math.abs(diffDays)} days ago`

  return target.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: target.getFullYear() !== now.getFullYear() ? 'numeric' : undefined,
  })
}

// Get property health summary
export function getPropertyHealth(property: {
  open_work_order_count: number
  pending_recommendation_count: number
  overall_condition: Enums<'condition_rating'> | null
}): {
  status: 'good' | 'attention' | 'urgent'
  label: string
  color: string
} {
  // Urgent if any urgent work orders or poor condition
  if (property.overall_condition === 'poor') {
    return { status: 'urgent', label: 'Needs Attention', color: 'text-red-600' }
  }

  // Attention needed if work orders or recommendations pending
  if (property.open_work_order_count > 0 || property.pending_recommendation_count > 0) {
    return { status: 'attention', label: 'Action Items Pending', color: 'text-yellow-600' }
  }

  // Good if no issues
  return { status: 'good', label: 'All Good', color: 'text-green-600' }
}
```

## Verification

After completing all tasks, verify:

1. **Types compile**: `cd apps/admin && npx tsc --noEmit`
2. **Files exist**:
   - `apps/admin/src/lib/types/portal.ts`
   - `apps/admin/src/lib/constants/portal.ts`
   - `apps/admin/src/lib/validations/service-request.ts`
   - `apps/admin/src/lib/helpers/portal.ts`
3. **Exports work**: Types and functions are properly exported

## Commit

```
feat(portal): add client portal data foundation

- Add portal types (PortalClient, PortalProperty, PortalInspection, etc.)
- Add portal constants (request types, status configs, navigation)
- Add service request validation schemas
- Add portal helper functions for display formatting
```
