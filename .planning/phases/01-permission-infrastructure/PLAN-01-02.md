# Plan 01-02: Route Protection and UI Guards

## Objective
Implement route protection guards and UI filtering to enforce the permission matrix. This includes an auth guard component for protected routes, sidebar filtering to hide unauthorized pages, and integration with the main App router.

## Requirements Addressed
- **PERM-02**: Pages are shown/hidden/blocked based on user role per permission matrix
- **QA-02**: Permission matrix is enforced (each role can only access allowed pages)

## Prerequisites
- Plan 01-01 completed: Permission system setup (roles, matrix, ability, hooks, provider)
- Existing files:
  - `apps/admin/src/App.tsx` - Main router configuration
  - `apps/admin/src/components/layout/app-layout.tsx` - Protected layout wrapper
  - `apps/admin/src/components/layout/sidebar.tsx` - Navigation sidebar
  - `apps/admin/src/components/providers/auth-provider.tsx` - Auth initialization

## Files to Create/Modify

### New Files
- `apps/admin/src/components/guards/permission-guard.tsx` — Route protection guard component
- `apps/admin/src/components/guards/index.ts` — Guard exports

### Modified Files
- `apps/admin/src/App.tsx` — Add PermissionProvider, wrap routes with guards
- `apps/admin/src/components/layout/app-layout.tsx` — Add permission check before rendering
- `apps/admin/src/components/layout/sidebar.tsx` — Filter nav items by permission

## Implementation Tasks

### Task 1: Create Permission Guard Component
**File:** `apps/admin/src/components/guards/permission-guard.tsx`
**Action:** Create

```typescript
/**
 * Permission Guard Component
 *
 * Protects routes by checking if the current user has permission to access them.
 * Redirects unauthorized users to appropriate fallback pages.
 */

import { Navigate, useLocation } from 'react-router-dom'
import { Loader2 } from 'lucide-react'
import { usePermissions } from '@/hooks/use-permissions'
import { routeToPageSubject } from '@/lib/permissions/matrix'

interface PermissionGuardProps {
  children: React.ReactNode
  /** Optional fallback path. If not provided, uses role-based default redirect */
  fallback?: string
}

/**
 * Permission Guard
 *
 * Wraps protected content and checks if the user has permission to view it.
 * Shows loading state while permissions are being determined.
 * Redirects unauthorized users to the appropriate page.
 *
 * @example
 * ```tsx
 * <PermissionGuard>
 *   <DashboardPage />
 * </PermissionGuard>
 * ```
 */
export function PermissionGuard({ children, fallback }: PermissionGuardProps) {
  const location = useLocation()
  const { isLoading, canAccessRoute, getRedirectPath, role } = usePermissions()

  // Show loading state while checking permissions
  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <Loader2 className="h-8 w-8 animate-spin text-gray-400" />
      </div>
    )
  }

  // Check if user can access current route
  const pageSubject = routeToPageSubject(location.pathname)

  // If route doesn't map to a protected page, allow access
  // (let the router handle 404s for truly unknown routes)
  if (!pageSubject) {
    return <>{children}</>
  }

  // Check permission for the route
  if (!canAccessRoute(location.pathname)) {
    // Determine redirect path
    const redirectTo = fallback || getRedirectPath()

    // Log unauthorized access attempt (useful for debugging)
    console.warn(
      `[PermissionGuard] Unauthorized access attempt: ${location.pathname} by role: ${role}`
    )

    return <Navigate to={redirectTo} state={{ from: location }} replace />
  }

  return <>{children}</>
}

/**
 * Higher-order component version for wrapping route elements
 *
 * @example
 * ```tsx
 * <Route path="/dashboard" element={withPermissionGuard(<DashboardPage />)} />
 * ```
 */
export function withPermissionGuard(
  element: React.ReactNode,
  fallback?: string
): React.ReactNode {
  return <PermissionGuard fallback={fallback}>{element}</PermissionGuard>
}

export default PermissionGuard
```

### Task 2: Create Guards Index Export
**File:** `apps/admin/src/components/guards/index.ts`
**Action:** Create

```typescript
/**
 * Guard components exports
 */

export { PermissionGuard, withPermissionGuard } from './permission-guard'
```

### Task 3: Update App Layout with Permission Check
**File:** `apps/admin/src/components/layout/app-layout.tsx`
**Action:** Modify

Update the app layout to include permission checking for the entire protected area:

```typescript
import { Outlet, Navigate, useLocation } from 'react-router-dom'
import { Loader2 } from 'lucide-react'

import { Sidebar } from './sidebar'
import { Header } from './header'
import { Toaster } from '@/components/ui/toaster'
import { useAuthStore } from '@/stores/auth-store'
import { useGlobalRealtimeSync } from '@/hooks/use-realtime-sync'
import { usePermissions } from '@/hooks/use-permissions'
import { routeToPageSubject } from '@/lib/permissions/matrix'

export function AppLayout() {
  const location = useLocation()
  const { user, isLoading: authLoading } = useAuthStore()
  const { isLoading: permLoading, canAccessRoute, getRedirectPath, isClient } = usePermissions()

  // Enable real-time sync for all data tables
  useGlobalRealtimeSync()

  const isLoading = authLoading || permLoading

  // Show loading state during auth operations (sign in/out)
  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-background">
        <div className="flex flex-col items-center gap-4">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
          <p className="text-muted-foreground">Loading...</p>
        </div>
      </div>
    )
  }

  // Redirect to login if not authenticated
  if (!user) {
    return <Navigate to="/login" state={{ from: location }} replace />
  }

  // Redirect clients to the portal (they shouldn't be in admin layout)
  if (isClient) {
    return <Navigate to="/portal" replace />
  }

  // Check if user can access current route
  const pageSubject = routeToPageSubject(location.pathname)
  if (pageSubject && !canAccessRoute(location.pathname)) {
    const redirectTo = getRedirectPath()
    console.warn(
      `[AppLayout] Unauthorized access: ${location.pathname}, redirecting to: ${redirectTo}`
    )
    return <Navigate to={redirectTo} replace />
  }

  return (
    <div className="flex h-screen bg-background">
      {/* Skip to main content link for keyboard users */}
      <a
        href="#main-content"
        className="sr-only focus:not-sr-only focus:absolute focus:z-[100] focus:top-4 focus:left-4 focus:bg-primary focus:text-primary-foreground focus:px-4 focus:py-2 focus:rounded-md"
      >
        Skip to main content
      </a>

      {/* Sidebar */}
      <Sidebar />

      {/* Main content area */}
      <div className="flex-1 flex flex-col overflow-hidden">
        {/* Header */}
        <Header />

        {/* Page content */}
        <main
          id="main-content"
          className="flex-1 overflow-y-auto p-4 lg:p-6"
          role="main"
          aria-label="Main content"
        >
          <Outlet />
        </main>
      </div>

      {/* Toast notifications - live region for screen readers */}
      <Toaster />
    </div>
  )
}

export default AppLayout
```

### Task 4: Update Sidebar with Permission Filtering
**File:** `apps/admin/src/components/layout/sidebar.tsx`
**Action:** Modify

Update the sidebar to filter navigation items based on user permissions:

```typescript
import { useEffect, useMemo } from 'react'
import { NavLink, useLocation } from 'react-router-dom'
import {
  LayoutDashboard,
  Calendar,
  Users,
  Building2,
  ClipboardCheck,
  Wrench,
  Receipt,
  Truck,
  BarChart3,
  Activity,
  Settings,
  DollarSign,
  FileText,
  ChevronLeft,
  ChevronRight,
  X,
} from 'lucide-react'

import { cn } from '@/lib/utils'
import { Button } from '@/components/ui/button'
import { Separator } from '@/components/ui/separator'
import { useUIStore } from '@/stores/ui-store'
import { VersionDisplay } from './version-display'
import { usePermissions } from '@/hooks/use-permissions'
import type { PageSubject } from '@/lib/permissions/matrix'

interface NavItem {
  title: string
  href: string
  icon: React.ComponentType<{ className?: string }>
  /** Permission subject for this nav item */
  permission: PageSubject
}

/**
 * All navigation items with their permission requirements
 */
const allNavItems: NavItem[] = [
  { title: 'Dashboard', href: '/dashboard', icon: LayoutDashboard, permission: 'dashboard' },
  { title: 'Calendar', href: '/calendar', icon: Calendar, permission: 'calendar' },
  { title: 'Clients', href: '/clients', icon: Users, permission: 'clients' },
  { title: 'Properties', href: '/properties', icon: Building2, permission: 'properties' },
  { title: 'Inspections', href: '/inspections', icon: ClipboardCheck, permission: 'inspections' },
  { title: 'Work Orders', href: '/work-orders', icon: Wrench, permission: 'work-orders' },
  { title: 'Billing', href: '/billing', icon: Receipt, permission: 'billing' },
  { title: 'Vendors', href: '/vendors', icon: Truck, permission: 'vendors' },
  { title: 'Reports', href: '/reports', icon: BarChart3, permission: 'reports' },
  { title: 'Activity', href: '/activity', icon: Activity, permission: 'activity' },
]

const allBottomNavItems: NavItem[] = [
  { title: 'Templates', href: '/settings/templates', icon: FileText, permission: 'settings' },
  { title: 'Pricing', href: '/settings/pricing', icon: DollarSign, permission: 'settings' },
  { title: 'Settings', href: '/settings', icon: Settings, permission: 'settings' },
]

export function Sidebar() {
  const location = useLocation()
  const { sidebarOpen, sidebarCollapsed, toggleSidebarCollapsed, setSidebarOpen } = useUIStore()
  const { canAccess, isLoading } = usePermissions()

  // Filter navigation items based on permissions
  const navItems = useMemo(() => {
    if (isLoading) return []
    return allNavItems.filter((item) => canAccess(item.permission))
  }, [canAccess, isLoading])

  const bottomNavItems = useMemo(() => {
    if (isLoading) return []
    return allBottomNavItems.filter((item) => canAccess(item.permission))
  }, [canAccess, isLoading])

  // Close mobile sidebar on navigation
  useEffect(() => {
    setSidebarOpen(false)
  }, [location.pathname, setSidebarOpen])

  // Close mobile sidebar on escape key
  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        setSidebarOpen(false)
      }
    }
    document.addEventListener('keydown', handleEscape)
    return () => document.removeEventListener('keydown', handleEscape)
  }, [setSidebarOpen])

  const sidebarContent = (isMobile: boolean) => (
    <>
      {/* Logo */}
      <div className="flex items-center justify-between h-16 px-4 border-b">
        <div className="flex items-center gap-3">
          <div className="flex-shrink-0 w-8 h-8 rounded-full bg-rb-green-500 flex items-center justify-center">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
              className="w-4 h-4 text-white"
            >
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
              <polyline points="9 22 9 12 15 12 15 22" />
            </svg>
          </div>
          {(isMobile || !sidebarCollapsed) && (
            <div className="flex flex-col">
              <span className="font-semibold text-foreground">Ross Built</span>
              <span className="text-xs text-muted-foreground">Home Care OS</span>
            </div>
          )}
        </div>
        {/* Mobile close button */}
        {isMobile && (
          <Button
            variant="ghost"
            size="icon"
            onClick={() => setSidebarOpen(false)}
            aria-label="Close sidebar"
          >
            <X className="h-5 w-5" />
          </Button>
        )}
      </div>

      {/* Navigation */}
      <nav className="flex-1 px-2 py-4 overflow-y-auto" aria-label="Main navigation">
        <ul className="space-y-1" role="list">
          {navItems.map((item) => (
            <li key={item.href}>
              <NavLink
                to={item.href}
                className={({ isActive }) =>
                  cn(
                    'flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors',
                    'hover:bg-accent hover:text-accent-foreground',
                    isActive
                      ? 'bg-primary text-primary-foreground hover:bg-primary/90 hover:text-primary-foreground'
                      : 'text-muted-foreground',
                    !isMobile && sidebarCollapsed && 'justify-center'
                  )
                }
                title={!isMobile && sidebarCollapsed ? item.title : undefined}
              >
                <item.icon className="h-5 w-5 flex-shrink-0" />
                {(isMobile || !sidebarCollapsed) && <span>{item.title}</span>}
              </NavLink>
            </li>
          ))}
        </ul>
      </nav>

      {/* Bottom section */}
      <div className="px-2 py-4 border-t">
        <ul className="space-y-1">
          {bottomNavItems.map((item) => (
            <li key={item.href}>
              <NavLink
                to={item.href}
                className={({ isActive }) =>
                  cn(
                    'flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors',
                    'hover:bg-accent hover:text-accent-foreground',
                    isActive
                      ? 'bg-primary text-primary-foreground hover:bg-primary/90 hover:text-primary-foreground'
                      : 'text-muted-foreground',
                    !isMobile && sidebarCollapsed && 'justify-center'
                  )
                }
                title={!isMobile && sidebarCollapsed ? item.title : undefined}
              >
                <item.icon className="h-5 w-5 flex-shrink-0" />
                {(isMobile || !sidebarCollapsed) && <span>{item.title}</span>}
              </NavLink>
            </li>
          ))}
        </ul>

        {/* Version display */}
        <Separator className="my-4" />
        <VersionDisplay collapsed={!isMobile && sidebarCollapsed} />

        {/* Collapse toggle - desktop only */}
        {!isMobile && (
          <>
            <Separator className="my-4" />
            <Button
              variant="ghost"
              size="sm"
              className={cn(
                'w-full justify-center',
                !sidebarCollapsed && 'justify-start'
              )}
              onClick={toggleSidebarCollapsed}
            >
              {sidebarCollapsed ? (
                <ChevronRight className="h-4 w-4" />
              ) : (
                <>
                  <ChevronLeft className="h-4 w-4 mr-2" />
                  <span>Collapse</span>
                </>
              )}
            </Button>
          </>
        )}
      </div>
    </>
  )

  return (
    <>
      {/* Mobile overlay */}
      {sidebarOpen && (
        <div
          className="fixed inset-0 bg-black/50 z-40 lg:hidden"
          onClick={() => setSidebarOpen(false)}
          aria-hidden="true"
        />
      )}

      {/* Sidebar - Mobile (drawer) */}
      <aside
        className={cn(
          'fixed inset-y-0 left-0 z-50 flex flex-col w-64 bg-card border-r transform transition-transform duration-300 lg:hidden',
          sidebarOpen ? 'translate-x-0' : '-translate-x-full'
        )}
      >
        {sidebarContent(true)}
      </aside>

      {/* Sidebar - Desktop (static) */}
      <aside
        className={cn(
          'hidden lg:flex flex-col h-screen bg-card border-r transition-all duration-300',
          sidebarCollapsed ? 'w-16' : 'w-64'
        )}
      >
        {sidebarContent(false)}
      </aside>
    </>
  )
}

export default Sidebar
```

### Task 5: Update App.tsx with Permission Provider
**File:** `apps/admin/src/App.tsx`
**Action:** Modify

Wrap the application with PermissionProvider and ensure proper ordering of providers:

```typescript
import { lazy, Suspense } from 'react'
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { Loader2 } from 'lucide-react'

import { AuthProvider } from '@/components/providers/auth-provider'
import { PermissionProvider } from '@/components/providers/permission-provider'
import { ErrorBoundary, PageErrorBoundary } from '@/components/shared/error-boundary'
import { AppLayout } from '@/components/layout/app-layout'

// Eagerly loaded pages (critical path)
import LoginPage from '@/pages/auth/login'
import DashboardPage from '@/pages/dashboard'

// Lazy-loaded pages (code splitting)
const ClientsPage = lazy(() => import('@/pages/clients'))
const NewClientPage = lazy(() => import('@/pages/clients/new'))
const ClientDetailPage = lazy(() => import('@/pages/clients/[id]'))
const EditClientPage = lazy(() => import('@/pages/clients/[id]/edit'))
const PropertiesPage = lazy(() => import('@/pages/properties'))
const NewPropertyPage = lazy(() => import('@/pages/properties/new'))
const PropertyDetailPage = lazy(() => import('@/pages/properties/[id]'))
const EditPropertyPage = lazy(() => import('@/pages/properties/[id]/edit'))
const SettingsPage = lazy(() => import('@/pages/settings'))
const OrganizationSettingsPage = lazy(() => import('@/pages/settings/organization'))
const ProfileSettingsPage = lazy(() => import('@/pages/settings/profile'))
const PricingSettingsPage = lazy(() => import('@/pages/settings/pricing'))
const TemplatesPage = lazy(() => import('@/pages/settings/templates'))
const CalendarPage = lazy(() => import('@/pages/calendar'))
const InspectionsPage = lazy(() => import('@/pages/inspections'))
const InspectionReportPage = lazy(() => import('@/pages/inspections/report'))
const InspectorDashboard = lazy(() => import('@/pages/inspector'))
const InspectionPage = lazy(() => import('@/pages/inspector/inspection'))
const WorkOrdersPage = lazy(() => import('@/pages/work-orders'))
const NewWorkOrderPage = lazy(() => import('@/pages/work-orders/new'))
const WorkOrderDetailPage = lazy(() => import('@/pages/work-orders/[id]'))
const VendorsPage = lazy(() => import('@/pages/vendors'))
const NewVendorPage = lazy(() => import('@/pages/vendors/new'))
const VendorDetailPage = lazy(() => import('@/pages/vendors/[id]'))
const BillingDashboard = lazy(() => import('@/pages/billing/index'))
const InvoicesPage = lazy(() => import('@/pages/billing/invoices/index'))
const InvoiceDetailPage = lazy(() => import('@/pages/billing/invoices/[id]'))
const ReportsPage = lazy(() => import('@/pages/dashboard/reports'))
const NotificationsPage = lazy(() => import('@/pages/notifications'))
const NotificationSettingsPage = lazy(() => import('@/pages/settings/notifications'))
const ActivityPage = lazy(() => import('@/pages/activity'))

// Loading fallback component
function PageLoader() {
  return (
    <div className="flex items-center justify-center h-64">
      <Loader2 className="h-8 w-8 animate-spin text-rb-green" />
    </div>
  )
}

// Client Portal imports (lazy-loaded)
import { PortalLayout } from '@/components/portal/portal-layout'
import { PortalAuthGuard } from '@/components/portal/portal-auth-guard'
const PortalLoginPage = lazy(() => import('@/pages/portal/login'))
const PortalDashboardPage = lazy(() => import('@/pages/portal'))
const PortalPropertiesPage = lazy(() => import('@/pages/portal/properties'))
const PortalPropertyDetailPage = lazy(() => import('@/pages/portal/properties/[id]'))
const PortalRequestsPage = lazy(() => import('@/pages/portal/requests'))
const PortalRequestDetailPage = lazy(() => import('@/pages/portal/requests/[id]'))
const PortalInvoicesPage = lazy(() => import('@/pages/portal/invoices'))
const PortalInspectionsPage = lazy(() => import('@/pages/portal/inspections'))
const PortalInspectionDetailPage = lazy(() => import('@/pages/portal/inspections/[id]'))
const PortalCalendarPage = lazy(() => import('@/pages/portal/calendar'))
const PortalPlansPage = lazy(() => import('@/pages/portal/plans'))

// Create a query client instance
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5, // 5 minutes
      retry: 1,
    },
  },
})

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <AuthProvider>
        <PermissionProvider>
          <ErrorBoundary>
          <BrowserRouter>
            <Routes>
              {/* Public routes */}
              <Route path="/login" element={<LoginPage />} />

              {/* Inspector routes (standalone mobile PWA - no AppLayout) */}
              <Route path="/inspector" element={<PageErrorBoundary><Suspense fallback={<PageLoader />}><InspectorDashboard /></Suspense></PageErrorBoundary>} />
              <Route path="/inspector/inspection/:id" element={<PageErrorBoundary><Suspense fallback={<PageLoader />}><InspectionPage /></Suspense></PageErrorBoundary>} />

              {/* Client Portal Routes */}
              <Route path="/portal/login" element={<Suspense fallback={<PageLoader />}><PortalLoginPage /></Suspense>} />
              <Route
                path="/portal"
                element={
                  <PageErrorBoundary>
                    <PortalAuthGuard>
                      <PortalLayout />
                    </PortalAuthGuard>
                  </PageErrorBoundary>
                }
              >
                <Route index element={<Suspense fallback={<PageLoader />}><PortalDashboardPage /></Suspense>} />
                <Route path="properties" element={<Suspense fallback={<PageLoader />}><PortalPropertiesPage /></Suspense>} />
                <Route path="properties/:id" element={<Suspense fallback={<PageLoader />}><PortalPropertyDetailPage /></Suspense>} />
                <Route path="calendar" element={<Suspense fallback={<PageLoader />}><PortalCalendarPage /></Suspense>} />
                <Route path="plans" element={<Suspense fallback={<PageLoader />}><PortalPlansPage /></Suspense>} />
                <Route path="requests" element={<Suspense fallback={<PageLoader />}><PortalRequestsPage /></Suspense>} />
                <Route path="requests/:id" element={<Suspense fallback={<PageLoader />}><PortalRequestDetailPage /></Suspense>} />
                <Route path="invoices" element={<Suspense fallback={<PageLoader />}><PortalInvoicesPage /></Suspense>} />
                <Route path="inspections" element={<Suspense fallback={<PageLoader />}><PortalInspectionsPage /></Suspense>} />
                <Route path="inspections/:id" element={<Suspense fallback={<PageLoader />}><PortalInspectionDetailPage /></Suspense>} />
              </Route>

              {/* Protected routes with AppLayout - permission checking done in AppLayout */}
              <Route element={<AppLayout />}>
                {/* Redirect root to dashboard */}
                <Route path="/" element={<Navigate to="/dashboard" replace />} />

                {/* Dashboard */}
                <Route path="/dashboard" element={<DashboardPage />} />

                {/* Clients */}
                <Route path="/clients" element={<Suspense fallback={<PageLoader />}><ClientsPage /></Suspense>} />
                <Route path="/clients/new" element={<Suspense fallback={<PageLoader />}><NewClientPage /></Suspense>} />
                <Route path="/clients/:id" element={<Suspense fallback={<PageLoader />}><ClientDetailPage /></Suspense>} />
                <Route path="/clients/:id/edit" element={<Suspense fallback={<PageLoader />}><EditClientPage /></Suspense>} />

                {/* Properties */}
                <Route path="/properties" element={<Suspense fallback={<PageLoader />}><PropertiesPage /></Suspense>} />
                <Route path="/properties/new" element={<Suspense fallback={<PageLoader />}><NewPropertyPage /></Suspense>} />
                <Route path="/properties/:id" element={<Suspense fallback={<PageLoader />}><PropertyDetailPage /></Suspense>} />
                <Route path="/properties/:id/edit" element={<Suspense fallback={<PageLoader />}><EditPropertyPage /></Suspense>} />

                {/* Calendar */}
                <Route path="/calendar" element={<Suspense fallback={<PageLoader />}><CalendarPage /></Suspense>} />

                {/* Inspections */}
                <Route path="/inspections" element={<Suspense fallback={<PageLoader />}><InspectionsPage /></Suspense>} />
                <Route path="/inspections/:id/report" element={<Suspense fallback={<PageLoader />}><InspectionReportPage /></Suspense>} />

                {/* Work Orders */}
                <Route path="/work-orders" element={<Suspense fallback={<PageLoader />}><WorkOrdersPage /></Suspense>} />
                <Route path="/work-orders/new" element={<Suspense fallback={<PageLoader />}><NewWorkOrderPage /></Suspense>} />
                <Route path="/work-orders/:id" element={<Suspense fallback={<PageLoader />}><WorkOrderDetailPage /></Suspense>} />

                {/* Billing */}
                <Route path="/billing" element={<Suspense fallback={<PageLoader />}><BillingDashboard /></Suspense>} />
                <Route path="/billing/invoices" element={<Suspense fallback={<PageLoader />}><InvoicesPage /></Suspense>} />
                <Route path="/billing/invoices/:id" element={<Suspense fallback={<PageLoader />}><InvoiceDetailPage /></Suspense>} />

                {/* Vendors */}
                <Route path="/vendors" element={<Suspense fallback={<PageLoader />}><VendorsPage /></Suspense>} />
                <Route path="/vendors/new" element={<Suspense fallback={<PageLoader />}><NewVendorPage /></Suspense>} />
                <Route path="/vendors/:id" element={<Suspense fallback={<PageLoader />}><VendorDetailPage /></Suspense>} />

                {/* Reports */}
                <Route path="/reports" element={<Suspense fallback={<PageLoader />}><ReportsPage /></Suspense>} />

                {/* Notifications */}
                <Route path="/notifications" element={<Suspense fallback={<PageLoader />}><NotificationsPage /></Suspense>} />

                {/* Activity */}
                <Route path="/activity" element={<Suspense fallback={<PageLoader />}><ActivityPage /></Suspense>} />

                {/* Settings */}
                <Route path="/settings" element={<Suspense fallback={<PageLoader />}><SettingsPage /></Suspense>} />
                <Route path="/settings/organization" element={<Suspense fallback={<PageLoader />}><OrganizationSettingsPage /></Suspense>} />
                <Route path="/settings/profile" element={<Suspense fallback={<PageLoader />}><ProfileSettingsPage /></Suspense>} />
                <Route path="/settings/pricing" element={<Suspense fallback={<PageLoader />}><PricingSettingsPage /></Suspense>} />
                <Route path="/settings/templates" element={<Suspense fallback={<PageLoader />}><TemplatesPage /></Suspense>} />
                <Route path="/settings/notifications" element={<Suspense fallback={<PageLoader />}><NotificationSettingsPage /></Suspense>} />
              </Route>

              {/* Catch all - redirect to dashboard */}
              <Route path="*" element={<Navigate to="/dashboard" replace />} />
            </Routes>
          </BrowserRouter>
          </ErrorBoundary>
        </PermissionProvider>
      </AuthProvider>
    </QueryClientProvider>
  )
}

export default App
```

### Task 6: Create Permission Provider Export
**File:** `apps/admin/src/components/providers/index.ts`
**Action:** Modify (or Create if doesn't exist)

```typescript
/**
 * Provider exports
 */

export { AuthProvider } from './auth-provider'
export { PermissionProvider, Can, usePermissionContext } from './permission-provider'
```

## Verification

After completing all tasks, verify the implementation:

### Manual Testing Checklist

- [ ] **Build succeeds**: Run `cd apps/admin && npm run build` - no errors
- [ ] **TypeScript compiles**: Run `cd apps/admin && npx tsc --noEmit` - no errors
- [ ] **App starts**: Run `cd apps/admin && npm run dev` - app loads without errors

### Permission Matrix Verification (QA-02)

Test each role against the permission matrix:

**Admin Role Testing:**
- [ ] Login as admin user (role: 'admin' in database)
- [ ] Can access `/dashboard` - YES
- [ ] Can access `/billing` - YES
- [ ] Can access `/clients` - YES
- [ ] All sidebar items visible

**Tech Role Testing (inspector/manager):**
- [ ] Login as inspector/manager user
- [ ] Cannot access `/dashboard` - redirects to `/calendar`
- [ ] Can access `/billing` - YES
- [ ] Can access `/clients` - YES
- [ ] Dashboard not visible in sidebar

**Client Role Testing:**
- [ ] Login as client user
- [ ] Any admin route redirects to `/portal`
- [ ] Cannot see admin sidebar
- [ ] Only portal routes accessible

### Redirect Testing
- [ ] Unauthenticated user accessing `/dashboard` redirects to `/login`
- [ ] Tech user accessing `/dashboard` redirects to `/calendar`
- [ ] Client user accessing any admin route redirects to `/portal`
- [ ] Admin user can access all routes

## Rollback

If the implementation needs to be reverted:

1. Restore original `app-layout.tsx`:
   - Remove `usePermissions` import and usage
   - Remove permission check logic
   - Keep original auth-only check

2. Restore original `sidebar.tsx`:
   - Remove `usePermissions` import
   - Remove permission filtering logic
   - Use static `navItems` arrays

3. Restore original `App.tsx`:
   - Remove `PermissionProvider` import and wrapper
   - Keep existing provider structure

4. Delete new files:
   ```bash
   rm -rf apps/admin/src/components/guards
   ```

The permission system from Plan 01-01 can remain as it doesn't affect existing functionality.

## Notes

- Permission checking happens at the `AppLayout` level, providing a single enforcement point for all protected routes.
- The sidebar dynamically filters navigation based on permissions, improving UX by not showing links users can't access.
- Client users are redirected to `/portal` from the admin layout since they have a dedicated portal UI.
- The existing `PortalAuthGuard` continues to work for portal routes.
- Console warnings log unauthorized access attempts for debugging purposes.
- The permission system integrates with the existing auth flow without replacing it - auth must succeed before permissions are checked.
