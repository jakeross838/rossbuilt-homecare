---
phase: 01-database-auth
plan: 03
type: execute
wave: 1
depends_on: [01-02]
files_modified: [supabase/migrations/012_invoices.sql, supabase/migrations/013_calendar_reminders.sql, supabase/migrations/014_documents.sql, supabase/migrations/015_notifications_activity.sql, supabase/migrations/016_settings.sql, supabase/migrations/017_functions_triggers.sql]
autonomous: true
---

<objective>
Create billing, calendar, documents, notifications, settings, and database functions/triggers.

Purpose: Complete the supporting infrastructure for billing (invoices/payments), scheduling (calendar/reminders), document management, activity tracking, and pricing calculations.
Output: 6 migration files (012-017) completing the table schema.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference specification:
@~/Downloads/home-care-os-docs/phase-01-database.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create invoices and billing schema migration</name>
  <files>supabase/migrations/012_invoices.sql</files>
  <action>
Create migration with:

**invoices table:**
- UUID primary key with organization_id, client_id foreign keys
- invoice_number (UNIQUE, generated), invoice_type ('subscription', 'service', 'mixed')
- Dates: invoice_date, due_date, period_start, period_end
- Amounts: subtotal, tax_rate (DECIMAL 5,4), tax_amount, discount_amount, discount_description, total, amount_paid, balance_due
- status (invoice_status enum)
- Stripe: stripe_invoice_id, stripe_payment_intent_id
- Delivery: sent_at, sent_to_email, viewed_at
- Payment: paid_at, payment_method
- pdf_url, notes, terms

**invoice_line_items table:**
- invoice_id foreign key
- description, quantity (DECIMAL 10,2), unit_price, amount
- line_type: 'subscription', 'addon', 'service', 'work_order', 'materials', 'other'
- reference_type, reference_id, property_id
- display_order

**payments table:**
- organization_id, invoice_id, client_id foreign keys
- amount, payment_method ('card', 'ach', 'check', 'cash', 'other')
- Stripe: stripe_payment_id, stripe_charge_id
- Details: last_four, card_brand, check_number
- notes, recorded_by, payment_date

**invoice_seq SEQUENCE** starting at 1000

Indexes: organization_id, client_id, status, invoice_number, due date, line items, payments.
  </action>
  <verify>Invoice schema supports subscriptions and one-time services</verify>
  <done>Invoices, line items, and payments schema created</done>
</task>

<task type="auto">
  <name>Task 2: Create calendar and reminders schema migration</name>
  <files>supabase/migrations/013_calendar_reminders.sql</files>
  <action>
Create migration with:

**calendar_events table:**
- UUID primary key with organization_id foreign key
- title, description, event_type (calendar_event_type enum)
- Scheduling: start_date, start_time, end_date, end_time, all_day
- Recurrence: is_recurring, recurrence_rule (RRULE format), recurrence_end_date, parent_event_id (self-reference)
- assigned_to (user foreign key)
- References: property_id, inspection_id, work_order_id
- location, status
- External sync: google_event_id, last_synced_at

**reminders table:**
- UUID primary key with organization_id foreign key
- References: property_id, equipment_id, program_id
- title, description, reminder_type ('maintenance', 'warranty', 'service', 'inspection', 'filter', 'custom')
- Scheduling: due_date, reminder_date (when to send)
- Recurrence: is_recurring, recurrence_rule, next_occurrence
- Status: status ('pending', 'sent', 'completed', 'snoozed', 'cancelled'), sent_at, completed_at, snoozed_until
- Notifications: notify_staff, notify_client, assigned_to

Indexes: start_date, assigned_to, event_type, due_date, status, equipment_id.
  </action>
  <verify>Calendar supports recurring events and Google sync</verify>
  <done>Calendar events and reminders schema created</done>
</task>

<task type="auto">
  <name>Task 3: Create documents and home manuals schema migration</name>
  <files>supabase/migrations/014_documents.sql</files>
  <action>
Create migration with:

**documents table:**
- UUID primary key with organization_id foreign key
- Associations: property_id, client_id, equipment_id, inspection_id, work_order_id (all optional)
- name, document_type ('inspection_report', 'invoice', 'home_manual', 'warranty', 'contract', 'equipment_manual', 'photo', 'site_plan', 'other')
- File: file_url, file_size, mime_type
- Metadata: tags (TEXT array), description
- Access: is_client_visible
- uploaded_by (user foreign key)

**home_manuals table:**
- UUID primary key with property_id foreign key (UNIQUE - one per property)
- content JSONB containing structured manual:
  ```
  {
    "property_overview": {...},
    "emergency_contacts": {...},
    "systems_overview": {...},
    "equipment_registry": [...],
    "maintenance_calendar": {...},
    "vendor_directory": [...],
    "service_history": [...],
    "home_care_tips": {...}
  }
  ```
- Generated files: pdf_url, web_url
- share_token (UNIQUE) for unauthenticated access
- version, last_generated_at

Indexes: organization_id, property_id, client_id, document_type, share_token.
  </action>
  <verify>Documents support all entity attachments, home manuals are one per property</verify>
  <done>Documents and home manuals schema created</done>
</task>

<task type="auto">
  <name>Task 4: Create notifications and activity log schema migration</name>
  <files>supabase/migrations/015_notifications_activity.sql</files>
  <action>
Create migration with:

**notifications table:**
- UUID primary key with organization_id, user_id foreign keys
- title, message, notification_type (notification_type enum)
- priority (priority_level)
- Reference: entity_type, entity_id, action_url (deep link)
- Status: is_read, read_at
- Delivery: email_sent/sent_at, push_sent/sent_at, sms_sent/sent_at

**activity_log table:**
- UUID primary key with organization_id, user_id foreign keys
- Activity: action ('created', 'updated', 'deleted', 'viewed', 'sent', 'completed')
- entity_type, entity_id, entity_name (human-readable)
- Change details: changes JSONB, metadata JSONB
- Request context: ip_address (INET), user_agent

Indexes: user unread notifications, notification_type, organization activity, entity lookup, date desc.
  </action>
  <verify>Notifications support multi-channel delivery, activity log captures all changes</verify>
  <done>Notifications and activity log schema created</done>
</task>

<task type="auto">
  <name>Task 5: Create settings and pricing config schema migration</name>
  <files>supabase/migrations/016_settings.sql</files>
  <action>
Create migration with:

**settings table:**
- UUID primary key with organization_id foreign key
- setting_key, setting_value (JSONB)
- description, is_sensitive (for API keys)
- UNIQUE constraint on (organization_id, setting_key)

**pricing_config table:**
- UUID primary key with organization_id foreign key
- Version: version, effective_date, is_current
- frequency_pricing JSONB:
  ```json
  {"annual": 50, "semi_annual": 85, "quarterly": 150, "monthly": 275, "bi_weekly": 450}
  ```
- tier_pricing JSONB:
  ```json
  {"visual": 75, "functional": 150, "comprehensive": 250, "preventative": 375}
  ```
- addon_pricing JSONB:
  ```json
  {"digital_manual": 25, "warranty_tracking": 15, "emergency_response": 50, "hurricane_monitoring": 25}
  ```
- service_rates JSONB:
  ```json
  {"hourly_rate": 85, "pre_storm_prep": 150, "post_storm_inspection": 250, "arrival_prep": 125, "departure_check": 100, "home_manual_creation": 350, "vendor_markup_percent": 15}
  ```
- time_estimates JSONB with base_times, per_1000_sqft, and feature_additions by tier

Indexes: organization_id, setting_key, current pricing.
  </action>
  <verify>Settings support any key-value pair, pricing is fully configurable</verify>
  <done>Settings and pricing configuration schema created</done>
</task>

<task type="auto">
  <name>Task 6: Create functions and triggers migration</name>
  <files>supabase/migrations/017_functions_triggers.sql</files>
  <action>
Create migration with:

**update_updated_at() function:**
- Trigger function that sets updated_at = NOW() on update
- Apply to all tables with updated_at column (exclude activity_log, notifications, etc.)

**generate_work_order_number() function + trigger:**
- Sets work_order_number = 'WO-' || LPAD(nextval('work_order_seq')::TEXT, 6, '0')
- Trigger BEFORE INSERT on work_orders

**generate_invoice_number() function + trigger:**
- Sets invoice_number = 'INV-' || LPAD(nextval('invoice_seq')::TEXT, 6, '0')
- Trigger BEFORE INSERT on invoices

**generate_service_request_number() function + trigger:**
- Sets request_number = 'SR-' || LPAD(nextval('service_request_seq')::TEXT, 6, '0')
- Trigger BEFORE INSERT on service_requests

**calculate_program_pricing() function:**
- Input: organization_id, frequency, tier, addon booleans
- Returns TABLE(base_fee, tier_fee, addons_fee, monthly_total)
- Looks up current pricing_config and calculates

**calculate_inspection_duration() function:**
- Input: property_id, tier
- Returns INTEGER (minutes)
- Calculates based on base_time + sqft_time + feature_time + equipment_time

Use exact function signatures from phase-01-database.md.
  </action>
  <verify>All triggers fire correctly, functions return expected values</verify>
  <done>Database functions and triggers created</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 6 migration files exist (012-017)
- [ ] Invoice/payment foreign keys reference correct tables
- [ ] Calendar events support recurring with RRULE
- [ ] Documents can attach to any entity type
- [ ] All triggers created for updated_at and number generation
- [ ] Pricing calculation function matches spec exactly
</verification>

<success_criteria>
- 6 migration files created (012-017)
- Complete billing infrastructure (invoices, line items, payments)
- Calendar with recurrence support
- Document management with home manuals
- Activity tracking for audit trail
- Configurable pricing with calculation functions
- Auto-numbering for work orders, invoices, service requests
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-auth/01-03-SUMMARY.md`
</output>
