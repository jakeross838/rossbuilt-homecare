---
phase: 01-database-auth
plan: 02
type: execute
wave: 1
depends_on: [01-01]
files_modified: [supabase/migrations/005_programs.sql, supabase/migrations/006_equipment.sql, supabase/migrations/007_inspection_templates.sql, supabase/migrations/008_inspections.sql, supabase/migrations/009_recommendations.sql, supabase/migrations/010_vendors_work_orders.sql, supabase/migrations/011_service_requests.sql]
autonomous: true
---

<objective>
Create domain schema migrations for programs, equipment, inspections, recommendations, vendors, work orders, and service requests.

Purpose: Build the core business logic tables that power inspections, equipment tracking, vendor management, and work order coordination.
Output: 7 migration files (005-011) containing all domain entities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference specification:
@~/Downloads/home-care-os-docs/phase-01-database.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create programs schema migration</name>
  <files>supabase/migrations/005_programs.sql</files>
  <action>
Create migration with:

**programs table:**
- UUID primary key with organization_id, property_id, client_id foreign keys
- inspection_frequency and inspection_tier enum columns
- Add-on booleans: addon_digital_manual, addon_warranty_tracking, addon_emergency_response, addon_hurricane_monitoring
- Pricing columns: base_fee, tier_fee, addons_fee, monthly_total (DECIMAL 10,2)
- vendor_markup_percent (DECIMAL 5,2 default 15.00)
- status (program_status enum, default 'pending')
- Scheduling preferences: preferred_day_of_week, preferred_time_slot, preferred_inspector_id
- Billing: billing_start_date, billing_day_of_month, stripe_subscription_id, stripe_price_id
- Timestamps: activated_at, paused_at, cancelled_at, created_at, updated_at
- Partial unique constraint for one active program per property

**program_history table:**
- Tracks all program changes with changed_by, change_type, previous_values, new_values (JSONB)

Indexes on organization_id, property_id, client_id, status, and active programs.
  </action>
  <verify>Programs and program_history tables defined with correct relationships</verify>
  <done>Programs schema with history tracking created</done>
</task>

<task type="auto">
  <name>Task 2: Create equipment schema migration</name>
  <files>supabase/migrations/006_equipment.sql</files>
  <action>
Create migration with:

**equipment table:**
- UUID primary key with property_id foreign key
- Identification: category, equipment_type, custom_name
- Manufacturer: manufacturer, model_number, serial_number
- Dates: install_date, warranty_expiration, expected_lifespan_years
- Location: location, serves
- Specifications: capacity, filter_size, fuel_type, specs (JSONB)
- AI content: maintenance_schedule (JSONB array), inspection_checklist (JSONB by tier), troubleshooting_guide, ai_generated_at
- Media: photo_url, photos (TEXT array), manual_url
- Service tracking: last_service_date, last_service_notes, service_count
- condition (condition_rating enum), is_active, notes

**equipment_service_log table:**
- Tracks all service events: service_date, service_type, performed_by, description, cost, notes, work_order_id

Indexes on property_id, category, warranty_expiration, active equipment, service log.
  </action>
  <verify>Equipment tables defined with AI-ready JSONB columns</verify>
  <done>Equipment registry schema with service log created</done>
</task>

<task type="auto">
  <name>Task 3: Create inspection templates schema migration</name>
  <files>supabase/migrations/007_inspection_templates.sql</files>
  <action>
Create migration with:

**inspection_templates table:**
- UUID primary key with organization_id foreign key
- Template info: name, description
- Scope: tier (inspection_tier), category, feature_type, equipment_category
- Sections JSONB containing structured checklist items:
  ```
  [{
    "id": "section_1",
    "name": "Roof",
    "order": 1,
    "items": [{
      "id": "item_1",
      "text": "Roof surface condition",
      "type": "status|text|number|select|photo",
      "options": [],
      "photo_required": false,
      "photo_recommended": true,
      "recommendation_template_id": "string",
      "help_text": "string"
    }]
  }]
  ```
- estimated_minutes, version, is_current, is_active

**recommendation_templates table:**
- organization_id foreign key
- template_key (unique per org), title, description, category
- default_priority (priority_level), estimated_cost_low/high
- Unique constraint on (organization_id, template_key)

Indexes on tier, category, feature_type, template_key.
  </action>
  <verify>Template tables support dynamic checklist configuration</verify>
  <done>Inspection and recommendation templates schema created</done>
</task>

<task type="auto">
  <name>Task 4: Create inspections schema migration</name>
  <files>supabase/migrations/008_inspections.sql</files>
  <action>
Create migration with:

**inspections table:**
- UUID primary key with organization_id, property_id, program_id, inspector_id foreign keys
- inspection_type: 'scheduled', 'storm_pre', 'storm_post', 'arrival', 'departure', 'special', 'initial'
- status (inspection_status enum)
- Scheduling: scheduled_date, scheduled_time_start/end, estimated_duration_minutes
- Actual times: actual_start_at, actual_end_at, actual_duration_minutes
- checklist JSONB (snapshot from templates at scheduling)
- findings JSONB (results for each item with status, photos, notes)
- Summary: overall_condition (condition_rating), summary, internal_notes
- weather_conditions JSONB (temp, humidity, conditions, wind)
- Report: report_url, report_generated_at, report_sent_at, report_viewed_at
- completed_at timestamp

**inspection_photos table:**
- inspection_id foreign key, item_id, section_id
- url, thumbnail_url, caption
- Metadata: taken_at, file_size, width, height
- display_order

Indexes: organization_id, property_id, program_id, inspector_id, status, date, upcoming inspections, photos.
  </action>
  <verify>Inspections table supports full inspection workflow</verify>
  <done>Inspections schema with photos tracking created</done>
</task>

<task type="auto">
  <name>Task 5: Create recommendations schema migration</name>
  <files>supabase/migrations/009_recommendations.sql</files>
  <action>
Create migration with:

**recommendations table:**
- UUID primary key with organization_id, property_id, inspection_id, equipment_id foreign keys
- Source: checklist_item_id, template_id
- Content: title, description, category ('repair', 'maintenance', 'replacement', 'upgrade', 'safety')
- priority (priority_level), estimated_cost_low/high
- AI enhancement: ai_enhanced_description, ai_why_it_matters, ai_enhanced_at
- photos (TEXT array)
- status (recommendation_status enum)
- Client response: client_responded_at, client_response_notes, declined_reason
- Conversion: work_order_id (set when converted)

Indexes: organization_id, property_id, inspection_id, status, pending recommendations.
  </action>
  <verify>Recommendations support AI enhancement and conversion to work orders</verify>
  <done>Recommendations schema created</done>
</task>

<task type="auto">
  <name>Task 6: Create vendors and work orders schema migration</name>
  <files>supabase/migrations/010_vendors_work_orders.sql</files>
  <action>
Create migration with:

**vendors table:**
- UUID primary key with organization_id foreign key
- Company info: company_name, contact_first_name/last_name, email, phone
- Address fields
- Capabilities: trade_categories (TEXT array), service_area (TEXT array)
- Business: license_number/expiration, insurance details, w9_on_file/received_date
- Metrics: total_jobs, completed_jobs, average_rating (DECIMAL 3,2), average_response_hours
- is_preferred, notes, is_active

**work_orders table:**
- UUID primary key with organization_id, property_id, client_id foreign keys
- Source: recommendation_id, service_request_id
- Assignment: vendor_id, assigned_to (internal staff)
- work_order_number (UNIQUE, generated), title, description, category
- priority (priority_level), status (work_order_status)
- Scheduling: scheduled_date, scheduled_time_start/end
- Actual: started_at, completed_at
- Costs: estimated_cost, actual_cost, markup_percent, markup_amount, total_client_cost
- Documentation: before_photos, after_photos (arrays), vendor_invoice_url, completion_notes
- Billing: invoice_id, invoiced_at
- internal_notes, client_visible_notes

**work_order_seq SEQUENCE** starting at 1000

Indexes: vendors by trades (GIN), active vendors, work orders by all major fields.
  </action>
  <verify>Vendor and work order tables support full coordination workflow</verify>
  <done>Vendors and work orders schema created</done>
</task>

<task type="auto">
  <name>Task 7: Create service requests schema migration</name>
  <files>supabase/migrations/011_service_requests.sql</files>
  <action>
Create migration with:

**service_requests table:**
- UUID primary key with organization_id, property_id, client_id foreign keys
- request_number (UNIQUE, generated), request_type, title, description
- request_type values: 'maintenance', 'emergency', 'storm_prep', 'arrival', 'departure', 'question', 'other'
- priority (priority_level), status (service_request_status)
- assigned_to, photos (TEXT array)
- Resolution: resolution, resolved_at, resolved_by
- Conversion: work_order_id
- Communication: acknowledged_at, acknowledged_by

**service_request_comments table:**
- service_request_id foreign key, user_id
- comment, is_internal (boolean for staff-only visibility)

**service_request_seq SEQUENCE** starting at 1000

Indexes: organization_id, property_id, client_id, status, request_number, comments.
  </action>
  <verify>Service requests support client portal submissions</verify>
  <done>Service requests schema with comments created</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 7 migration files exist (005-011)
- [ ] Foreign key chains: programs → properties/clients, equipment → properties, inspections → programs/properties, recommendations → inspections/equipment, work_orders → vendors/recommendations, service_requests → work_orders
- [ ] JSONB columns properly structured for AI content
- [ ] Sequences created for auto-numbering
- [ ] All enum references use correct type names from 001_enums.sql
</verification>

<success_criteria>
- 7 migration files created (005-011)
- All domain entities properly related
- AI-ready JSONB structures in equipment and inspections
- Sequences for work order and service request numbers
- Ready for billing schema in Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-auth/01-02-SUMMARY.md`
</output>
