---
phase: 01-database-auth
plan: 04
type: execute
wave: 1
depends_on: [01-03]
files_modified: [supabase/migrations/018_rls_policies.sql, supabase/migrations/019_seed_data.sql, packages/database/types.ts]
autonomous: true
---

<objective>
Implement Row Level Security policies, seed initial data, and generate TypeScript types.

Purpose: Secure the database with multi-tenant RLS, create Ross Built organization with default pricing, and generate type-safe database interfaces.
Output: Complete, secure, typed database ready for application development.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference specification:
@~/Downloads/home-care-os-docs/phase-01-database.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RLS policies migration</name>
  <files>supabase/migrations/018_rls_policies.sql</files>
  <action>
Create migration with:

**Enable RLS on all tables:**
- organizations, users, clients, properties, programs, program_history
- equipment, equipment_service_log
- inspection_templates, recommendation_templates, inspections, inspection_photos
- recommendations, vendors, work_orders
- service_requests, service_request_comments
- invoices, invoice_line_items, payments
- calendar_events, reminders
- documents, home_manuals
- notifications, activity_log
- settings, pricing_config

**Helper functions (SECURITY DEFINER):**
- get_user_organization_id() - Returns organization_id from users where id = auth.uid()
- get_user_role() - Returns role from users where id = auth.uid()
- is_admin_or_manager() - Returns boolean if role IN ('admin', 'manager')
- get_user_client_id() - Returns client id if user is linked to a client

**RLS Policies by role:**

Organizations:
- SELECT: Users can only view their own organization

Users:
- SELECT: Users can view same-org users
- ALL: Admin/Manager can manage users in their org

Clients:
- SELECT (staff): Staff can view all clients in org
- SELECT (client): Clients can view only themselves
- ALL: Admin/Manager can manage clients

Properties:
- SELECT (staff): Staff can view all properties
- SELECT (client): Clients can view their own properties
- ALL: Admin/Manager can manage properties

Inspections:
- SELECT (admin/manager): View all org inspections
- SELECT (inspector): View assigned inspections
- SELECT (client): View inspections on their properties
- ALL: Admin/Manager can manage
- UPDATE: Inspectors can update their assigned inspections (scheduled/in_progress only)

Notifications:
- SELECT: Users see only their own
- UPDATE: Users can mark their own as read

Activity Log:
- SELECT: Admin/Manager only

Apply similar patterns for all other tables:
- Staff see all org data
- Clients see only their linked data
- Inspectors see assigned work
- Admin/Manager have full management access
  </action>
  <verify>RLS enabled on all tables, policies prevent cross-tenant access</verify>
  <done>Row Level Security policies implemented for all tables</done>
</task>

<task type="auto">
  <name>Task 2: Create seed data migration</name>
  <files>supabase/migrations/019_seed_data.sql</files>
  <action>
Create migration with:

**Ross Built organization:**
```sql
INSERT INTO organizations (id, name, slug, phone, email, website) VALUES
  ('00000000-0000-0000-0000-000000000001', 'Ross Built Custom Homes', 'ross-built', '941-555-0100', 'info@rossbuilt.com', 'https://rossbuilt.com');
```

**Default pricing config:**
```sql
INSERT INTO pricing_config (organization_id, effective_date) VALUES
  ('00000000-0000-0000-0000-000000000001', CURRENT_DATE);
```
(Uses default JSONB values from table definition)

**Default settings:**
- company_info with name, phone, email, address
- email_templates with notification toggles

**Default inspection templates (optional):**
- Basic exterior checklist template
- Basic interior checklist template
- Pool/spa feature template
- HVAC equipment template

Use fixed UUID for organization to allow referencing in future seeds.
Do NOT seed any user accounts - those will be created via Supabase Auth.
  </action>
  <verify>Organization and pricing config seeded, ready for user signup</verify>
  <done>Seed data created for Ross Built organization</done>
</task>

<task type="auto">
  <name>Task 3: Apply all migrations to Supabase</name>
  <files>N/A - Supabase MCP operations</files>
  <action>
Use Supabase MCP to apply all migrations in order:

1. Check if Supabase project exists (list_projects)
2. If no project, notify user to create one or use create_project
3. Apply each migration using apply_migration:
   - 001_enums.sql
   - 002_organizations_users.sql
   - 003_clients.sql
   - 004_properties.sql
   - 005_programs.sql
   - 006_equipment.sql
   - 007_inspection_templates.sql
   - 008_inspections.sql
   - 009_recommendations.sql
   - 010_vendors_work_orders.sql
   - 011_service_requests.sql
   - 012_invoices.sql
   - 013_calendar_reminders.sql
   - 014_documents.sql
   - 015_notifications_activity.sql
   - 016_settings.sql
   - 017_functions_triggers.sql
   - 018_rls_policies.sql
   - 019_seed_data.sql

4. Verify migrations applied: list_migrations, list_tables

If MCP unavailable, output instructions for manual migration application.
  </action>
  <verify>All 19 migrations show in list_migrations</verify>
  <done>All migrations successfully applied to Supabase</done>
</task>

<task type="auto">
  <name>Task 4: Generate TypeScript types</name>
  <files>packages/database/types.ts</files>
  <action>
Use Supabase MCP generate_typescript_types to get database types.

1. Create packages/database/ directory
2. Generate types using MCP: generate_typescript_types(project_id)
3. Save output to packages/database/types.ts
4. Add package.json to packages/database with:
   - name: @home-care-os/database
   - exports: ./types.ts
   - types: ./types.ts

If MCP unavailable:
- Create placeholder types.ts with comment to run:
  `npx supabase gen types typescript --project-id PROJECT_ID > packages/database/types.ts`

Types should include:
- Database interface with public schema
- All table types (Row, Insert, Update variants)
- All enum types
- Function return types
  </action>
  <verify>Types file exists with all table definitions</verify>
  <done>TypeScript types generated for full schema</done>
</task>

<task type="auto">
  <name>Task 5: Run security and performance advisors</name>
  <files>N/A - verification only</files>
  <action>
Use Supabase MCP to check for issues:

1. get_advisors(project_id, type: 'security')
   - Verify RLS enabled on all tables
   - Check for any missing policies
   - Identify any exposed data

2. get_advisors(project_id, type: 'performance')
   - Check for missing indexes
   - Identify slow query patterns
   - Verify proper index coverage

3. Test RLS with execute_sql:
   - Query as service role (should see all data)
   - Verify organization isolation works
   - Test role-based access patterns

Document any findings and remediation steps.
  </action>
  <verify>No critical security advisories, all indexes present</verify>
  <done>Security and performance verified</done>
</task>

<task type="auto">
  <name>Task 6: Verify database functions</name>
  <files>N/A - verification only</files>
  <action>
Test database functions using execute_sql:

**Test calculate_program_pricing:**
```sql
SELECT * FROM calculate_program_pricing(
  '00000000-0000-0000-0000-000000000001',
  'quarterly',
  'comprehensive',
  true, false, true, false
);
-- Expected: base=150, tier=250, addons=75 (25+50), total=475
```

**Test number generators:**
```sql
-- Create test work order (will need valid property_id/client_id)
-- Verify work_order_number = 'WO-001000'
```

**Test updated_at triggers:**
```sql
-- Update organization, verify updated_at changed
```

Document test results in summary.
  </action>
  <verify>All functions return expected values</verify>
  <done>Database functions verified working</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] RLS enabled on all 25+ tables
- [ ] All helper functions created (get_user_organization_id, etc.)
- [ ] Policies cover all four roles: admin, manager, inspector, client
- [ ] Ross Built organization seeded with UUID 00000000-0000-0000-0000-000000000001
- [ ] Default pricing config in place
- [ ] All 19 migrations applied successfully
- [ ] TypeScript types generated
- [ ] No critical security advisories
- [ ] Pricing calculation function tested
</verification>

<success_criteria>
- Complete RLS implementation
- Ross Built organization ready
- Default pricing configured
- All migrations applied
- TypeScript types available for app development
- Security verified with no critical issues
- Database ready for Phase 2 (Core Entities)
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-auth/01-04-SUMMARY.md`

Also update `.planning/STATE.md` to mark Phase 1 complete.
</output>
