---
phase: v1.4-02-query-key-unification
plan: 05
type: execute
wave: 3
depends_on: ["02-02", "02-03", "02-04"]
files_modified:
  - apps/admin/src/hooks/use-realtime-sync.ts
  - apps/admin/src/lib/queries/keys.ts
  - apps/admin/src/config/app-config.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Realtime queryKeyMap includes ALL query keys"
    - "service-requests key mismatch fixed (not serviceRequests)"
    - "calendar-inspections, property-inspections, inspector-workload in realtime map"
    - "Realtime invalidation fires for every table change"
    - "Debug logging toggleable via config"
  artifacts:
    - path: "apps/admin/src/hooks/use-realtime-sync.ts"
      provides: "Realtime sync with complete query key coverage"
      contains:
        - "calendar-inspections"
        - "inspector-workload"
        - "service-requests"
  key_links:
    - from: "apps/admin/src/hooks/use-realtime-sync.ts"
      to: "apps/admin/src/lib/queries/keys.ts"
      via: "Import and reference query keys"
      pattern: "import.*from.*@/lib/queries"
---

<objective>
Update realtime sync hook to include ALL query keys and fix mismatches between hook keys and realtime invalidation keys.

Purpose: Ensure realtime invalidation fires for every table change, closing sync gaps.
Output: Complete realtime coverage for all query keys.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/REQUIREMENTS-v1.4.md

Prior plan outputs (all Wave 2 plans complete):
@apps/admin/src/lib/queries/keys.ts (centralized keys)
@apps/admin/src/hooks/use-realtime-sync.ts (current realtime sync)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix key mismatches in realtime sync</name>
  <files>apps/admin/src/hooks/use-realtime-sync.ts</files>
  <action>
Update the `queryKeyMap` in `use-realtime-sync.ts` to fix key mismatches:

**Current mismatches to fix:**
1. `service_requests: [['serviceRequests'], ...]` -> Change to `[['service-requests'], ...]`
2. `work_orders: [['workOrders'], ...]` -> Change to `[['work-orders'], ...]`

**Why:** The hooks define keys as `['service-requests']` and `['work-orders']` (kebab-case), but realtime sync uses camelCase. This means realtime changes don't invalidate the correct cache.

**Update the queryKeyMap:**

```typescript
const queryKeyMap: Record<TableName, string[][]> = {
  clients: [['clients'], ['portal', 'dashboard']],
  properties: [['properties'], ['portal', 'properties'], ['portal', 'dashboard']],
  equipment: [['equipment'], ['portal', 'properties']],
  work_orders: [['work-orders'], ['portal', 'properties'], ['portal', 'dashboard']], // Fixed: was 'workOrders'
  inspections: [['inspections'], ['portal', 'inspections'], ['portal', 'dashboard']],
  invoices: [['invoices'], ['portal', 'invoices'], ['portal', 'dashboard']],
  service_requests: [['service-requests'], ['portal', 'requests'], ['portal', 'dashboard']], // Fixed: was 'serviceRequests'
  vendors: [['vendors']],
  reminders: [['reminders']],
  calendar_events: [['calendar'], ['calendarEvents']],
  programs: [['programs'], ['portal', 'plan'], ['portal', 'dashboard'], ['admin', 'properties-overview']],
  notifications: [['notifications'], ['portal', 'notifications'], ['admin', 'notifications']],
  user_property_assignments: [['property-assignments'], ['portal', 'properties'], ['portal', 'dashboard'], ['users']],
}
```
  </action>
  <verify>
- `cd apps/admin && npx tsc --noEmit` compiles without errors
- queryKeyMap uses `['service-requests']` not `['serviceRequests']`
- queryKeyMap uses `['work-orders']` not `['workOrders']`
  </verify>
  <done>
- Key mismatches fixed
- Realtime invalidation now matches hook query keys
  </done>
</task>

<task type="auto">
  <name>Task 2: Add missing keys to realtime map</name>
  <files>apps/admin/src/hooks/use-realtime-sync.ts</files>
  <action>
Add missing query keys to the `queryKeyMap` for comprehensive coverage.

**Keys to add for inspections table:**
- `['calendar-inspections']` - used by calendar view
- `['property-inspections']` - used by property detail
- `['inspector-workload']` - used by workload calculation
- `['inspector-schedule']` - used by inspector schedule
- `['inspector-inspection']` - used by inspector detail view
- `['inspector-upcoming']` - used by upcoming list
- `['inspection-metrics']` - used by dashboard metrics

**Keys to add for recommendations table (new table subscription):**
- Add `recommendations` to TableName type
- Add mapping: `recommendations: [['recommendations']]`

**Updated inspections entry:**
```typescript
inspections: [
  ['inspections'],
  ['calendar-inspections'],
  ['property-inspections'],
  ['inspector-workload'],
  ['inspector-schedule'],
  ['inspector-inspection'],
  ['inspector-upcoming'],
  ['inspection-metrics'],
  ['portal', 'inspections'],
  ['portal', 'dashboard'],
],
```

**Add recommendations subscription:**
First, add to TableName type:
```typescript
type TableName =
  | 'clients'
  | 'properties'
  // ... existing
  | 'recommendations'  // ADD THIS
```

Then add to queryKeyMap:
```typescript
recommendations: [['recommendations']],
```

Then add to tables arrays in `useGlobalRealtimeSync` and `usePortalRealtimeSync`.
  </action>
  <verify>
- `cd apps/admin && npx tsc --noEmit` compiles without errors
- inspections entry includes all 10 key patterns
- recommendations table is subscribed
  </verify>
  <done>
- All missing inspection keys added to realtime map
- recommendations table subscribed for realtime updates
  </done>
</task>

<task type="auto">
  <name>Task 3: Add configurable debug logging</name>
  <files>
apps/admin/src/hooks/use-realtime-sync.ts
apps/admin/src/config/app-config.ts
  </files>
  <action>
Add toggleable debug logging for realtime events.

**In app-config.ts, add:**
```typescript
export const DEBUG = {
  REALTIME_LOGGING: import.meta.env.DEV, // Enable in dev, disable in prod
}
```

**In use-realtime-sync.ts, update console.log calls:**

Replace direct console.log with conditional:
```typescript
import { DEBUG } from '@/config/app-config'

// In the subscription callbacks:
if (DEBUG.REALTIME_LOGGING) {
  console.log(`[Realtime] ${table} INSERT:`, payload.new)
}

// In channel.subscribe callback:
if (DEBUG.REALTIME_LOGGING) {
  console.log(`[Realtime] Subscription status: ${status}`)
}

// In cleanup:
if (DEBUG.REALTIME_LOGGING) {
  console.log('[Realtime] Unsubscribing from channel')
}
```

This allows logging to be enabled/disabled without code changes.
  </action>
  <verify>
- `cd apps/admin && npx tsc --noEmit` compiles without errors
- DEBUG.REALTIME_LOGGING exists in app-config.ts
- All console.log in use-realtime-sync.ts are conditional
  </verify>
  <done>
- Debug logging toggleable via config
- Logging enabled in dev, disabled in prod by default
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd apps/admin && npx tsc --noEmit`
2. Build verification: `npm run build`
3. Manual test: Open app, make a change, verify realtime callback fires in console (dev mode)
4. Verify key alignment: Compare queryKeyMap entries with hook key factories
</verification>

<success_criteria>
- [ ] `service-requests` key matches (not `serviceRequests`)
- [ ] `work-orders` key matches (not `workOrders`)
- [ ] `calendar-inspections`, `property-inspections`, `inspector-workload` in inspections map
- [ ] `recommendations` table subscribed
- [ ] Debug logging toggleable via config
- [ ] TypeScript compiles without errors
- [ ] Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/v1.4-02-query-key-unification/02-05-SUMMARY.md`
</output>
