---
phase: 03-equipment-ai
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/generate-equipment-ai/index.ts
autonomous: true
user_setup:
  - service: anthropic
    why: "AI-powered maintenance schedule generation"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console → API Keys → Create key"
    account_setup:
      - url: "https://console.anthropic.com"
        skip_if: "Already have Anthropic account with API access"
---

<objective>
Create and deploy Supabase Edge Function for AI-powered equipment maintenance generation.

Purpose: Enable one-click generation of maintenance schedules, inspection checklists, and troubleshooting guides using Claude API.
Output: Deployed edge function that accepts equipment_id and populates AI fields in database.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Database schema (shows AI fields to populate):
@C:/Users/Jake/home-care-os/supabase/migrations/006_equipment.sql

Reference document with edge function code:
@C:/Users/Jake/Downloads/home-care-os-docs/phase-03-equipment-ai.md (section 3.4)

Supabase project: rossbuilt-homecare (qzbmnbinhxzkcwfjnmtb)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI Edge Function</name>
  <files>supabase/functions/generate-equipment-ai/index.ts</files>
  <action>
Create Supabase Edge Function at supabase/functions/generate-equipment-ai/index.ts:

1. Set up CORS headers for browser requests

2. Handle OPTIONS preflight requests

3. Parse equipment_id from request body

4. Create Supabase client with service role key

5. Fetch equipment record by ID

6. Call Claude API (claude-sonnet-4-20250514) with prompt:
   - Context: "home maintenance expert for luxury coastal homes in Tampa Bay, Florida"
   - Include equipment details: category, type, manufacturer, model, location
   - Request JSON response with:
     - maintenance_schedule: array of tasks with frequency, performer, cost estimates, priority
     - inspection_checklist: object with visual, functional, comprehensive, preventative arrays
     - troubleshooting: array of symptom/cause/action/urgency objects
     - expected_lifespan_years: number
     - replacement_cost_estimate: {low, high}
   - Emphasize Tampa Bay market pricing and coastal humidity/salt air considerations

7. Parse JSON from Claude response (extract JSON from markdown if needed)

8. Update equipment record with:
   - maintenance_schedule
   - inspection_checklist
   - troubleshooting_guide
   - expected_lifespan_years
   - ai_generated_at: current timestamp

9. Return success response with parsed data

10. Handle errors with proper status codes and messages

Reference the exact implementation from phase-03-equipment-ai.md section 3.4.
  </action>
  <verify>File exists and TypeScript syntax is valid</verify>
  <done>Edge function code complete with Claude API integration</done>
</task>

<task type="auto">
  <name>Task 2: Deploy Edge Function</name>
  <files>supabase/functions/generate-equipment-ai/index.ts</files>
  <action>
Deploy the edge function to Supabase:

1. Ensure supabase CLI is linked to project:
   ```bash
   cd supabase && npx supabase functions list
   ```
   If not linked, link with: `npx supabase link --project-ref qzbmnbinhxzkcwfjnmtb`

2. Deploy the function:
   ```bash
   npx supabase functions deploy generate-equipment-ai --no-verify-jwt
   ```
   Note: --no-verify-jwt allows the function to be called from the browser with anon key.
   The function itself validates the request via Supabase client.

3. Set the ANTHROPIC_API_KEY secret:
   ```bash
   npx supabase secrets set ANTHROPIC_API_KEY=<key>
   ```

   If ANTHROPIC_API_KEY is not available, document in USER-SETUP.md that it needs to be set.

4. Verify deployment:
   ```bash
   npx supabase functions list
   ```
   Should show generate-equipment-ai as deployed.
  </action>
  <verify>`npx supabase functions list` shows generate-equipment-ai deployed</verify>
  <done>Edge function deployed and ready to receive requests</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Edge function file exists at correct path
- [ ] Function deployed to Supabase
- [ ] ANTHROPIC_API_KEY documented as needed (or set if available)
</verification>

<success_criteria>
- All tasks completed
- Edge function deployed to Supabase
- Function ready to be called from frontend (testing in Plan 03-04)
</success_criteria>

<output>
After completion, create `.planning/phases/03-equipment-ai/03-02-SUMMARY.md`

If ANTHROPIC_API_KEY needs user action, also create `.planning/phases/03-equipment-ai/03-USER-SETUP.md`
</output>
